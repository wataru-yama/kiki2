<script>
/**
 * 機材貸出管理システム
 * メインJavaScriptライブラリ
 */

// グローバル変数
let equipmentList = [];
let rentalData = [];
let ganttChart = null;
let currentUser = null;
let locations = [];
let sites = [];
let currentStartDate = null;
let currentEndDate = null;
let materializeInitialized = false;
let fontSizeLevel = 1; // 0: 小, 1: 中, 2: 大
let selectedEquipmentId = null; // 選択された機材ID
// 処理中フラグ
let isRefreshingRentalData = false;

document.addEventListener('DOMContentLoaded', function() {
  // すべてのイベントハンドラーを再設定
  setupAllEventHandlers();
});

// DOMコンテンツ読み込み完了時の処理
document.addEventListener('DOMContentLoaded', function() {
  console.log('メインスクリプト: DOMContentLoaded');
  
  // ロード状態表示用のデバッグ領域を追加
  addDebugContainer();
  
  // Materializeを初期化
  initializeMaterialize();
  
  // 日付の初期設定
  const today = new Date();
  currentStartDate = new Date(today);
  currentEndDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  
  // アプリケーションを初期化
  initializeApp();
  setupEventListeners();
  
  // フォントサイズコントロールを追加
  addFontSizeControls();
  
  // 操作ヒントを初期状態で非表示に
  const touchHint = document.querySelector('.touch-hint');
  if (touchHint) {
    touchHint.style.display = 'none';
  }
});


// すべてのイベントハンドラーを設定する関数
function setupAllEventHandlers() {
  console.log('イベントハンドラーの設定を開始します');
  
  // 貸出保存ボタンのイベントハンドラー設定を確実に行う
  const saveRentalBtn = document.getElementById('save-rental');
  if (saveRentalBtn) {
    console.log('貸出保存ボタンを発見');
    
    // 既存のイベントリスナーを削除（重複登録防止）
    saveRentalBtn.removeEventListener('click', saveRental);
    
    // 新しいイベントリスナーを追加
    saveRentalBtn.addEventListener('click', function(e) {
      e.preventDefault();  // フォーム送信を防止
      console.log('保存ボタンがクリックされました');
      alert('保存ボタンがクリックされました');
      saveRental();  // 貸出保存関数を呼び出し
    });
    
    console.log('貸出保存ボタンのイベントハンドラーを設定しました');
  } else {
    console.error('貸出保存ボタン (#save-rental) が見つかりません');
  }
  
  // その他のイベントハンドラー設定（必要に応じて）
}

/**
 * デバッグコンテナの追加
 */
function addDebugContainer() {
  const debugContainer = document.createElement('div');
  debugContainer.id = 'debug-container';
  debugContainer.className = 'debug-info';
  debugContainer.style.display = 'none'; // 初期状態では非表示
  
  const debugTitle = document.createElement('div');
  debugTitle.className = 'debug-title';
  debugTitle.textContent = 'デバッグ情報';
  
  const debugContent = document.createElement('div');
  debugContent.id = 'debug-content';
  
  const debugToggle = document.createElement('button');
  debugToggle.className = 'btn-small waves-effect waves-light grey';
  debugToggle.textContent = 'デバッグ情報表示/非表示';
  debugToggle.onclick = function() {
    const container = document.getElementById('debug-container');
    if (container.style.display === 'none') {
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
    }
  };
  
  debugContainer.appendChild(debugTitle);
  debugContainer.appendChild(debugContent);
  
  // コンテナの先頭に追加
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.container');
    if (container) {
      container.insertBefore(debugToggle, container.firstChild);
      container.insertBefore(debugContainer, container.firstChild);
    }
  });
}

/**
 * フォントサイズコントロールを追加
 */
function addFontSizeControls() {
  // コントロール要素を作成
  const controlsDiv = document.createElement('div');
  controlsDiv.className = 'font-size-controls';
  
  // ヘルプボタン
  const helpBtn = document.createElement('button');
  helpBtn.className = 'btn-floating btn-small waves-effect waves-light blue-grey lighten-2';
  helpBtn.innerHTML = '<i class="material-icons">help</i>';
  helpBtn.title = '操作ヒントを表示';
  helpBtn.addEventListener('click', function() {
    toggleHelpHint();
  });
  
  // 小さくするボタン
  const decreaseBtn = document.createElement('button');
  decreaseBtn.className = 'btn-floating btn-small waves-effect waves-light blue';
  decreaseBtn.innerHTML = '<i class="material-icons">remove</i>';
  decreaseBtn.title = '文字サイズを小さくする';
  decreaseBtn.addEventListener('click', function() {
    changeFontSize('decrease');
  });
  
  // 大きくするボタン
  const increaseBtn = document.createElement('button');
  increaseBtn.className = 'btn-floating btn-small waves-effect waves-light blue';
  increaseBtn.innerHTML = '<i class="material-icons">add</i>';
  increaseBtn.title = '文字サイズを大きくする';
  increaseBtn.addEventListener('click', function() {
    changeFontSize('increase');
  });
  
  // リセットボタン
  const resetBtn = document.createElement('button');
  resetBtn.className = 'btn-floating btn-small waves-effect waves-light green';
  resetBtn.innerHTML = '<i class="material-icons">refresh</i>';
  resetBtn.title = '文字サイズを標準に戻す';
  resetBtn.addEventListener('click', function() {
    changeFontSize('reset');
  });
  
  // コントロールに追加
  controlsDiv.appendChild(helpBtn);
  controlsDiv.appendChild(decreaseBtn);
  controlsDiv.appendChild(resetBtn);
  controlsDiv.appendChild(increaseBtn);
  
  // ページに追加
  document.querySelector('.container').appendChild(controlsDiv);
  
  // ヘルプボタンの元の位置のボタンを非表示
  const originalHelpBtn = document.getElementById('help-btn');
  if (originalHelpBtn) {
    originalHelpBtn.style.display = 'none';
  }
  
  logDebug('フォントサイズコントロールを追加しました');
}

/**
 * フォントサイズを変更
 */
function changeFontSize(action) {
  // 現在のサイズレベルを更新
  if (action === 'increase' && fontSizeLevel < 2) {
    fontSizeLevel++;
  } else if (action === 'decrease' && fontSizeLevel > 0) {
    fontSizeLevel--;
  } else if (action === 'reset') {
    fontSizeLevel = 1;
  }
  
  // HTMLのルート要素にクラスを設定
  const htmlElement = document.documentElement;
  htmlElement.classList.remove('font-size-small', 'font-size-medium', 'font-size-large');
  
  switch (fontSizeLevel) {
    case 0:
      htmlElement.classList.add('font-size-small');
      break;
    case 1:
      htmlElement.classList.add('font-size-medium');
      break;
    case 2:
      htmlElement.classList.add('font-size-large');
      break;
  }
  
  // カレンダーを再描画
  adjustCalendarHeight();
  
  logDebug(`フォントサイズを変更: レベル=${fontSizeLevel}`);
}

/**
 * Materializeの初期化
 */
function initializeMaterialize() {
  if (materializeInitialized) return;
  
  logDebug('Materializeの初期化を開始');
  
  try {
    // セレクトボックスの初期化
    const selects = document.querySelectorAll('select');
    if (selects.length > 0) {
      logDebug(`セレクトボックスを初期化: ${selects.length}個`);
      M.FormSelect.init(selects);
    }
    
    // モーダルの初期化
    const modals = document.querySelectorAll('.modal');
    if (modals.length > 0) {
      logDebug(`モーダルを初期化: ${modals.length}個`);
      M.Modal.init(modals, {
        dismissible: true,
        opacity: 0.5,
        inDuration: 300,
        outDuration: 200,
        startingTop: '4%',
        endingTop: '10%'
      });
    }
    
    // ツールチップの初期化（もしあれば）
    const tooltips = document.querySelectorAll('.tooltipped');
    if (tooltips.length > 0) {
      M.Tooltip.init(tooltips);
    }
    
    materializeInitialized = true;
    logDebug('Materializeの初期化が完了しました');
  } catch (error) {
    console.error('Materializeの初期化中にエラーが発生しました:', error);
    logDebug('Materialize初期化エラー: ' + error.message);
  }
}

/**
 * イベントリスナーの設定
 */
function setupEventListeners() {
  // ナビゲーションボタン
  const prevBtn = document.getElementById('prev-btn');
  if (prevBtn) {
    prevBtn.addEventListener('click', function() {
      navigateCalendar('prev');
    });
  }
  
  const nextBtn = document.getElementById('next-btn');
  if (nextBtn) {
    nextBtn.addEventListener('click', function() {
      navigateCalendar('next');
    });
  }
  
  const todayBtn = document.getElementById('view-today');
  if (todayBtn) {
    todayBtn.addEventListener('click', function() {
      goToToday();
    });
  }
  
  // マスター管理ボタン
  const manageProjectsBtn = document.getElementById('manage-projects-btn');
  if (manageProjectsBtn) {
    manageProjectsBtn.addEventListener('click', function() {
      loadProjectsList(); // 現場リストをロードしてから表示
      showModal('projects-modal');
    });
  }
  
  const manageEquipmentBtn = document.getElementById('manage-equipment-btn');
  if (manageEquipmentBtn) {
    manageEquipmentBtn.addEventListener('click', function() {
      updateEquipmentTable(); // 機器リストを更新してから表示
      showModal('equipment-modal');
    });
  }
  
  // ヘルプボタンのイベントリスナー
  const helpBtn = document.getElementById('help-btn');
  if (helpBtn) {
    helpBtn.addEventListener('click', function() {
      toggleHelpHint();
    });
  }
  
  // 機材選択ドロップダウンのイベントリスナー
  const equipmentSelector = document.getElementById('equipment-selector');
  if (equipmentSelector) {
    equipmentSelector.addEventListener('change', function() {
      selectedEquipmentId = this.value;
      logDebug(`機材フィルターを変更: ID=${selectedEquipmentId}`);
      renderCalendar(); // カレンダーを再描画
      
      // 選択された機材が表示されるようにスクロール
      if (selectedEquipmentId) {
        scrollToSelectedEquipment();
      }
    });
  }
  
  // モーダル閉じるボタン
  const modalCloseButtons = document.querySelectorAll('.modal-close');
  modalCloseButtons.forEach(button => {
    button.addEventListener('click', function() {
      const modal = this.closest('.modal');
      if (modal) {
        hideModal(modal.id);
      }
    });
  });
  
  // 貸出保存ボタン - 重複登録を防止
  const saveRentalBtn = document.getElementById('save-rental');
  if (saveRentalBtn) {
    // 古いリスナーを削除するためにクローンを作成して置き換え
    const newSaveBtn = saveRentalBtn.cloneNode(true);
    saveRentalBtn.parentNode.replaceChild(newSaveBtn, saveRentalBtn);
    
    // 新しいリスナーを追加
    newSaveBtn.addEventListener('click', function() {
      if (!this.disabled) { // 無効化されていない場合のみ処理
        saveRental();
      }
    });
    
    logDebug('貸出保存ボタンのイベントリスナーを設定しました（重複防止）');
  }
  
  // 返却保存ボタン
  const saveReturnBtn = document.getElementById('save-return');
  if (saveReturnBtn) {
    saveReturnBtn.addEventListener('click', function() {
      returnEquipment();
    });
  }
  
  // ヒントを閉じるボタン
  const hideHintBtn = document.getElementById('hide-hint');
  if (hideHintBtn) {
    hideHintBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const hintBox = document.querySelector('.touch-hint');
      if (hintBox) {
        hintBox.style.display = 'none';
      }
    });
  }
  
  // 現場追加ボタン
  const addProjectBtn = document.getElementById('add-project-btn');
  if (addProjectBtn) {
    addProjectBtn.addEventListener('click', function() {
      addProject();
    });
  }
  
  // 現場削除ボタン
  const deleteProjectsBtn = document.getElementById('delete-projects-btn');
  if (deleteProjectsBtn) {
    deleteProjectsBtn.addEventListener('click', function() {
      deleteSelectedProjects();
    });
  }
  
  // 機器追加ボタン
  const addEquipmentBtn = document.getElementById('add-equipment-btn');
  if (addEquipmentBtn) {
    addEquipmentBtn.addEventListener('click', function() {
      addEquipment();
    });
  }
  
  // 機器削除ボタン
  const deleteEquipmentBtn = document.getElementById('delete-equipment-btn');
  if (deleteEquipmentBtn) {
    deleteEquipmentBtn.addEventListener('click', function() {
      deleteSelectedEquipment();
    });
  }
  
  // スクロール連動の設定
  setupScrollSynchronization();
  
  // リサイズイベントを監視
  window.addEventListener('resize', debounce(function() {
    // カレンダー表示高さの調整
    adjustCalendarHeight();
  }, 250));
  
  logDebug('イベントリスナーが設定されました');
}

/**
 * ヘルプヒントの表示/非表示を切り替え
 */
function toggleHelpHint() {
  const hintBox = document.querySelector('.touch-hint');
  if (hintBox) {
    if (hintBox.style.display === 'none' || !hintBox.style.display) {
      hintBox.style.display = 'block';
    } else {
      hintBox.style.display = 'none';
    }
  }
  
  logDebug('操作ヒント表示を切り替えました');
}

/**
 * 選択された機材までスクロール
 */
function scrollToSelectedEquipment() {
  if (!selectedEquipmentId) return;
  
  const equipmentRow = document.querySelector(`.calendar-row[data-equipment-id="${selectedEquipmentId}"]`);
  const calendarContainer = document.getElementById('calendar-container');
  
  if (equipmentRow && calendarContainer) {
    const rowTop = equipmentRow.offsetTop;
    calendarContainer.scrollTop = rowTop;
    
    logDebug(`選択機材 ID=${selectedEquipmentId} までスクロール`);
  }
}

/**
 * スクロール連動の設定
 */
function setupScrollSynchronization() {
  // 日付ヘッダーとカレンダーのX軸同期
  const dateHeaderContainer = document.getElementById('date-header-container');
  const calendarContainer = document.getElementById('calendar-container');
  
  if (dateHeaderContainer && calendarContainer) {
    // カレンダーがスクロールされたら日付ヘッダーも連動させる
    calendarContainer.addEventListener('scroll', function() {
      dateHeaderContainer.scrollLeft = this.scrollLeft;
    });
    
    // 日付ヘッダーがスクロールされたらカレンダーも連動させる
    dateHeaderContainer.addEventListener('scroll', function() {
      calendarContainer.scrollLeft = this.scrollLeft;
    });
    
    logDebug('日付ヘッダーとカレンダーのスクロール連動を設定しました');
  }
  
  // 機材リストとカレンダーのY軸同期
  const equipmentList = document.getElementById('equipment-list');
  
  if (equipmentList && calendarContainer) {
    // カレンダーが縦スクロールされたら機材リストも連動させる
    calendarContainer.addEventListener('scroll', function() {
      equipmentList.scrollTop = this.scrollTop;
    });
    
    // 機材リストが縦スクロールされたらカレンダーも連動させる
    equipmentList.addEventListener('scroll', function() {
      calendarContainer.scrollTop = this.scrollTop;
    });
    
    logDebug('機材リストとカレンダーのスクロール連動を設定しました');
  }
}

/**
 * アプリケーションの初期化
 */
function initializeApp() {
  logDebug('アプリケーション初期化開始');
  
  // ローディング表示
  showLoadingMessage('データ読み込み中...');
  
  // セーフティタイマー（30秒後に強制的にローディングを消す）
  const safetyTimer = setTimeout(function() {
    hideLoadingMessage();
    logDebug('セーフティタイマーによりローディング表示を終了しました');
  }, 30000);
  
  // 現在のユーザー情報を取得
  google.script.run
    .withSuccessHandler(function(user) {
      handleUserInfo(user);
      checkInitComplete();
    })
    .withFailureHandler(function(error) {
      console.error('ユーザー情報取得エラー:', error);
      logDebug('ユーザー情報取得エラー: ' + (error.message || error));
      handleError(error);
      
      // ダミーユーザー情報を設定
      handleUserInfo({
        email: 'guest@example.com',
        displayName: 'ゲストユーザー',
        role: 'guest'
      });
      
      checkInitComplete();
    })
    .getCurrentUser();
  
  // マスターデータを取得
  google.script.run
    .withSuccessHandler(function(data) {
      handleMasterData(data);
      checkInitComplete();
    })
    .withFailureHandler(function(error) {
      console.error('マスターデータ取得エラー:', error);
      logDebug('マスターデータ取得エラー: ' + (error.message || error));
      handleError(error);
      
      // ダミーデータを設定
      handleMasterData({
        locations: [],
        sites: []
      });
      
      checkInitComplete();
    })
    .getMasterData();
  
  // 機材リストを取得
  google.script.run
    .withSuccessHandler(function(data) {
      handleEquipmentList(data);
      checkInitComplete();
    })
    .withFailureHandler(function(error) {
      console.error('機材リスト取得エラー:', error);
      logDebug('機材リスト取得エラー: ' + (error.message || error));
      handleError(error);
      
      // 空の機材リストで初期化
      handleEquipmentList([]);
      
      checkInitComplete();
    })
    .getEquipmentList();
  
  // 貸出データを取得
google.script.run
  .withSuccessHandler(function(data) {
    if (!data) {
      logDebug('サーバーから空の貸出データが返されました');
      handleRentalData([]);
    } else {
      handleRentalData(data);
    }
    checkInitComplete();
  })
  .withFailureHandler(function(error) {
    console.error('貸出データ取得エラー:', error);
    logDebug('貸出データ取得エラー: ' + (error.message || error));
    handleError(error);
    
    // 空の貸出データで初期化
    handleRentalData([]);
    
    checkInitComplete();
  })
  .getRentalData();
  
  // 初期化完了チェック用変数
  let initStatus = {
    user: false,
    master: false,
    equipment: false,
    rental: false
  };
  
  // 初期化完了をチェックする関数
  function checkInitComplete() {
    // 各データの読み込み状態を更新
    if (currentUser) initStatus.user = true;
    if (locations && sites) initStatus.master = true;
    if (equipmentList !== null) initStatus.equipment = true;
    if (rentalData !== null) initStatus.rental = true;
    
    // すべて読み込み完了したかチェック
    const allLoaded = Object.values(initStatus).every(loaded => loaded);
    
    logDebug(`初期化状態: ユーザー=${initStatus.user}, マスター=${initStatus.master}, 機材=${initStatus.equipment}, 貸出=${initStatus.rental}`);
    
    if (allLoaded) {
      clearTimeout(safetyTimer);
      hideLoadingMessage();
      logDebug('すべてのデータ読み込みが完了しました');
      
      // 機材セレクターの初期化
      updateEquipmentSelector();
      
      // カレンダーを描画
      renderCalendar();
      
      // Materializeの再初期化（動的に生成された要素のため）
      setTimeout(function() {
        try {
          initializeMaterialize();
        } catch (e) {
          console.error('Materializeの再初期化エラー:', e);
          logDebug('Materializeの再初期化エラー: ' + e.message);
        }
      }, 500);
    }
  }
  
  logDebug('アプリケーション初期化完了');
}

/**
 * カレンダー表示の高さを調整
 */
function adjustCalendarHeight() {
  const container = document.querySelector('.gantt-container');
  if (container) {
    const viewportHeight = window.innerHeight;
    const containerRect = container.getBoundingClientRect();
    const topOffset = containerRect.top;
    const bottomMargin = 50; // 下部の余白
    
    const newHeight = viewportHeight - topOffset - bottomMargin;
    container.style.height = `${newHeight}px`;
    
    logDebug(`カレンダー高さを調整: ${newHeight}px`);
  }
}

/**
 * ユーザー情報の処理
 */
function handleUserInfo(user) {
  logDebug('ユーザー情報取得: ' + (user ? user.displayName : 'ユーザー情報なし'));
  
  if (!user) {
    console.error('ユーザー情報がnullです');
    // デフォルトユーザー情報を設定
    currentUser = {
      email: 'guest@example.com',
      displayName: 'ゲストユーザー',
      role: 'guest'
    };
  } else {
    currentUser = user;
  }
  
  const usernameElement = document.getElementById('username');
  if (usernameElement) {
    usernameElement.textContent = currentUser.displayName || 'ゲストユーザー';
  }
  
  // ユーザー情報をグローバルに保持
  window.currentUser = currentUser;
  
  // デバッグ情報表示
  logDebug(`ユーザー情報: ${currentUser.displayName} (${currentUser.email}) [${currentUser.role}]`);
}

/**
 * マスターデータの処理
 */
function handleMasterData(data) {
  logDebug('マスターデータ取得完了');
  // nullチェックを追加
  if (!data) {
    console.error('マスターデータがnullです');
    return;
  }
  
  // 置場と現場のマスターデータを保存
  locations = data.locations || [];
  sites = data.sites || [];
  
  // グローバル変数に保存
  window.locations = locations;
  window.sites = sites;
  
  // 現場のリストをセレクトボックスに反映
  updateProjectSelector();
  
  // 置場のリストを機材登録フォームに反映
  updateLocationSelector();
  
  logDebug('マスターデータ設定完了 - 現場数: ' + sites.length + ', 置場数: ' + locations.length);
}

/**
 * 現場セレクタの更新
 */
function updateProjectSelector() {
  const projectSelect = document.getElementById('rental-project');
  if (projectSelect) {
    projectSelect.innerHTML = '';
    
    // 空のオプションを追加
    const emptySiteOption = document.createElement('option');
    emptySiteOption.value = '';
    emptySiteOption.textContent = '選択してください';
    emptySiteOption.disabled = true;
    emptySiteOption.selected = true;
    projectSelect.appendChild(emptySiteOption);
    
    // 現場の選択肢を追加
    sites.forEach(site => {
      const option = document.createElement('option');
      option.value = site.name;
      option.textContent = site.name;
      projectSelect.appendChild(option);
    });
    
    // Materializeのselect更新
    try {
      if (typeof M !== 'undefined' && M.FormSelect) {
        M.FormSelect.init(projectSelect);
      }
    } catch (e) {
      console.error('現場セレクトの初期化エラー:', e);
      logDebug('現場セレクトの初期化エラー: ' + e.message);
    }
  }
}

/**
 * 置場セレクタの更新
 */
function updateLocationSelector() {
  const locationSelect = document.getElementById('new-equipment-location');
  if (locationSelect) {
    locationSelect.innerHTML = '';
    
    // 空のオプションを追加
    const emptyOption = document.createElement('option');
    emptyOption.value = '';
    emptyOption.textContent = '選択してください';
    locationSelect.appendChild(emptyOption);
    
    // 置場の選択肢を追加
    locations.forEach(location => {
      const option = document.createElement('option');
      option.value = location.name;
      option.textContent = location.name;
      locationSelect.appendChild(option);
    });
    
    // Materializeのselect更新
    try {
      if (typeof M !== 'undefined' && M.FormSelect) {
        M.FormSelect.init(locationSelect);
      }
    } catch (e) {
      console.error('置場セレクトの初期化エラー:', e);
      logDebug('置場セレクトの初期化エラー: ' + e.message);
    }
  }
}

/**
 * 機材リストの処理
 */
function handleEquipmentList(data) {
  // nullチェックを追加
  if (!data) {
    console.error('機材リストがnullです');
    logDebug('機材リストがnullです');
    equipmentList = [];
    return;
  }
  
  logDebug(`機材リスト取得完了: ${data.length}件`);
  equipmentList = data;
  
  // グローバル変数に保持
  window.equipmentList = equipmentList;
  
  // 機材管理テーブルを更新
  updateEquipmentTable();
  
  // デバッグ表示
  if (equipmentList.length > 0) {
    logDebug(`機材の例: ${equipmentList[0].id}, ${equipmentList[0].name}`);
    logDebug(`機材フィールド: ${Object.keys(equipmentList[0]).join(', ')}`);
  }
  
  // 機材セレクターの更新
  updateEquipmentSelector();
  
  logDebug('機材リストを設定しました: ' + equipmentList.length + '件');
}

/**
 * 機材セレクターの更新
 */
function updateEquipmentSelector() {
  // ドロップダウンセレクターがあれば更新
  const selector = document.getElementById('equipment-selector');
  if (selector) {
    selector.innerHTML = '';
    
    // デフォルトオプション（全表示）
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '全ての機材を表示';
    defaultOption.selected = true;
    selector.appendChild(defaultOption);
    
    // 機材オプションを追加
    equipmentList.forEach(equipment => {
      const option = document.createElement('option');
      option.value = equipment.id;
      option.textContent = `${equipment.name} (#${equipment.id})`;
      selector.appendChild(option);
    });
    
    // Materializeのselect更新
    try {
      if (typeof M !== 'undefined' && M.FormSelect) {
        M.FormSelect.init(selector);
      }
    } catch (e) {
      console.error('機材セレクターの初期化エラー:', e);
      logDebug('機材セレクターの初期化エラー: ' + e.message);
    }
  }
}

/**
 * 機材管理テーブルを更新
 */
function updateEquipmentTable() {
  const tableBody = document.getElementById('equipment-list-table');
  if (!tableBody) return;
  
  // テーブルをクリア
  tableBody.innerHTML = '';
  
  // 機材リストがない場合
  if (!equipmentList || equipmentList.length === 0) {
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = '<td colspan="4" class="center-align">機材データがありません</td>';
    tableBody.appendChild(emptyRow);
    return;
  }
  
  // 機材リストを表示
  equipmentList.forEach(equipment => {
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td><input type="checkbox" id="eq-${equipment.id}" class="equipment-checkbox" />
          <label for="eq-${equipment.id}"></label></td>
      <td>${equipment.id}</td>
      <td>${equipment.name}</td>
      <td>${equipment.totalQuantity || 0}</td>
    `;
    
    tableBody.appendChild(row);
  });
  
  logDebug('機材管理テーブルを更新しました: ' + equipmentList.length + '件');
}

/**
 * 現場リストを更新
 */
function loadProjectsList() {
  const projectsList = document.getElementById('projects-list');
  if (!projectsList) return;
  
  // リストをクリア
  projectsList.innerHTML = '';
  
  // 現場リストがない場合
  if (!sites || sites.length === 0) {
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = '<td colspan="2" class="center-align">現場データがありません</td>';
    projectsList.appendChild(emptyRow);
    return;
  }
  
  // 現場リストを表示
  sites.forEach((site, index) => {
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td><input type="checkbox" id="site-${index}" class="site-checkbox" data-site-name="${site.name}" />
          <label for="site-${index}"></label></td>
      <td>${site.name}</td>
    `;
    
    projectsList.appendChild(row);
  });
  
  logDebug('現場リストを更新しました: ' + sites.length + '件');
}

/**
 * 現場追加処理 - フリーズ問題修正版（改良版）
 */
function addProject() {
  const projectNameInput = document.getElementById('new-project-name');
  if (!projectNameInput) return;
  
  const projectName = projectNameInput.value.trim();
  if (!projectName) {
    alert('現場名を入力してください');
    return;
  }
  
  // 既存の現場名と重複チェック
  if (sites.some(site => site.name === projectName)) {
    alert('同じ名前の現場が既に存在します');
    return;
  }
  
  // ボタンの状態を変更して多重送信を防止
  const addButton = document.getElementById('add-project-btn');
  if (addButton) {
    addButton.disabled = true;
    addButton.innerHTML = '<i class="material-icons left">hourglass_empty</i>追加中...';
  }
  
  showLoadingMessage('現場を追加中...');
  
  // タイムアウト設定 (15秒後に強制的にUIを復帰 - 短めに設定)
  const timeout = setTimeout(() => {
    if (addButton) {
      addButton.disabled = false;
      addButton.innerHTML = '<i class="material-icons left">add</i>追加';
    }
    hideLoadingMessage();
    showUpdateMessage('応答がありません。ネットワーク接続を確認してください。', 'error');
    logDebug('現場追加処理がタイムアウトしました');
  }, 15000);
  
  // サーバーに現場追加リクエスト - withUserObject を使用して状態を維持
  google.script.run
    .withUserObject({
      button: addButton,
      input: projectNameInput,
      timeout: timeout
    })
    .withSuccessHandler(function(result, userObject) {
      // タイムアウトをクリア
      clearTimeout(userObject.timeout);
      
      // ボタンを元に戻す
      if (userObject.button) {
        userObject.button.disabled = false;
        userObject.button.innerHTML = '<i class="material-icons left">add</i>追加';
      }
      
      hideLoadingMessage();
      
      if (result && result.success) {
        // 現場リストを更新
        sites.push({ name: result.siteName || projectName });
        
        // 現場セレクタを更新
        updateProjectSelector();
        
        // 現場リストを再表示
        loadProjectsList();
        
        // 入力フィールドをクリア
        userObject.input.value = '';
        
        showSuccessMessage('現場を追加しました');
        logDebug('現場追加成功: ' + (result.siteName || projectName));
      } else {
        handleError(result && result.error ? result.error : '現場の追加に失敗しました');
      }
    })
    .withFailureHandler(function(error, userObject) {
      // タイムアウトをクリア
      clearTimeout(userObject.timeout);
      
      // ボタンを元に戻す
      if (userObject.button) {
        userObject.button.disabled = false;
        userObject.button.innerHTML = '<i class="material-icons left">add</i>追加';
      }
      
      hideLoadingMessage();
      handleError(error);
      logDebug('現場追加エラー: ' + (error.message || error));
    })
    .addSite(projectName);
}

/**
 * 選択された現場の削除（改良版）
 */
function deleteSelectedProjects() {
  const checkboxes = document.querySelectorAll('.site-checkbox:checked');
  if (checkboxes.length === 0) {
    alert('削除する現場を選択してください');
    return;
  }
  
  if (!confirm(`選択された ${checkboxes.length} 件の現場を削除しますか？`)) {
    return;
  }
  
  const siteNames = Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-site-name'));
  
  // ボタンの状態を変更
  const deleteButton = document.getElementById('delete-projects-btn');
  if (deleteButton) {
    deleteButton.disabled = true;
    deleteButton.innerHTML = '<i class="material-icons left">hourglass_empty</i>削除中...';
  }
  
  showLoadingMessage('現場を削除中...');
  
  // タイムアウト設定 (15秒後に強制的にUIを復帰 - 短めに設定)
  const timeout = setTimeout(() => {
    if (deleteButton) {
      deleteButton.disabled = false;
      deleteButton.innerHTML = '<i class="material-icons left">delete</i>選択した現場を削除';
    }
    hideLoadingMessage();
    showUpdateMessage('応答がありません。ネットワーク接続を確認してください。', 'error');
    logDebug('現場削除処理がタイムアウトしました');
  }, 15000);
  
  // サーバーに現場削除リクエスト - withUserObject を使用して状態を維持
  google.script.run
    .withUserObject({
      button: deleteButton,
      timeout: timeout,
      siteNames: siteNames
    })
    .withSuccessHandler(function(result, userObject) {
      // タイムアウトをクリア
      clearTimeout(userObject.timeout);
      
      // ボタンを元に戻す
      if (userObject.button) {
        userObject.button.disabled = false;
        userObject.button.innerHTML = '<i class="material-icons left">delete</i>選択した現場を削除';
      }
      
      hideLoadingMessage();
      
      if (result && result.success) {
        // 現場リストから削除
        userObject.siteNames.forEach(siteName => {
          const index = sites.findIndex(site => site.name === siteName);
          if (index !== -1) {
            sites.splice(index, 1);
          }
        });
        
        // 現場セレクタを更新
        updateProjectSelector();
        
        // 現場リストを再表示
        loadProjectsList();
        
        showSuccessMessage(`${userObject.siteNames.length}件の現場を削除しました`);
        logDebug('現場削除成功: ' + userObject.siteNames.length + '件');
      } else {
        handleError(result && result.error ? result.error : '現場の削除に失敗しました');
      }
    })
    .withFailureHandler(function(error, userObject) {
      // タイムアウトをクリア
      clearTimeout(userObject.timeout);
      
      // ボタンを元に戻す
      if (userObject.button) {
        userObject.button.disabled = false;
        userObject.button.innerHTML = '<i class="material-icons left">delete</i>選択した現場を削除';
      }
      
      hideLoadingMessage();
      handleError(error);
      logDebug('現場削除エラー: ' + (error.message || error));
    })
    .deleteSites(siteNames);
}


/**
 * 機器追加処理
 */
function addEquipment() {
  // 必須フィールドの取得
  const nameInput = document.getElementById('new-equipment-name');
  const quantityInput = document.getElementById('new-equipment-quantity');
  
  if (!nameInput || !quantityInput) return;
  
  const name = nameInput.value.trim();
  const quantity = parseInt(quantityInput.value);
  
  // バリデーション
  if (!name) {
    alert('機器名称を入力してください');
    return;
  }
  
  if (isNaN(quantity) || quantity <= 0) {
    alert('有効な総台数を入力してください');
    return;
  }
  
  // その他のフィールド
  const specification = document.getElementById('new-equipment-spec').value.trim();
  const model = document.getElementById('new-equipment-model').value.trim();
  const manufacturer = document.getElementById('new-equipment-maker').value.trim();
  const serialNumber = document.getElementById('new-equipment-serial').value.trim();
  const alias = document.getElementById('new-equipment-alias').value.trim();
  const location = document.getElementById('new-equipment-location').value;
  const note1 = document.getElementById('new-equipment-note1').value.trim();
  const note2 = document.getElementById('new-equipment-note2').value.trim();
  
  // 機器データの作成
  const equipmentData = {
    name: name,
    totalQuantity: quantity,
    specification: specification,
    model: model,
    manufacturer: manufacturer,
    serialNumber: serialNumber,
    alias: alias,
    location: location,
    note1: note1,
    note2: note2
  };
  
  showLoadingMessage('機器を追加中...');
  
  // サーバーに機器追加リクエスト
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoadingMessage();
      
      if (result && result.success) {
        // 機材リストを再読み込み
        refreshEquipmentList();
        
        // 入力フィールドをクリア
        clearEquipmentForm();
        
        showSuccessMessage('機器を追加しました');
      } else {
        handleError(result.error || '機器の追加に失敗しました');
      }
    })
    .withFailureHandler(function(error) {
      hideLoadingMessage();
      handleError(error);
    })
    .addEquipment(equipmentData);
}

/**
 * 機器フォームをクリア
 */
function clearEquipmentForm() {
  document.getElementById('new-equipment-name').value = '';
  document.getElementById('new-equipment-spec').value = '';
  document.getElementById('new-equipment-model').value = '';
  document.getElementById('new-equipment-maker').value = '';
  document.getElementById('new-equipment-serial').value = '';
  document.getElementById('new-equipment-quantity').value = '';
  document.getElementById('new-equipment-alias').value = '';
  document.getElementById('new-equipment-location').value = '';
  document.getElementById('new-equipment-note1').value = '';
  document.getElementById('new-equipment-note2').value = '';
  
  // ラベルを再アクティブ化
  M.updateTextFields();
}

/**
 * 選択された機器の削除
 */
function deleteSelectedEquipment() {
  const checkboxes = document.querySelectorAll('.equipment-checkbox:checked');
  if (checkboxes.length === 0) {
    alert('削除する機器を選択してください');
    return;
  }
  
  if (!confirm(`選択された ${checkboxes.length} 件の機器を削除しますか？`)) {
    return;
  }
  
  const equipmentIds = Array.from(checkboxes).map(checkbox => {
    const id = checkbox.id.replace('eq-', '');
    return id;
  });
  
  showLoadingMessage('機器を削除中...');
  
  // サーバーに機器削除リクエスト
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoadingMessage();
      
      if (result && result.success) {
        // 機材リストを再読み込み
        refreshEquipmentList();
        
        showSuccessMessage(`${equipmentIds.length}件の機器を削除しました`);
      } else {
        handleError(result.error || '機器の削除に失敗しました');
      }
    })
    .withFailureHandler(function(error) {
      hideLoadingMessage();
      handleError(error);
    })
    .deleteEquipment(equipmentIds);
}

/**
 * 貸出データの処理
 */
function handleRentalData(data) {
  // データがnullや未定義の場合は空配列に設定
  if (!data) {
    console.error('貸出データがnullです');
    logDebug('貸出データがnullです - 空配列を使用します');
    rentalData = [];
  } else {
    // データを正規化
    rentalData = normalizeRentalData(data);
    logDebug(`貸出データ取得完了: ${rentalData.length}件`);
  }

  // グローバル変数に保持
  window.rentalData = rentalData;
  
  // データの詳細を出力
  inspectRentalData();
  
  // テスト用にダミーデータを追加（データがない場合のみ）
  if (rentalData.length === 0) {
    logDebug('データがないため、テスト用データを追加します');
    addTestRentalData();
  }
  
  // カレンダーがすでに描画されていれば更新
  const dateHeaderContainer = document.getElementById('date-header-container');
  if (dateHeaderContainer) {
    // すでに描画済みならレンダリング
    if (dateHeaderContainer.children.length > 0) {
      renderCalendar();
    }
  }
  
  logDebug('貸出データ処理完了: ' + rentalData.length + '件');
}

// テスト用貸出データの追加（問題切り分け用）
function addTestRentalData() {
  const today = new Date();
  
  // 既存の機材があるか確認
  if (!equipmentList || equipmentList.length === 0) {
    logDebug('機材リストがないため、テストデータを追加できません');
    return;
  }
  
  // テスト用のダミーデータ
  const testRental = {
    id: 999,
    equipmentId: equipmentList[0].id,
    equipmentName: equipmentList[0].name,
    startDate: formatDate(today),
    endDate: formatDate(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000)),
    quantity: 1,
    site: 'テスト現場',
    borrower: 'テストユーザー',
    status: 'active'
  };
  
  rentalData.push(testRental);
  logDebug('テスト用貸出データを追加しました: ' + JSON.stringify(testRental));
}

/**
 * カレンダーの描画（貸出バー修正対応版）
 */
function renderCalendar() {
  logDebug('カレンダー描画を開始します');
  
  // 貸出バースタイルを追加
  addRentalBarsStyles();
  
  // カレンダーのコンテナを取得
  const dateHeaderContainer = document.getElementById('date-header-container');
  const equipmentListContainer = document.getElementById('equipment-list');
  const calendarContainer = document.getElementById('calendar-container');
  
  if (!dateHeaderContainer || !equipmentListContainer || !calendarContainer) {
    console.error('カレンダーコンテナが見つかりません');
    logDebug('カレンダーコンテナが見つかりません');
    return;
  }
  
  // コンテナをクリア
  dateHeaderContainer.innerHTML = '';
  equipmentListContainer.innerHTML = '';
  calendarContainer.innerHTML = '';
  
  // 機材リストがない場合は何も表示しない
  if (!equipmentList || equipmentList.length === 0) {
    logDebug('機材リストが空のため、カレンダーを描画しません');
    // メッセージを表示
    const noDataMessage = document.createElement('div');
    noDataMessage.className = 'no-data-message';
    noDataMessage.textContent = '機材データがありません。機器マスター管理から機材を追加してください。';
    calendarContainer.appendChild(noDataMessage);
    return;
  }
  
  // 表示期間の日数を計算 (28日間に設定)
  const days = 28;
  
  logDebug(`カレンダー期間: ${formatDate(currentStartDate)} から ${days}日間`);
  
  // 日付ヘッダーを追加
  for (let i = 0; i < days; i++) {
    const date = new Date(currentStartDate);
    date.setDate(date.getDate() + i);
    
    const dateCell = document.createElement('div');
    dateCell.className = 'date-cell';
    
    // 土日や今日の日付にクラスを追加
    const dayOfWeek = date.getDay();
    if (dayOfWeek === 0) {
      dateCell.classList.add('sunday');
    } else if (dayOfWeek === 6) {
      dateCell.classList.add('saturday');
    }
    
    // 今日の日付を強調
    const today = new Date();
    if (date.getDate() === today.getDate() && 
        date.getMonth() === today.getMonth() && 
        date.getFullYear() === today.getFullYear()) {
      dateCell.classList.add('today');
    }
    
    // 日付表示のフォーマット
    dateCell.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
    dateCell.setAttribute('data-date', formatDate(date));
    
    dateHeaderContainer.appendChild(dateCell);
  }
  
  // 表示する機材のフィルタリング
  let displayEquipmentList = [...equipmentList]; // コピーを作成
  
  // 機材が選択されている場合はフィルタリング
  if (selectedEquipmentId) {
    // 文字列型に統一
    selectedEquipmentId = String(selectedEquipmentId);
    
    // 選択された機材を先頭に持ってくる
    const selectedIndex = displayEquipmentList.findIndex(equipment => String(equipment.id) === selectedEquipmentId);
    if (selectedIndex !== -1) {
      // 選択された機材を配列から取り出す
      const selectedEquipment = displayEquipmentList.splice(selectedIndex, 1)[0];
      // 配列の先頭に追加
      displayEquipmentList.unshift(selectedEquipment);
      
      // フィルタリングモードの場合は、選択された機材のみを表示
      displayEquipmentList = [selectedEquipment];
      
      logDebug(`機材フィルター適用: ${selectedEquipmentId}, 表示件数=${displayEquipmentList.length}`);
    }
  }
  
  // 機材リストとカレンダー行を生成
  displayEquipmentList.forEach(equipment => {
    // 機材IDを文字列化して属性に設定
    const equipmentIdStr = String(equipment.id);
    
    // 機材情報を左側のリストに追加
    const equipmentItem = document.createElement('div');
    equipmentItem.className = 'equipment-item';
    equipmentItem.setAttribute('data-equipment-id', equipmentIdStr);
    
    // 機材の詳細情報を表示 (コンパクトな表示に変更)
    equipmentItem.innerHTML = `
      <div class="equipment-name">${equipment.name} (${equipment.totalQuantity || 0} ${equipment.alias || '台'})</div>
      <div class="compact-equipment-info">
        ${equipment.specification || ''} ${equipment.model || ''} ${equipment.note1 || ''} ${equipment.note2 || ''}
      </div>
    `;
    
    // 機材情報のクリックイベント（将来的な拡張用）
    equipmentItem.addEventListener('click', function() {
      // 将来的に機材情報の詳細表示などに利用
    });
    
    equipmentListContainer.appendChild(equipmentItem);
    
    // カレンダー行を作成
    const calendarRow = document.createElement('div');
    calendarRow.className = 'calendar-row';
    calendarRow.setAttribute('data-equipment-id', equipmentIdStr);
    
    // 日付分のセルを生成
    for (let i = 0; i < days; i++) {
      const date = new Date(currentStartDate);
      date.setDate(date.getDate() + i);
      
      const dayCell = document.createElement('div');
      dayCell.className = 'calendar-day';
      dayCell.setAttribute('data-date', formatDate(date));
      dayCell.setAttribute('data-equipment-id', equipmentIdStr);
      
      // 土日や今日の日付にクラスを追加
      const dayOfWeek = date.getDay();
      if (dayOfWeek === 0) {
        dayCell.classList.add('sunday');
      } else if (dayOfWeek === 6) {
        dayCell.classList.add('saturday');
      }
      
      // 今日の日付を強調
      const today = new Date();
      if (date.getDate() === today.getDate() && 
          date.getMonth() === today.getMonth() && 
          date.getFullYear() === today.getFullYear()) {
        dayCell.classList.add('today');
      }
      
      calendarRow.appendChild(dayCell);
    }
    
    calendarContainer.appendChild(calendarRow);
  });
  
  // 貸出バーを描画
  renderRentalBars();
  
  // ドラッグ選択機能を設定
  setupDragSelection();
  
  // カレンダーの高さを調整
  adjustCalendarHeight();
  
  logDebug('カレンダー描画完了');
}

/**
 * 貸出バーを描画
 */
function renderRentalBars() {
  logDebug(`貸出バー描画開始: ${rentalData.length}件のデータから`);
  
  // すべての貸出バーを一旦削除
  const existingBars = document.querySelectorAll('.rental-bar');
  existingBars.forEach(bar => bar.remove());
  
  // アクティブな貸出データを抽出（ステータスチェックを緩和）
  const activeRentals = rentalData.filter(rental => 
    rental.status === 'active' || 
    rental.status === '貸出中' || 
    !rental.status || 
    rental.status === ''
  );
  
  logDebug(`アクティブな貸出: ${activeRentals.length}件`);
  
  if (activeRentals.length === 0) {
    logDebug('表示する貸出データがありません');
    return;
  }
  
  // 貸出バーを描画
  activeRentals.forEach(rental => {
    try {
      // まずequipmentIdを文字列に統一
      const equipmentId = String(rental.equipmentId);
      logDebug(`貸出バー処理: ID=${rental.id}, 機材=${equipmentId}, 期間=${rental.startDate}～${rental.endDate}`);
      
      // 選択機材フィルターが適用されていて、選択されていない機材の場合はスキップ
      if (selectedEquipmentId && String(selectedEquipmentId) !== equipmentId) {
        logDebug(`フィルター対象外のためスキップ: ${equipmentId}`);
        return;
      }
      
      const startDate = new Date(rental.startDate);
      const endDate = new Date(rental.endDate);
      
      // 有効な日付かチェック
      if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
        logDebug(`無効な日付形式: 開始=${rental.startDate}, 終了=${rental.endDate}`);
        return;
      }
      
      // 該当する機材の行を検索
      const calendarRow = document.querySelector(`.calendar-row[data-equipment-id="${equipmentId}"]`);
      if (!calendarRow) {
        logDebug(`機材ID: ${equipmentId}の行が見つかりません。現在表示されている機材ID: ${Array.from(document.querySelectorAll('.calendar-row')).map(row => row.getAttribute('data-equipment-id')).join(', ')}`);
        return;
      }
      
      // 開始日の表示位置計算
      const calendarStart = new Date(currentStartDate);
      const daysDiff = Math.floor((startDate - calendarStart) / (86400 * 1000));
      
      logDebug(`日数差: ${daysDiff}日, カレンダー開始=${formatDate(calendarStart)}, 貸出開始=${formatDate(startDate)}`);
      
      // 表示範囲外の場合はスキップ
      if (daysDiff > 28 || daysDiff + Math.ceil((endDate - startDate) / (86400 * 1000)) < 0) {
        logDebug(`表示範囲外: ${daysDiff}日`);
        return;
      }
      
      // 表示位置の調整
      const visibleStartDay = Math.max(0, daysDiff);
      const durationDays = Math.ceil((endDate - startDate) / (86400 * 1000)) + 1;
      const visibleDurationDays = Math.min(durationDays, 28 - visibleStartDay);
      
      if (visibleDurationDays <= 0) {
        logDebug(`表示可能な期間がありません: ${visibleDurationDays}日`);
        return;
      }
      
      // 貸出バーの作成
      const rentalBar = document.createElement('div');
      rentalBar.className = 'rental-bar';
      rentalBar.setAttribute('data-rental-id', rental.id);
      rentalBar.setAttribute('data-equipment-id', equipmentId);
      rentalBar.setAttribute('data-start-date', formatDate(startDate));
      rentalBar.setAttribute('data-end-date', formatDate(endDate));
      
      // テストデータには特別なクラスを追加
      if (isTestRental(rental)) {
        rentalBar.classList.add('test-rental-bar');
      }
      
      // バーの位置とサイズを設定
      const cellWidth = 80; // セルの幅
      rentalBar.style.left = `${visibleStartDay * cellWidth}px`;
      rentalBar.style.width = `${visibleDurationDays * cellWidth - 4}px`;
      
      // 貸出情報を表示
      rentalBar.innerHTML = `
        <div class="rental-title">${rental.site || 'サイト未設定'} - ${rental.quantity || 1}台</div>
        <div class="rental-detail">${rental.borrower || '借用者未設定'}</div>
        <div class="rental-actions">
          <i class="material-icons rental-action-icon edit-rental">edit</i>
          <i class="material-icons rental-action-icon return-rental">undo</i>
        </div>
      `;
      
      // 貸出バーをカレンダー行に追加
      calendarRow.appendChild(rentalBar);
      logDebug(`貸出バー追加成功: ID=${rental.id}, 位置=${visibleStartDay * cellWidth}px, 幅=${visibleDurationDays * cellWidth - 4}px`);
      
      // ドラッグ機能の設定
      makeRentalBarDraggable(rentalBar);
      
      // リサイズ機能の設定
      addResizeHandlers(rentalBar);
      
    } catch (error) {
      console.error(`貸出バー描画エラー: ID=${rental.id}`, error);
      logDebug(`貸出バー描画エラー: ID=${rental.id}, ${error.message}, スタック: ${error.stack}`);
    }
  });
  
  logDebug('貸出バーの描画が完了しました');
}

/**
 * ドラッグ選択機能の設定
 */
function setupDragSelection() {
  const calendarContainer = document.getElementById('calendar-container');
  if (!calendarContainer) return;
  
  let isDragging = false;
  let startCell = null;
  let endCell = null;
  let dragEquipmentId = null;
  
  // マウスダウンイベント
  calendarContainer.addEventListener('mousedown', function(e) {
    // 日付セルのみを対象とする
    const cell = e.target.closest('.calendar-day');
    if (!cell) return;
    
    e.preventDefault();
    isDragging = true;
    startCell = cell;
    dragEquipmentId = cell.getAttribute('data-equipment-id');
    
    // ハイライト初期化
    resetHighlight();
    highlightCell(cell);
    
    logDebug(`ドラッグ開始: 機材ID=${dragEquipmentId}, 日付=${cell.getAttribute('data-date')}`);
  });
  
  // マウス移動イベント
  calendarContainer.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    
    const cell = e.target.closest('.calendar-day');
    if (!cell) return;
    
    // 同じ機材行のセルのみ対象とする
    const cellEquipmentId = cell.getAttribute('data-equipment-id');
    if (cellEquipmentId !== dragEquipmentId) return;
    
    endCell = cell;
    updateHighlight();
  });
  
  // マウスアップイベント
  document.addEventListener('mouseup', function(e) {
    if (!isDragging) return;
    
    isDragging = false;
    
    // ドラッグ選択が有効な場合、モーダルを表示
    if (startCell && endCell) {
      const startDate = startCell.getAttribute('data-date');
      const endDate = endCell.getAttribute('data-date');
      
      // 開始日と終了日を調整（開始日が終了日より後の場合は入れ替え）
      const adjustedStartDate = new Date(startDate) < new Date(endDate) ? startDate : endDate;
      const adjustedEndDate = new Date(startDate) < new Date(endDate) ? endDate : startDate;
      
      // 機材情報を取得
      const equipment = equipmentList.find(eq => eq.id === dragEquipmentId);
      if (equipment) {
        logDebug(`ドラッグ選択完了: ${equipment.name}, 期間=${adjustedStartDate}~${adjustedEndDate}`);
        
        // 貸出モーダルを表示
        showRentalModal(equipment, adjustedStartDate, adjustedEndDate);
      }
    }
    
    resetHighlight();
    startCell = null;
    endCell = null;
    dragEquipmentId = null;
  });
  
  // タッチイベント対応
  calendarContainer.addEventListener('touchstart', function(e) {
    const touch = e.touches[0];
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    if (!element) return;
    
    const cell = element.closest('.calendar-day');
    if (!cell) return;
    
    e.preventDefault();
    isDragging = true;
    startCell = cell;
    dragEquipmentId = cell.getAttribute('data-equipment-id');
    
    resetHighlight();
    highlightCell(cell);
    
    logDebug(`タッチドラッグ開始: 機材ID=${dragEquipmentId}, 日付=${cell.getAttribute('data-date')}`);
  });
  
  calendarContainer.addEventListener('touchmove', function(e) {
    if (!isDragging) return;
    
    const touch = e.touches[0];
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    if (!element) return;
    
    const cell = element.closest('.calendar-day');
    if (!cell) return;
    
    const cellEquipmentId = cell.getAttribute('data-equipment-id');
    if (cellEquipmentId !== dragEquipmentId) return;
    
    endCell = cell;
    updateHighlight();
  });
  
  calendarContainer.addEventListener('touchend', function(e) {
    if (!isDragging) return;
    
    isDragging = false;
    
    if (startCell && endCell) {
      const startDate = startCell.getAttribute('data-date');
      const endDate = endCell.getAttribute('data-date');
      
      // 開始日と終了日を調整（開始日が終了日より後の場合は入れ替え）
      const adjustedStartDate = new Date(startDate) < new Date(endDate) ? startDate : endDate;
      const adjustedEndDate = new Date(startDate) < new Date(endDate) ? endDate : startDate;
      
      // 機材情報を取得
      const equipment = equipmentList.find(eq => eq.id === dragEquipmentId);
      if (equipment) {
        logDebug(`タッチドラッグ選択完了: ${equipment.name}, 期間=${adjustedStartDate}~${adjustedEndDate}`);
        
        // 貸出モーダルを表示
        showRentalModal(equipment, adjustedStartDate, adjustedEndDate);
      }
    }
    
    resetHighlight();
    startCell = null;
    endCell = null;
    dragEquipmentId = null;
  });
  
  // ハイライトをリセット
  function resetHighlight() {
    const highlightedCells = document.querySelectorAll('.calendar-day.drag-highlight');
    highlightedCells.forEach(cell => {
      cell.classList.remove('drag-highlight');
    });
  }
  
  // セルをハイライト
  function highlightCell(cell) {
    if (cell) {
      cell.classList.add('drag-highlight');
    }
  }
  
  // ハイライトの更新
  function updateHighlight() {
    resetHighlight();
    
    if (!startCell || !endCell) return;
    
    // 開始日と終了日の取得
    const startDate = new Date(startCell.getAttribute('data-date'));
    const endDate = new Date(endCell.getAttribute('data-date'));
    
    // 開始日と終了日の調整（開始日が終了日より後の場合は入れ替え）
    const minDate = startDate < endDate ? startDate : endDate;
    const maxDate = startDate < endDate ? endDate : startDate;
    
    // 該当する機材行のすべてのセル
    const row = startCell.parentElement;
    const cells = row.querySelectorAll('.calendar-day');
    
    // 日付範囲内のセルをハイライト
    cells.forEach(cell => {
      const cellDate = new Date(cell.getAttribute('data-date'));
      if (cellDate >= minDate && cellDate <= maxDate) {
        highlightCell(cell);
      }
    });
  }
}

/**
 * 貸出バーをドラッグ可能にする
 */
function makeRentalBarDraggable(bar) {
  let isDragging = false;
  let startX, startLeft;
  let originalStartDate, originalEndDate;
  let cellWidth = 80; // カレンダーセルの幅
  
  // マウスイベント
  bar.addEventListener('mousedown', startDrag);
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', endDrag);
  
  // タッチイベント（モバイル対応）
  bar.addEventListener('touchstart', function(e) {
    const touch = e.touches[0];
    startDrag({ clientX: touch.clientX, preventDefault: () => e.preventDefault(), target: e.target });
  });
  
  document.addEventListener('touchmove', function(e) {
    if (!isDragging) return;
    const touch = e.touches[0];
    drag({ clientX: touch.clientX, preventDefault: () => e.preventDefault() });
  });
  
  document.addEventListener('touchend', endDrag);
  
  function startDrag(e) {
    // リサイズハンドルやアクションアイコンがクリックされた場合はドラッグを開始しない
    if (e.target.classList.contains('resize-handle') || 
        e.target.classList.contains('rental-action-icon')) {
      return;
    }
    
    e.preventDefault();
    isDragging = true;
    startX = e.clientX;
    startLeft = parseInt(bar.style.left) || 0;
    
    // 元の日付を保存
    originalStartDate = bar.getAttribute('data-start-date');
    originalEndDate = bar.getAttribute('data-end-date');
    
    bar.classList.add('dragging');
  }
  
  function drag(e) {
    if (!isDragging) return;
    e.preventDefault();
    
    const deltaX = e.clientX - startX;
    const newLeft = startLeft + deltaX;
    
    // 左端のバウンダリーチェック
    if (newLeft < 0) return;
    
    // グリッドにスナップするように調整
    const cellOffset = Math.round(newLeft / cellWidth);
    const snappedLeft = cellOffset * cellWidth;
    
    bar.style.left = `${snappedLeft}px`;
    
    // 新しい日付を計算
    const startDateObj = new Date(originalStartDate);
    const endDateObj = new Date(originalEndDate);
    const duration = Math.round((endDateObj - startDateObj) / (86400 * 1000));
    
    const newStartDate = new Date(currentStartDate);
    newStartDate.setDate(currentStartDate.getDate() + cellOffset);
    
    const newEndDate = new Date(newStartDate);
    newEndDate.setDate(newStartDate.getDate() + duration);
    
    // 日付属性を更新
    bar.setAttribute('data-start-date', formatDate(newStartDate));
    bar.setAttribute('data-end-date', formatDate(newEndDate));
  }
  
  function endDrag() {
    if (!isDragging) return;
    isDragging = false;
    
    bar.classList.remove('dragging');
    
    // サーバーに日付変更を保存
    const rentalId = bar.getAttribute('data-rental-id');
    const newStartDate = bar.getAttribute('data-start-date');
    const newEndDate = bar.getAttribute('data-end-date');
    
    if (rentalId && newStartDate && newEndDate && 
        (newStartDate !== originalStartDate || newEndDate !== originalEndDate)) {
      updateRentalPeriod(parseInt(rentalId), newStartDate, newEndDate);
    }
  }
}

/**
 * 貸出バーをリサイズ可能にする
 */
function makeRentalBarResizable(bar, leftHandle, rightHandle) {
  let isResizing = false;
  let startX, startWidth, startLeft;
  let resizeType; // 'left' or 'right'
  let cellWidth = 80; // カレンダーセルの幅
  let originalStartDate, originalEndDate;
  
  // 左ハンドルのリサイズ機能
  leftHandle.addEventListener('mousedown', function(e) {
    startResizing(e, 'left');
  });
  
  leftHandle.addEventListener('touchstart', function(e) {
    const touch = e.touches[0];
    startResizing({ clientX: touch.clientX, preventDefault: () => e.preventDefault() }, 'left');
  });
  
  // 右ハンドルのリサイズ機能
  rightHandle.addEventListener('mousedown', function(e) {
    startResizing(e, 'right');
  });
  
  rightHandle.addEventListener('touchstart', function(e) {
    const touch = e.touches[0];
    startResizing({ clientX: touch.clientX, preventDefault: () => e.preventDefault() }, 'right');
  });
  
  document.addEventListener('mousemove', resize);
  document.addEventListener('touchmove', function(e) {
    if (!isResizing) return;
    const touch = e.touches[0];
    resize({ clientX: touch.clientX, preventDefault: () => e.preventDefault() });
  });
  
  document.addEventListener('mouseup', endResize);
  document.addEventListener('touchend', endResize);
  
  function startResizing(e, type) {
    e.preventDefault();
    e.stopPropagation();
    isResizing = true;
    resizeType = type;
    startX = e.clientX;
    startWidth = parseInt(bar.offsetWidth);
    startLeft = parseInt(bar.style.left) || 0;
    
    // 元の日付を保存
    originalStartDate = bar.getAttribute('data-start-date');
    originalEndDate = bar.getAttribute('data-end-date');
    
    bar.classList.add('resizing');
  }
  
  function resize(e) {
    if (!isResizing) return;
    e.preventDefault();
    
    const deltaX = e.clientX - startX;
    
    if (resizeType === 'right') {
      // 右側のリサイズ
      let newWidth = startWidth + deltaX;
      
      // 最小幅を確保
      if (newWidth < cellWidth) {
        newWidth = cellWidth;
      }
      
      // グリッドにスナップするように調整
      const cellCount = Math.round(newWidth / cellWidth);
      const snappedWidth = cellCount * cellWidth - 10; // マージン調整
      
      bar.style.width = `${snappedWidth}px`;
      
      // 新しい終了日を計算
      const startDateObj = new Date(originalStartDate);
      const newEndDate = new Date(startDateObj);
      newEndDate.setDate(startDateObj.getDate() + cellCount - 1);
      
      // 日付属性を更新
      bar.setAttribute('data-end-date', formatDate(newEndDate));
      
    } else if (resizeType === 'left') {
      // 左側のリサイズ
      let newLeft = startLeft + deltaX;
      let newWidth = startWidth - deltaX;
      
      // 左端のバウンダリーチェック
      if (newLeft < 0) {
        newLeft = 0;
        newWidth = startWidth + startLeft;
      }
      
      // 最小幅を確保
      if (newWidth < cellWidth) {
        newWidth = cellWidth;
        newLeft = startLeft + startWidth - cellWidth;
      }
      
      // グリッドにスナップするように調整
      const cellLeftOffset = Math.round(newLeft / cellWidth);
      const snappedLeft = cellLeftOffset * cellWidth;
      
      const cellWidthOffset = Math.round(newWidth / cellWidth);
      const snappedWidth = cellWidthOffset * cellWidth - 10; // マージン調整
      
      bar.style.left = `${snappedLeft}px`;
      bar.style.width = `${snappedWidth}px`;
      
      // 新しい開始日を計算
      const newStartDate = new Date(currentStartDate);
      newStartDate.setDate(currentStartDate.getDate() + cellLeftOffset);
      
      // 日付属性を更新
      bar.setAttribute('data-start-date', formatDate(newStartDate));
    }
  }
  
  function endResize() {
    if (!isResizing) return;
    isResizing = false;
    
    bar.classList.remove('resizing');
    
    // サーバーに日付変更を保存
    const rentalId = bar.getAttribute('data-rental-id');
    const newStartDate = bar.getAttribute('data-start-date');
    const newEndDate = bar.getAttribute('data-end-date');
    
    if (rentalId && newStartDate && newEndDate && 
        (newStartDate !== originalStartDate || newEndDate !== originalEndDate)) {
      updateRentalPeriod(parseInt(rentalId), newStartDate, newEndDate);
    }
  }
}

/**
 * 貸出期間の更新
 */
function updateRentalPeriod(rentalId, startDate, endDate) {
  // テストデータの場合は実際の保存はスキップ
  if (rentalId === 999) {
    logDebug(`テストデータの期間更新: ID=${rentalId}, 開始=${startDate}, 終了=${endDate}`);
    showSuccessMessage('テストデータの期間を更新しました（サーバーには保存されません）');
    
    // テストデータのローカル更新
    const rental = rentalData.find(r => r.id === rentalId);
    if (rental) {
      rental.startDate = startDate;
      rental.endDate = endDate;
      renderCalendar(); // カレンダーを再描画
    }
    return;
  }
  
  // 保存中メッセージ表示
  showLoadingMessage('期間更新中...');
  
  logDebug(`貸出期間更新: ID=${rentalId}, 開始=${startDate}, 終了=${endDate}`);
  
  // サーバーに送信する前にIDを整数に変換
  const numericId = parseInt(rentalId, 10);
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoadingMessage();
      
      if (result && result.success) {
        showSuccessMessage('貸出期間を更新しました');
        // ローカルデータも更新
        const rental = rentalData.find(r => r.id === numericId);
        if (rental) {
          rental.startDate = startDate;
          rental.endDate = endDate;
        }
        renderCalendar();
      } else {
        const errorMessage = result && result.error ? result.error : '不明なエラー';
        handleError(errorMessage);
        renderCalendar(); // 元の状態に戻す
      }
    })
    .withFailureHandler(function(error) {
      hideLoadingMessage();
      handleError(error);
      renderCalendar(); // 元の状態に戻す
    })
    .updateRentalPeriod(numericId, startDate, endDate);
}

/**
 * 貸出モーダルの表示
 */
function showRentalModal(equipment, startDate, endDate) {
  if (!equipment) {
    console.error('機材データがnullです');
    logDebug('機材データがnullです');
    return;
  }
  
  logDebug(`貸出モーダルを表示: 機材ID=${equipment.id}, 機材名=${equipment.name}`);
  
  // モーダル内の値をリセット
  document.getElementById('rental-equipment').value = `${equipment.name} (#${equipment.id})`;
  
  // 日付の設定
  if (startDate && endDate) {
    document.getElementById('rental-start').value = startDate;
    document.getElementById('rental-end').value = endDate;
    logDebug(`選択された期間を設定: ${startDate} ~ ${endDate}`);
  } else {
    // デフォルト値として今日の日付と1週間後を設定
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(today.getDate() + 7);
    
    document.getElementById('rental-start').value = formatDate(today);
    document.getElementById('rental-end').value = formatDate(nextWeek);
    logDebug(`デフォルト期間を設定: ${formatDate(today)} ~ ${formatDate(nextWeek)}`);
  }
  
  // その他の値をクリア
  document.getElementById('rental-project').value = '';
  document.getElementById('rental-quantity').value = '1';
  document.getElementById('new-project').value = '';
  
  // 数量の最大値を設定
  const quantityInput = document.getElementById('rental-quantity');
  if (quantityInput) {
    quantityInput.max = equipment.totalQuantity || 1;
    logDebug(`数量の最大値を設定: ${equipment.totalQuantity || 1}`);
  }
  
  // モーダル表示
  const modal = document.getElementById('rental-modal');
  modal.setAttribute('data-equipment-id', equipment.id);
  modal.removeAttribute('data-rental-id'); // 新規モードでは貸出IDを削除
  
  logDebug('貸出モーダルを表示します');
  showModal('rental-modal');
  
  // Materializeフォーム更新
  setTimeout(function() {
    M.updateTextFields();
    const selectElements = document.querySelectorAll('select');
    M.FormSelect.init(selectElements);
    
    logDebug(`フォーム更新完了: select要素=${selectElements.length}個`);
  }, 100);
}

/**
 * 貸出編集モーダルの表示
 */
function showEditRentalModal(rental) {
  if (!rental) {
    console.error('貸出データがnullです');
    logDebug('貸出データがnullです');
    return;
  }
  
  // モーダル内の値を設定
  document.getElementById('rental-equipment').value = `${rental.equipmentName} (#${rental.equipmentId})`;
  document.getElementById('rental-start').value = rental.startDate;
  document.getElementById('rental-end').value = rental.endDate;
  document.getElementById('rental-project').value = rental.site;
  document.getElementById('rental-quantity').value = rental.quantity;
  document.getElementById('new-project').value = '';
  
  // モーダル表示
  const modal = document.getElementById('rental-modal');
  modal.setAttribute('data-rental-id', rental.id);
  modal.setAttribute('data-equipment-id', rental.equipmentId);
  showModal('rental-modal');
  
  // 返却ボタンの表示
  const footer = modal.querySelector('.modal-footer');
  
  // 返却ボタンが既に存在する場合は削除
  const existingReturnBtn = document.getElementById('return-btn');
  if (existingReturnBtn) {
    footer.removeChild(existingReturnBtn);
  }
  
  // 返却ボタンを追加
  const returnBtn = document.createElement('button');
  returnBtn.id = 'return-btn';
  returnBtn.className = 'waves-effect waves-light btn orange';
  returnBtn.innerHTML = '<i class="material-icons left">replay</i>返却';
  returnBtn.addEventListener('click', function() {
    hideModal('rental-modal');
    showReturnModal(rental);
  });
  
  footer.insertBefore(returnBtn, document.querySelector('#rental-modal .modal-close'));
  
  logDebug(`貸出編集モーダルを表示: ID=${rental.id}, 機材=${rental.equipmentName}`);
  
  // Materializeフォーム更新
  setTimeout(function() {
    M.updateTextFields();
    const selectElements = document.querySelectorAll('select');
    M.FormSelect.init(selectElements);
  }, 100);
}

/**
 * 返却モーダルの表示
 */
function showReturnModal(rental) {
  if (!rental) {
    console.error('貸出データがnullです');
    logDebug('貸出データがnullです');
    return;
  }
  
  // モーダル内の値を設定
  document.getElementById('return-equipment').value = `${rental.equipmentName} (#${rental.equipmentId})`;
  document.getElementById('return-date').value = formatDate(new Date());
  
  // 返却数量の選択肢を設定
  const quantitySelect = document.getElementById('return-quantity');
  if (quantitySelect) {
    quantitySelect.innerHTML = '';
    
    // 貸出数量分の選択肢を作成
    for (let i = 1; i <= rental.quantity; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `${i}台`;
      quantitySelect.appendChild(option);
    }
    
    // デフォルトで全数量を返却
    quantitySelect.value = rental.quantity;
    
    // Materializeのselect更新
    try {
      if (typeof M !== 'undefined' && M.FormSelect) {
        M.FormSelect.init(quantitySelect);
      }
    } catch (e) {
      console.error('返却数量セレクトの初期化エラー:', e);
      logDebug('返却数量セレクトの初期化エラー: ' + e.message);
    }
  }
  
  // モーダル表示
  const modal = document.getElementById('return-modal');
  modal.setAttribute('data-rental-id', rental.id);
  showModal('return-modal');
  
  logDebug(`返却モーダルを表示: ID=${rental.id}, 機材=${rental.equipmentName}`);
  
  // Materializeフォーム更新
  setTimeout(function() {
    M.updateTextFields();
  }, 100);
}

/**
 * モーダルの表示
 */
function showModal(modalId) {
  const modal = document.getElementById(modalId);
  if (!modal) return;
  
  try {
    // Materialize CSSのモーダル機能を使用
    if (typeof M !== 'undefined' && M.Modal) {
      const modalInstance = M.Modal.getInstance(modal);
      if (modalInstance) {
        modalInstance.open();
      } else {
        const newInstance = M.Modal.init(modal, {
          dismissible: true,
          opacity: 0.5,
          inDuration: 300,
          outDuration: 200,
          startingTop: '4%',
          endingTop: '10%'
        });
        newInstance.open();
      }
      
      logDebug(`モーダルインスタンスを開く: ${modalId}`);
    } else {
      // フォールバック：CSSで表示
      modal.style.display = 'block';
      modal.classList.add('open');
      
      logDebug(`フォールバックでモーダルを表示: ${modalId}`);
    }
  } catch (e) {
    console.error(`モーダル表示エラー(${modalId}):`, e);
    logDebug(`モーダル表示エラー(${modalId}): ${e.message}`);
    
    // 最終フォールバック
    try {
      modal.style.display = 'block';
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.opacity = '0.5';
      overlay.style.display = 'block';
      document.body.appendChild(overlay);
      
      logDebug(`緊急フォールバックでモーダルを表示: ${modalId}`);
    } catch (err) {
      console.error('緊急モーダル表示エラー:', err);
    }
  }
}

/**
 * モーダルの非表示
 */
function hideModal(modalId) {
  const modal = document.getElementById(modalId);
  if (!modal) return;
  
  try {
    if (typeof M !== 'undefined' && M.Modal) {
      const instance = M.Modal.getInstance(modal);
      if (instance) {
        instance.close();
      }
    } else {
      // フォールバック：CSSで非表示
      modal.style.display = 'none';
      modal.classList.remove('open');
      
      // オーバーレイを削除
      const overlays = document.querySelectorAll('.modal-overlay');
      overlays.forEach(overlay => {
        overlay.remove();
      });
    }
    
    logDebug(`モーダルを非表示: ${modalId}`);
  } catch (e) {
    console.error(`モーダル非表示エラー(${modalId}):`, e);
    logDebug(`モーダル非表示エラー(${modalId}): ${e.message}`);
    
    // 最終フォールバック
    modal.style.display = 'none';
    
    // オーバーレイを削除
    const overlays = document.querySelectorAll('.modal-overlay');
    overlays.forEach(overlay => {
      overlay.remove();
    });
  }
}

/**
 * 貸出データの保存
 */
function saveRental() {
  try {
    // 保存ボタンを無効化して多重送信を防止
    const saveButton = document.getElementById('save-rental');
    if (saveButton) {
      if (saveButton.disabled) {
        logDebug('保存ボタンは既に無効化されています');
        return; // 既に処理中なら終了
      }
      saveButton.disabled = true;
      saveButton.innerHTML = '<i class="material-icons left">hourglass_empty</i>保存中...';
      logDebug('保存ボタンを無効化しました');
    }
    
    const modal = document.getElementById('rental-modal');
    const equipmentId = modal.getAttribute('data-equipment-id');
    const rentalId = modal.getAttribute('data-rental-id');
    
    // バリデーション
    const startDate = document.getElementById('rental-start').value;
    const endDate = document.getElementById('rental-end').value;
    let site = document.getElementById('rental-project').value;
    const newProject = document.getElementById('new-project').value;
    const quantity = parseInt(document.getElementById('rental-quantity').value);
    
    // 新しい現場名が入力されている場合はそちらを優先
    if (newProject) {
      site = newProject;
    }
    
    if (!startDate || !endDate || !site || isNaN(quantity) || quantity <= 0) {
      alert('すべての必須項目を入力してください。');
      if (saveButton) {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="material-icons left">save</i>保存';
      }
      return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
      alert('開始日は終了日より前の日付を選択してください。');
      if (saveButton) {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="material-icons left">save</i>保存';
      }
      return;
    }
    
    // 対応する機材を検索
    const equipment = equipmentList.find(eq => eq.id === equipmentId);
    if (!equipment) {
      console.error('機材が見つかりません:', equipmentId);
      logDebug('機材が見つかりません: ' + equipmentId);
      alert('選択された機材の情報が見つかりません。ページを再読み込みしてください。');
      if (saveButton) {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="material-icons left">save</i>保存';
      }
      return;
    }
    
    // 保存中メッセージ表示
    showLoadingMessage('保存中...');
    
    // 処理タイムアウトの設定 (30秒)
    const timeout = setTimeout(() => {
      if (saveButton) {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="material-icons left">save</i>保存';
      }
      hideLoadingMessage();
      showUpdateMessage('応答がありません。ネットワーク接続を確認してください。', 'error');
      logDebug('貸出保存処理がタイムアウトしました');
    }, 30000);
    
    // 既存の貸出データの編集の場合
    if (rentalId) {
      // 貸出データを更新
      const rentalData = {
        id: rentalId,
        equipmentId: equipmentId,
        equipmentName: equipment.name,
        startDate: startDate,
        endDate: endDate,
        quantity: quantity,
        site: site,
        borrower: currentUser.displayName
      };
      
      logDebug('貸出データを更新: ' + JSON.stringify(rentalData));
      
      google.script.run
        .withUserObject({
          button: saveButton,
          timeout: timeout
        })
        .withSuccessHandler(function(result, userObject) {
          clearTimeout(userObject.timeout);
          if (userObject.button) {
            userObject.button.disabled = false;
            userObject.button.innerHTML = '<i class="material-icons left">save</i>保存';
          }
          hideLoadingMessage();
          showSuccessMessage('貸出情報を更新しました');
          hideModal('rental-modal');
          refreshRentalData();
        })
        .withFailureHandler(function(error, userObject) {
          clearTimeout(userObject.timeout);
          if (userObject.button) {
            userObject.button.disabled = false;
            userObject.button.innerHTML = '<i class="material-icons left">save</i>保存';
          }
          hideLoadingMessage();
          handleError(error);
        })
        .updateRental(rentalData);
    } else {
      // 新規貸出データ
      const rentalData = {
        equipmentId: equipmentId,
        equipmentName: equipment.name,
        startDate: startDate,
        endDate: endDate,
        quantity: quantity,
        site: site,
        borrower: currentUser.displayName
      };
      
      logDebug('新規貸出データを保存: ' + JSON.stringify(rentalData));
      
      google.script.run
        .withUserObject({
          button: saveButton,
          timeout: timeout
        })
        .withSuccessHandler(function(result, userObject) {
          clearTimeout(userObject.timeout);
          if (userObject.button) {
            userObject.button.disabled = false;
            userObject.button.innerHTML = '<i class="material-icons left">save</i>保存';
          }
          hideLoadingMessage();
          showSuccessMessage('貸出を登録しました');
          hideModal('rental-modal');
          
          // 新しい現場を追加した場合はマスターデータを更新
          if (newProject && !sites.some(site => site.name === newProject)) {
            sites.push({ name: newProject });
            updateProjectSelector();
          }
          
          refreshRentalData();
        })
        .withFailureHandler(function(error, userObject) {
          clearTimeout(userObject.timeout);
          if (userObject.button) {
            userObject.button.disabled = false;
            userObject.button.innerHTML = '<i class="material-icons left">save</i>保存';
          }
          hideLoadingMessage();
          handleError(error);
        })
        .saveRental(rentalData);
    }
  } catch (error) {
    const saveButton = document.getElementById('save-rental');
    if (saveButton) {
      saveButton.disabled = false;
      saveButton.innerHTML = '<i class="material-icons left">save</i>保存';
    }
    hideLoadingMessage();
    console.error('貸出保存処理エラー:', error);
    logDebug('貸出保存処理エラー: ' + error.message);
    alert(`貸出保存中にエラーが発生しました: ${error.message || error}`);
  }
}

/**
 * 機材返却処理
 */
function returnEquipment() {
  const modal = document.getElementById('return-modal');
  const rentalId = modal.getAttribute('data-rental-id');
  const returnDate = document.getElementById('return-date').value;
  const returnQuantity = parseInt(document.getElementById('return-quantity').value);
  
  if (!returnDate) {
    alert('返却日を選択してください。');
    return;
  }
  
  if (!returnQuantity || returnQuantity <= 0) {
    alert('返却台数を選択してください。');
    return;
  }
  
  // 保存中メッセージ表示
  showLoadingMessage('返却処理中...');
  
  logDebug(`機材返却: ID=${rentalId}, 返却日=${returnDate}, 数量=${returnQuantity}`);
  
  google.script.run
    .withSuccessHandler(function() {
      hideLoadingMessage();
      showSuccessMessage('機材を返却しました');
      hideModal('return-modal');
      refreshRentalData();
    })
    .withFailureHandler(function(error) {
      hideLoadingMessage();
      handleError(error);
    })
    .returnEquipment(rentalId, returnDate, returnQuantity);
}

/**
 * ローディングメッセージの表示
 */
function showLoadingMessage(message) {
  const loadingElement = document.getElementById('loading');
  if (loadingElement) {
    const messageElement = document.createElement('div');
    messageElement.className = 'loading-message';
    messageElement.textContent = message;
    
    // 既存のメッセージがあれば削除
    const existingMessage = loadingElement.querySelector('.loading-message');
    if (existingMessage) {
      loadingElement.removeChild(existingMessage);
    }
    
    loadingElement.appendChild(messageElement);
    loadingElement.classList.remove('hidden');
    
    logDebug(`ローディング表示: ${message}`);
  }
}

/**
 * ローディングメッセージの非表示
 */
function hideLoadingMessage() {
  const loadingElement = document.getElementById('loading');
  if (loadingElement) {
    loadingElement.classList.add('hidden');
    const messageElement = loadingElement.querySelector('.loading-message');
    if (messageElement) {
      loadingElement.removeChild(messageElement);
    }
    
    logDebug('ローディング表示を非表示');
  }
}

/**
 * 成功メッセージの表示
 */
function showSuccessMessage(message) {
  try {
    // Materialize CSSのトースト機能を使用
    if (typeof M !== 'undefined' && M.toast) {
      M.toast({html: message, classes: 'green', displayLength: 3000});
    } else {
      // フォールバック：アラート
      alert(message);
    }
    
    logDebug(`成功メッセージ: ${message}`);
  } catch (e) {
    console.error('トースト表示エラー:', e);
    logDebug('トースト表示エラー: ' + e.message);
    // 最終フォールバック
    alert(message);
  }
}

/**
 * エラーハンドリング
 */
function handleError(error) {
  console.error('エラーが発生しました:', error);
  logDebug('エラー: ' + (error.message || error));
  
  try {
    // Materialize CSSのトースト機能を使用
    if (typeof M !== 'undefined' && M.toast) {
      M.toast({html: `エラー: ${error.message || error}`, classes: 'red', displayLength: 4000});
    } else {
      // フォールバック：アラート
      alert(`エラー: ${error.message || error}`);
    }
  } catch (e) {
    console.error('エラートースト表示エラー:', e);
    logDebug('エラートースト表示エラー: ' + e.message);
    // 最終フォールバック
    alert(`エラー: ${error.message || error}`);
  }
}

/**
 * 貸出データの再取得
 */
function refreshRentalData() {
  // 既に処理中なら実行しない
  if (isRefreshingRentalData) {
    logDebug('貸出データの取得処理が既に実行中です');
    return;
  }
  
  isRefreshingRentalData = true;
  showLoadingMessage('データ更新中...');
  
  // タイムアウト設定
  const timeout = setTimeout(() => {
    isRefreshingRentalData = false;
    hideLoadingMessage();
    showUpdateMessage('データ取得がタイムアウトしました', 'error');
    logDebug('貸出データ取得がタイムアウトしました');
  }, 30000);
  
  google.script.run
    .withUserObject({
      timeout: timeout
    })
    .withSuccessHandler(function(data, userObject) {
      clearTimeout(userObject.timeout);
      isRefreshingRentalData = false;
      handleRentalData(data);
      hideLoadingMessage();
      logDebug(`サーバーから貸出データを ${data ? data.length : 0}件 取得しました`);
    })
    .withFailureHandler(function(error, userObject) {
      clearTimeout(userObject.timeout);
      isRefreshingRentalData = false;
      handleError(error);
      hideLoadingMessage();
    })
    .getRentalData();
}

/**
 * 機材リストの再取得
 */
function refreshEquipmentList() {
  showLoadingMessage('機材リスト更新中...');
  
  google.script.run
    .withSuccessHandler(function(data) {
      handleEquipmentList(data);
      hideLoadingMessage();
    })
    .withFailureHandler(function(error) {
      handleError(error);
      hideLoadingMessage();
    })
    .getEquipmentList();
}

/**
 * カレンダーのナビゲーション処理
 */
function navigateCalendar(direction) {
  // カレンダーのナビゲーションを1週間単位に変更（制限なし）
  const dayDiff = direction === 'prev' ? -7 : 7;
  
  // 新しい開始日を計算
  const newStartDate = new Date(currentStartDate);
  newStartDate.setDate(newStartDate.getDate() + dayDiff);
  
  // 日付を更新
  currentStartDate = newStartDate;
  
  // カレンダーを再描画
  renderCalendar();
  
  logDebug(`カレンダーをナビゲート: ${direction}, 新開始日: ${formatDate(currentStartDate)}`);
}

/**
 * 今日の日付に移動
 */
function goToToday() {
  // 今日の日付を左端に表示
  const today = new Date();
  currentStartDate = today;
  
  // カレンダーを再描画
  renderCalendar();
  
  // 水平スクロールを左端に戻す
  const dateHeaderContainer = document.getElementById('date-header-container');
  const calendarContainer = document.getElementById('calendar-container');
  
  if (dateHeaderContainer) {
    dateHeaderContainer.scrollLeft = 0;
  }
  
  if (calendarContainer) {
    calendarContainer.scrollLeft = 0;
  }
  
  logDebug(`今日の日付に移動: ${formatDate(today)}`);
}

/**
 * 日付フォーマット (YYYY-MM-DD)
 */
function formatDate(date) {
  if (!date) return '';
  
  const d = new Date(date);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

/**
 * デバウンス関数
 */
function debounce(func, wait) {
  let timeout;
  return function() {
    const context = this;
    const args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(function() {
      func.apply(context, args);
    }, wait);
  };
}
/**
 * 現場リストを更新
 */
function loadProjectsList() {
  const projectsList = document.getElementById('projects-list');
  if (!projectsList) return;
  
  // リストをクリア
  projectsList.innerHTML = '';
  
  // ロード中表示
  projectsList.innerHTML = '<tr><td colspan="2" class="center-align">現場データを読み込み中...</td></tr>';
  
  // 現場リストがない場合
  if (!sites || sites.length === 0) {
    projectsList.innerHTML = '<tr><td colspan="2" class="center-align">現場データがありません</td></tr>';
    return;
  }
  
  // 現場リストを表示
  projectsList.innerHTML = '';
  sites.forEach((site, index) => {
    const row = document.createElement('tr');
    
    // チェックボックスの実装を修正
    row.innerHTML = `
      <td class="center-align">
        <label>
          <input type="checkbox" class="site-checkbox" id="site-checkbox-${index}" data-site-name="${site.name}" />
          <span></span>
        </label>
      </td>
      <td>${site.name}</td>
    `;
    
    projectsList.appendChild(row);
  });
  
  logDebug('現場リストを更新しました: ' + sites.length + '件');
}

/**
 * 現場追加処理 - フリーズ問題修正版
 */
function addProject() {
  const projectNameInput = document.getElementById('new-project-name');
  if (!projectNameInput) return;
  
  const projectName = projectNameInput.value.trim();
  if (!projectName) {
    alert('現場名を入力してください');
    return;
  }
  
  // 既存の現場名と重複チェック
  if (sites.some(site => site.name === projectName)) {
    alert('同じ名前の現場が既に存在します');
    return;
  }
  
  // ボタンの状態を変更して多重送信を防止
  const addButton = document.getElementById('add-project-btn');
  if (addButton) {
    addButton.disabled = true;
    addButton.innerHTML = '<i class="material-icons left">hourglass_empty</i>追加中...';
  }
  
  showLoadingMessage('現場を追加中...');
  
  // タイムアウト設定 (30秒後に強制的にUIを復帰)
  const timeout = setTimeout(() => {
    if (addButton) {
      addButton.disabled = false;
      addButton.innerHTML = '<i class="material-icons left">add</i>追加';
    }
    hideLoadingMessage();
    showUpdateMessage('応答がありません。ネットワーク接続を確認してください。', 'error');
    logDebug('現場追加処理がタイムアウトしました');
  }, 30000);
  
  // サーバーに現場追加リクエスト
  google.script.run
    .withSuccessHandler(function(result) {
      // タイムアウトをクリア
      clearTimeout(timeout);
      
      // ボタンを元に戻す
      if (addButton) {
        addButton.disabled = false;
        addButton.innerHTML = '<i class="material-icons left">add</i>追加';
      }
      
      hideLoadingMessage();
      
      if (result && result.success) {
        // 現場リストを更新
        sites.push({ name: projectName });
        
        // 現場セレクタを更新
        updateProjectSelector();
        
        // 現場リストを再表示
        loadProjectsList();
        
        // 入力フィールドをクリア
        projectNameInput.value = '';
        
        showSuccessMessage('現場を追加しました');
      } else {
        handleError(result && result.error ? result.error : '現場の追加に失敗しました');
      }
    })
    .withFailureHandler(function(error) {
      // タイムアウトをクリア
      clearTimeout(timeout);
      
      // ボタンを元に戻す
      if (addButton) {
        addButton.disabled = false;
        addButton.innerHTML = '<i class="material-icons left">add</i>追加';
      }
      
      hideLoadingMessage();
      handleError(error);
    })
    .addSite(projectName);
}

/**
 * 選択された現場の削除
 */
function deleteSelectedProjects() {
  const checkboxes = document.querySelectorAll('.site-checkbox:checked');
  if (checkboxes.length === 0) {
    alert('削除する現場を選択してください');
    return;
  }
  
  if (!confirm(`選択された ${checkboxes.length} 件の現場を削除しますか？`)) {
    return;
  }
  
  const siteNames = Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-site-name'));
  
  // ボタンの状態を変更
  const deleteButton = document.getElementById('delete-projects-btn');
  if (deleteButton) {
    deleteButton.disabled = true;
    deleteButton.innerHTML = '<i class="material-icons left">hourglass_empty</i>削除中...';
  }
  
  showLoadingMessage('現場を削除中...');
  
  // タイムアウト設定
  const timeout = setTimeout(() => {
    if (deleteButton) {
      deleteButton.disabled = false;
      deleteButton.innerHTML = '<i class="material-icons left">delete</i>選択した現場を削除';
    }
    hideLoadingMessage();
    showUpdateMessage('応答がありません。ネットワーク接続を確認してください。', 'error');
    logDebug('現場削除処理がタイムアウトしました');
  }, 30000);
  
  // サーバーに現場削除リクエスト
  google.script.run
    .withSuccessHandler(function(result) {
      // タイムアウトをクリア
      clearTimeout(timeout);
      
      // ボタンを元に戻す
      if (deleteButton) {
        deleteButton.disabled = false;
        deleteButton.innerHTML = '<i class="material-icons left">delete</i>選択した現場を削除';
      }
      
      hideLoadingMessage();
      
      if (result && result.success) {
        // 現場リストから削除
        siteNames.forEach(siteName => {
          const index = sites.findIndex(site => site.name === siteName);
          if (index !== -1) {
            sites.splice(index, 1);
          }
        });
        
        // 現場セレクタを更新
        updateProjectSelector();
        
        // 現場リストを再表示
        loadProjectsList();
        
        showSuccessMessage(`${siteNames.length}件の現場を削除しました`);
      } else {
        handleError(result && result.error ? result.error : '現場の削除に失敗しました');
      }
    })
    .withFailureHandler(function(error) {
      // タイムアウトをクリア
      clearTimeout(timeout);
      
      // ボタンを元に戻す
      if (deleteButton) {
        deleteButton.disabled = false;
        deleteButton.innerHTML = '<i class="material-icons left">delete</i>選択した現場を削除';
      }
      
      hideLoadingMessage();
      handleError(error);
    })
    .deleteSites(siteNames);
}

/**
 * 更新メッセージの表示
 */
function showUpdateMessage(message, type = 'info') {
  // 既存のメッセージがあれば削除
  const existingMsg = document.getElementById('update-message');
  if (existingMsg) {
    existingMsg.remove();
  }
  
  // メッセージ要素を作成
  const messageDiv = document.createElement('div');
  messageDiv.id = 'update-message';
  messageDiv.textContent = message;
  
  // タイプに応じたスタイル
  if (type === 'error') {
    messageDiv.style.backgroundColor = 'rgba(244, 67, 54, 0.8)'; // 赤
  } else if (type === 'success') {
    messageDiv.style.backgroundColor = 'rgba(76, 175, 80, 0.8)'; // 緑
  } else {
    messageDiv.style.backgroundColor = 'rgba(33, 150, 243, 0.8)'; // 青
  }
  
  // 共通スタイル
  messageDiv.style.color = 'white';
  messageDiv.style.padding = '10px 15px';
  messageDiv.style.borderRadius = '4px';
  messageDiv.style.position = 'fixed';
  messageDiv.style.top = '50%';
  messageDiv.style.left = '50%';
  messageDiv.style.transform = 'translate(-50%, -50%)';
  messageDiv.style.zIndex = '9999';
  messageDiv.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';
  
  // ドキュメントに追加
  document.body.appendChild(messageDiv);
  
  // 自動的に消える
  setTimeout(() => {
    if (messageDiv.parentNode) {
      messageDiv.remove();
    }
  }, 5000);
}

/**
 * デバッグ用のサンプル貸出データを生成
 */
function generateSampleRentals() {
  // 現在表示中の機材IDを取得
  const visibleEquipmentIds = Array.from(
    document.querySelectorAll('.calendar-row[data-equipment-id]')
  ).map(row => row.getAttribute('data-equipment-id'));
  
  // 表示開始日を基準に日付を設定
  const today = new Date(currentStartDate);
  
  // サンプルデータを生成
  const samples = [];
  
  visibleEquipmentIds.forEach((equipmentId, index) => {
    // 各機材に1〜2件のサンプル貸出を作成
    const count = Math.floor(Math.random() * 2) + 1;
    
    for (let i = 0; i < count; i++) {
      // ランダムな開始日（表示範囲内）
      const startOffset = Math.floor(Math.random() * 14);
      const startDate = new Date(today);
      startDate.setDate(today.getDate() + startOffset);
      
      // ランダムな期間（3〜10日）
      const duration = Math.floor(Math.random() * 7) + 3;
      const endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + duration);
      
      // サンプル貸出先
      const sites = ['鈴研(管理者)', 'GLP(管理者)', '第一倉庫', '本社'];
      const site = sites[Math.floor(Math.random() * sites.length)];
      
      // サンプルデータ
      samples.push({
        id: `sample_${index}_${i}`,
        equipmentId: equipmentId,
        equipmentName: document.querySelector(`.equipment-item[data-equipment-id="${equipmentId}"] .equipment-name`)?.textContent || `機材 #${equipmentId}`,
        startDate: formatDate(startDate),
        endDate: formatDate(endDate),
        quantity: Math.floor(Math.random() * 3) + 1,
        site: site,
        borrower: '鈴木 一郎',
        status: 'active'
      });
    }
  });
  
  console.log('サンプル貸出データを生成:', samples.length, '件');
  return samples;
}

// javascript.htmlのlogDebug関数を確認し、存在しなければ追加
function logDebug(message) {
  console.log(message);
  const debugContent = document.getElementById('debug-content');
  if (debugContent) {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.textContent = `[${timestamp}] ${message}`;
    debugContent.appendChild(logEntry);
    
    // スクロールを最下部に
    debugContent.scrollTop = debugContent.scrollHeight;
  }
}
// ステータスを日本語表示に変換する関数
function formatRentalStatus(status) {
  switch(status) {
    case 'active':
      return '貸出中';
    case 'returned':
      return '返却済み';
    default:
      return status || '不明';
  }
}
function addRentalBarsStyles() {
  // 既存のスタイルタグがあれば削除
  const existingStyle = document.getElementById('rental-bar-styles');
  if (existingStyle) {
    existingStyle.remove();
  }
  
  // 新しいスタイルタグを作成
  const style = document.createElement('style');
  style.id = 'rental-bar-styles';
  style.textContent = `
    .rental-bar {
      position: absolute;
      height: 20px;
      background-color: #FF9800;
      color: white;
      border-radius: 3px;
      padding: 1px 8px;
      font-size: 0.8rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 5;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      user-select: none;
      top: 5px;
      opacity: 0.9;
    }
    
    /* テストデータは色を変えて区別 */
    .test-rental-bar {
      background-color: #9C27B0;
      border: 1px dashed white;
    }
    
    .rental-bar:hover {
      opacity: 1;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
      height: 22px;
      margin-top: -1px;
      z-index: 6;
    }
    
    .rental-title {
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .rental-detail {
      font-size: 0.7rem;
      opacity: 0.9;
    }
    
    .rental-actions {
      position: absolute;
      right: 5px;
      top: 1px;
      display: none;
    }
    
    .rental-bar:hover .rental-actions {
      display: block;
    }
    
    .rental-action-icon {
      cursor: pointer;
      margin-left: 3px;
      font-size: 1rem;
    }
    
    .calendar-day {
      position: relative;
    }
  `;
  
  document.head.appendChild(style);
  logDebug('貸出バースタイルを追加しました');
}

// データをデバッグ出力する機能を追加
function inspectRentalData() {
  logDebug("===== 貸出データ詳細検証 =====");
  
  if (!rentalData || rentalData.length === 0) {
    logDebug("貸出データが空です");
    return;
  }
  
  logDebug(`貸出データ総数: ${rentalData.length}件`);
  
  // データ形式を調査
  const sample = rentalData[0];
  logDebug(`サンプルデータ: ${JSON.stringify(sample)}`);
  logDebug(`データフィールド: ${Object.keys(sample).join(', ')}`);
  
  // 主要フィールドの値を確認
  rentalData.forEach((rental, index) => {
    if (index < 5) { // 最初の5件だけ表示
      logDebug(`項目 #${index}: ID=${rental.id}, 機材=${rental.equipmentId}, 状態=${rental.status}, ` +
        `開始=${rental.startDate}, 終了=${rental.endDate}` +
        `${isTestRental(rental) ? ' [テストデータ]' : ''}`);
    }
  });
  
  // ステータス別の集計
  const statusCounts = {};
  rentalData.forEach(rental => {
    const status = rental.status || '未設定';
    statusCounts[status] = (statusCounts[status] || 0) + 1;
  });
  logDebug(`ステータス別集計: ${JSON.stringify(statusCounts)}`);
  
  logDebug("===== 検証終了 =====");
}

// テストデータかどうかを判定する関数
function isTestRental(rental) {
  return rental.id === 999 || rental.site === 'テスト現場';
}

// サーバーデータのプロパティ名をチェックし修正する
function normalizeRentalData(data) {
  if (!data || !Array.isArray(data)) return [];
  
  return data.map(rental => {
    // IDがstringなら数値に変換
    if (typeof rental.id === 'string') {
      rental.id = parseInt(rental.id, 10);
    }
    
    // 日付形式の正規化
    if (rental.startDate) {
      try {
        const date = new Date(rental.startDate);
        if (!isNaN(date.getTime())) {
          rental.startDate = formatDate(date);
        }
      } catch (e) {
        logDebug(`開始日の変換エラー: ${rental.startDate}`);
      }
    }
    
    if (rental.endDate) {
      try {
        const date = new Date(rental.endDate);
        if (!isNaN(date.getTime())) {
          rental.endDate = formatDate(date);
        }
      } catch (e) {
        logDebug(`終了日の変換エラー: ${rental.endDate}`);
      }
    }
    
    // ステータスがない場合は「active」とみなす
    if (!rental.status) {
      rental.status = 'active';
    }
    
    return rental;
  });
}
</script>