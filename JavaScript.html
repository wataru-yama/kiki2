<script>
// グローバル変数
  let userEmail = 'guest@example.com'; // デフォルト値を事前設定
  let userName = 'ゲスト';  // デフォルト値を事前設定
  let equipmentList = [];
  let rentalData = [];
  let locationsList = [];
  let projectsList = []; // 現場リスト（新規追加）
  let currentView = 'twoweeks'; // 14日表示をデフォルトに変更
  let selectedEquipment = '';
  let undoStack = [];
  let startDate = new Date();
  startDate.setHours(0, 0, 0, 0);
  // グローバル変数に追加
  let isDraggingBar = false;
  let isResizingBar = false;
  let dragBarStartX = 0;
  let dragBarStartWidth = 0;
  let dragBarElement = null;
  let dragBarData = null;
  let dragBarOriginalPosition = null;
  let dragBarMode = null; // 'move', 'resize-start', 'resize-end'
  let currentDropTarget = null;
  let selectedLocation = '';
  let selectedEquipmentWithLocation = '';
  let initialDataLoaded = false; // 貸出データを取得する前に初期設定が完了しているかの変数
  // スクロールフラグを追加
  let skipScrollToSelectedEquipment = false;
  // スクロール位置保存用
  let savedScrollPosition = {
    top: 0,
    left: 0
  };
  
  // ドラッグ操作用変数
  let isDragging = false;
  let dragStartCell = null;
  // 設定変数
  let userSettings = {
    showConfirmDialog: true, // デフォルトは表示する
    cellWidth: 80          // PCでのセル幅
  };
  // 最後に削除された機器の復元用
  let lastDeletedEquipment = null;

  // DOM読み込み完了時のイベントリスナー
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded イベント発火');
    
    // ユーザー名を「読み込み中...」に設定
    const usernameElement = document.getElementById('username');
    if (usernameElement) {
      usernameElement.textContent = '読み込み中...';
    }
    
    // モーダル初期化
    initializeModals();
    
    // 初期スタイル追加
    addCustomStyles();
    
    // カレンダードラッグ移動設定
    setupCalendarDrag();
    
    // PC版のボタン修正
    setupManagementButtons();
    
    // PC版フォントサイズスライダー追加
    setupPCFontSizeSlider();
    
    // カレンダーナビゲーションボタン追加
    setupCalendarNavigation();
    
    // ユーザー認証チェック（最初に実行）
    checkAuthentication();
    
    // イベントリスナーを設定した後に日付ピッカーも設定
	  setTimeout(() => {
	    setupDatePickers();
	  }, 500);
  });

  function setupCalendarDrag() {
	  // 要素を取得
	  const containerSelector = '.gantt-container';
	  const headerSelectors = [
	    '.gantt-header', 
	    '.gantt-date', 
	    '.gantt-header-wrapper',
	    '#date-headers'
	  ];
	  
	  // マウスイベント用ハンドラ
	  function handleMouseDrag(e) {
	    // ヘッダー部分をクリックした場合のみ処理
	    let isHeaderElement = false;
	    for (const selector of headerSelectors) {
	      if (e.target.closest(selector)) {
	        isHeaderElement = true;
	        break;
	      }
	    }
	    if (!isHeaderElement) return;
	    
	    // コンテナを取得
	    const container = document.querySelector(containerSelector);
	    if (!container) return;
	    
	    // ドラッグ開始位置とスクロール位置を保存
	    const startX = e.clientX;
	    const startScrollLeft = container.scrollLeft;
	    let isDragging = true;
	    
	    // ドラッグ中のスタイル
	    document.body.style.cursor = 'grabbing';
	    e.target.closest(headerSelectors.join(',')).classList.add('dragging');
	    
	    // マウス移動ハンドラ
	    function onMouseMove(moveEvent) {
	      if (!isDragging) return;
	      moveEvent.preventDefault();
	      
	      // 移動距離からスクロール量を計算
	      const dx = moveEvent.clientX - startX;
	      // スクロール位置を更新 (マウスと逆方向にスクロール)
	      container.scrollLeft = startScrollLeft - dx;
	    }
	    
	    // マウスアップハンドラ
	    function onMouseUp() {
	      isDragging = false;
	      document.body.style.cursor = '';
	      
	      // ドラッグ中のスタイルを削除
	      const dragElement = document.querySelector(headerSelectors.join(',') + '.dragging');
	      if (dragElement) {
	        dragElement.classList.remove('dragging');
	      }
	      
	      // イベントリスナーを削除
	      document.removeEventListener('mousemove', onMouseMove);
	      document.removeEventListener('mouseup', onMouseUp);
	    }
	    
	    // イベントリスナーを追加
	    document.addEventListener('mousemove', onMouseMove);
	    document.addEventListener('mouseup', onMouseUp);
	  }
	  
	  // イベントリスナーを設定
	  document.addEventListener('mousedown', handleMouseDrag);
	  
	  // 日付ヘッダーのドラッグスタイルを追加
	  const styleElement = document.createElement('style');
	  styleElement.textContent = `
	    .gantt-header.dragging,
	    .gantt-date.dragging,
	    .gantt-header-wrapper.dragging,
	    #date-headers.dragging {
	      cursor: grabbing !important;
	      user-select: none;
	    }
	    
	    .gantt-date:hover {
	      cursor: grab;
	      background-color: rgba(38, 166, 154, 0.1);
	    }
	  `;
	  document.head.appendChild(styleElement);
	}
  
  // モーダル初期化の修正
	function initializeModals() {
	  try {
	    const modalElems = document.querySelectorAll('.modal');
	    const modalOptions = {
	      dismissible: true,
	      opacity: 0.5,
	      inDuration: 300,
	      outDuration: 200,
	      preventScrolling: true,
	      startingTop: '10%',
	      endingTop: '10%'
	    };
	    
	    M.Modal.init(modalElems, modalOptions);
	    console.log('モーダル初期化完了');

	  } catch (error) {
	    console.error('モーダル初期化エラー:', error);
	  }
	}

  // カスタムスタイル追加
  function addCustomStyles() {
    try {
      // ハイライト用スタイル
      const style = document.createElement('style');
      style.textContent = `
        .drag-highlight {
          background-color: rgba(38, 166, 154, 0.3) !important;
        }
        .selected-equipment {
          background-color: #e3f2fd;
        }
      `;
      document.head.appendChild(style);
      console.log('カスタムスタイル追加完了');
    } catch (error) {
      console.error('スタイル追加エラー:', error);
    }
  }

  // ユーザー認証状態をチェックする関数
  function checkAuthentication() {
    console.log('認証チェック開始');
    showLoading();
    
    google.script.run
      .withSuccessHandler(function(userInfo) {
        console.log('認証チェック結果:', userInfo);
        
        if (userInfo && userInfo.authenticated) {
          if (userInfo.isRegistered) {
            // 認証済み＆登録済みユーザー
            userEmail = userInfo.email;
            userName = userInfo.name;
            
            const usernameElement = document.getElementById('username');
            if (usernameElement) {
              usernameElement.textContent = userName;
            }
            
            // データ取得を開始
            setupEventListeners();
            loadUserSettings();
            fetchAllData();
          } else {
            // 認証済みだが未登録ユーザー
            showUnregisteredUserMessage(userInfo.email);
          }
        } else {
          // 未認証の場合はログイン画面へリダイレクト
          redirectToLogin();
        }
        
        hideLoading();
      })
      .withFailureHandler(function(error) {
        console.error('認証チェックエラー:', error);
        showAuthenticationError(error);
        hideLoading();
      })
      .getUserInfo();
  }

  // 未登録ユーザーのメッセージを表示
  function showUnregisteredUserMessage(email) {
    // 画面をクリア
    document.body.innerHTML = `
      <div style="max-width: 600px; margin: 100px auto; padding: 20px; text-align: center; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <h2 style="color: #d32f2f;">アクセス権限がありません</h2>
        <p>このシステムの利用が許可されていません。</p>
        <p>ログインメールアドレス: <strong>${email || 'unknown'}</strong></p>
        <p style="margin-top: 30px;">システム管理者に連絡して、アクセス権限を申請してください。</p>
        <button onclick="window.location.reload();" style="margin-top: 20px; padding: 10px 20px; background-color: #26a69a; color: white; border: none; border-radius: 4px; cursor: pointer;">再試行</button>
      </div>
    `;
  }

  // 認証エラーを表示
  function showAuthenticationError(error) {
    // 画面をクリア
    document.body.innerHTML = `
      <div style="max-width: 600px; margin: 100px auto; padding: 20px; text-align: center; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <h2 style="color: #d32f2f;">認証エラー</h2>
        <p>ログイン処理中にエラーが発生しました。</p>
        <p style="color: #666; font-size: 0.9em;">${error || 'Unknown error'}</p>
        <p style="margin-top: 30px;">ページを再読み込みして再試行してください。</p>
        <button onclick="window.location.reload();" style="margin-top: 20px; padding: 10px 20px; background-color: #26a69a; color: white; border: none; border-radius: 4px; cursor: pointer;">再試行</button>
      </div>
    `;
  }

  // ログイン画面へリダイレクト
  function redirectToLogin() {
    // スクリプトURLを取得
    google.script.run
      .withSuccessHandler(function(url) {
        if (url) {
          // 5秒後にリダイレクト
          document.body.innerHTML = `
            <div style="max-width: 600px; margin: 100px auto; padding: 20px; text-align: center; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
              <h2>ログインが必要です</h2>
              <p>このシステムを使用するにはGoogleアカウントでのログインが必要です。</p>
              <p style="margin-top: 20px;">5秒後にログイン画面に移動します...</p>
              <div style="margin: 20px 0; background-color: #f5f5f5; border-radius: 4px; padding: 10px;">
                <div style="width: 100%; height: 4px; background-color: #e0e0e0; border-radius: 2px;">
                  <div id="progress-bar" style="width: 0%; height: 100%; background-color: #26a69a; border-radius: 2px; transition: width 5s linear;"></div>
                </div>
              </div>
              <a href="${url}" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background-color: #4285f4; color: white; text-decoration: none; border-radius: 4px;">今すぐログイン</a>
            </div>
          `;
          
          // プログレスバーのアニメーション
          setTimeout(() => {
            const bar = document.getElementById('progress-bar');
            if (bar) bar.style.width = '100%';
          }, 100);
          
          // 5秒後にリダイレクト
          setTimeout(() => {
            window.location.href = url;
          }, 5000);
        } else {
          showAuthenticationError('ログインURLの取得に失敗しました');
        }
      })
      .withFailureHandler(function(error) {
        showAuthenticationError('ログインURLの取得に失敗しました: ' + error);
      })
      .getScriptUrl();
  }

  // イベントリスナーの設定
  function setupEventListeners() {
    try {
      // 機器セレクタの変更イベント
      document.getElementById('equipment-select')?.addEventListener('change', function(e) {
        selectedEquipmentWithLocation = e.target.value;
        const parts = selectedEquipmentWithLocation.split('|');
        selectedEquipment = parts[0]; // 機器管理番号部分
        selectedLocation = parts[1] || ''; // 定置場所部分
        
        // いったんスキップフラグをクリア
        skipScrollToSelectedEquipment = false;
        
        // ガントチャート更新
        updateGanttChart();
        
        // 更新後、確実にスクロールするために遅延実行
        setTimeout(() => {
          scrollToSelectedEquipment();
        }, 1000);
      });
      
      // 貸出モーダル保存ボタン
      document.getElementById('save-rental')?.addEventListener('click', saveRental);
      
      // 返却モーダル保存ボタン
      document.getElementById('save-return')?.addEventListener('click', saveReturn);
      
      // 元に戻すボタン
      document.getElementById('undo-button')?.addEventListener('click', function() {
        if (undoStack.length > 0) {
          const action = undoStack.pop();
          executeUndo(action);
          
          // スタックが空になったらボタンを無効化
          if (undoStack.length === 0) {
            this.disabled = true;
          }
        }
      });
      
      // 現場追加ボタン
      document.getElementById('add-project-btn')?.addEventListener('click', addProject);
      
      // 現場削除ボタン
      document.getElementById('delete-projects-btn')?.addEventListener('click', deleteProjects);
      
      // 機器追加ボタン
      document.getElementById('add-equipment-btn')?.addEventListener('click', addEquipment);
      
      // 機器削除ボタン
      document.getElementById('delete-equipment-btn')?.addEventListener('click', deleteEquipment);
      
      // 機器削除取り消しボタン
      document.getElementById('undo-equipment-delete-btn')?.addEventListener('click', undoEquipmentDelete);
      
      // 設定チェックボックス変更イベント
      document.getElementById('confirm-dialog-checkbox')?.addEventListener('change', function(e) {
        userSettings.showConfirmDialog = e.target.checked;
        saveUserSettings();
      });
      
      // 管理ボタンを正しく設定
      setupManagementButtons();
      
      console.log('イベントリスナー設定完了');
    } catch (error) {
      console.error('イベントリスナー設定エラー:', error);
    }
  }
  
  // PC版マネージメントボタンのセットアップ
  function setupManagementButtons() {
    // 現場マスター管理ボタン
    document.getElementById('manage-projects-btn')?.addEventListener('click', function() {
      openProjectsModal();
    });
    
    // 機器マスター管理ボタン
    document.getElementById('manage-equipment-btn')?.addEventListener('click', function() {
      openEquipmentModal();
    });
  }
  
  // PC版フォントサイズスライダーを追加
  function setupPCFontSizeSlider() {
    try {
      const managementButtons = document.querySelector('.management-buttons');
      if (!managementButtons) return;
      
      // スライダーのHTMLを作成
      const sliderHTML = `
        <div class="font-size-control-pc">
          <label>文字サイズ:</label>
          <input type="range" id="pc-font-size-slider" min="10" max="20" value="12">
        </div>
      `;
      
      // 管理ボタンエリアに追加
      managementButtons.insertAdjacentHTML('beforeend', sliderHTML);
      
      // スライダーのイベントを設定
      const slider = document.getElementById('pc-font-size-slider');
      if (slider) {
        // 初期値を設定
        const savedSize = localStorage.getItem('fontSizePC');
        if (savedSize) {
          slider.value = savedSize;
          document.documentElement.style.fontSize = savedSize + 'px';
        }
        
        // スライダー変更イベント
        slider.addEventListener('input', function() {
          const size = this.value;
          document.documentElement.style.fontSize = size + 'px';
          localStorage.setItem('fontSizePC', size);
        });
      }
    } catch (error) {
      console.error('フォントサイズスライダー設定エラー:', error);
    }
  }
  
  // カレンダーナビゲーションボタンを追加
  function setupCalendarNavigation() {
    try {
      const controlButtons = document.getElementById('control-buttons');
      if (!controlButtons) return;
      
      // ナビゲーションボタンのHTMLを作成
      const navigationHTML = `
        <div class="calendar-navigation">
          <button class="btn waves-effect waves-light" id="prev-month">
            <i class="material-icons">keyboard_arrow_left</i>
          </button>
          <button class="btn waves-effect waves-light" id="prev-week">
            <i class="material-icons">chevron_left</i>
          </button>
          <button class="btn waves-effect waves-light" id="today">
            今日
          </button>
          <button class="btn waves-effect waves-light" id="next-week">
            <i class="material-icons">chevron_right</i>
          </button>
          <button class="btn waves-effect waves-light" id="next-month">
            <i class="material-icons">keyboard_arrow_right</i>
          </button>
        </div>
      `;
      
      // 制御ボタンの後に追加
      controlButtons.insertAdjacentHTML('afterend', navigationHTML);
      
      // ボタンのイベントを設定
      document.getElementById('prev-month')?.addEventListener('click', function() {
        const newDate = new Date(startDate);
        newDate.setMonth(newDate.getMonth() - 1);
        startDate = newDate;
        updateGanttChart();
      });
      
      document.getElementById('prev-week')?.addEventListener('click', function() {
        const newDate = new Date(startDate);
        newDate.setDate(newDate.getDate() - 7);
        startDate = newDate;
        updateGanttChart();
      });
      
      document.getElementById('today')?.addEventListener('click', function() {
        startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
        updateGanttChart();
      });
      
      document.getElementById('next-week')?.addEventListener('click', function() {
        const newDate = new Date(startDate);
        newDate.setDate(newDate.getDate() + 7);
        startDate = newDate;
        updateGanttChart();
      });
      
      document.getElementById('next-month')?.addEventListener('click', function() {
        const newDate = new Date(startDate);
        newDate.setMonth(newDate.getMonth() + 1);
        startDate = newDate;
        updateGanttChart();
      });
    } catch (error) {
      console.error('カレンダーナビゲーション設定エラー:', error);
    }
  }
  
  // 全データ取得関数
  function fetchAllData() {
    showLoading();
    
    // 機材リスト取得
    getEquipmentList(); // ここから連鎖的に次のデータ取得を行う
  }
  
  // ユーザー設定取得
  function loadUserSettings() {
    try {
      const savedSettings = localStorage.getItem('userSettings');
      if (savedSettings) {
        const parsedSettings = JSON.parse(savedSettings);
        userSettings = { ...userSettings, ...parsedSettings };
        
        // 確認ダイアログの設定を反映
        const checkbox = document.getElementById('confirm-dialog-checkbox');
        if (checkbox) {
          checkbox.checked = userSettings.showConfirmDialog;
        }
      }
    } catch (error) {
      console.error('ユーザー設定取得エラー:', error);
    }
  }
  
  // ユーザー設定保存
  function saveUserSettings() {
    try {
      localStorage.setItem('userSettings', JSON.stringify(userSettings));
    } catch (error) {
      console.error('ユーザー設定保存エラー:', error);
    }
  }
  
  // 日付ピッカーの設定
  function setupDatePickers() {
    try {
      const datePickerOptions = {
        format: 'yyyy-mm-dd',
        autoClose: true,
        showClearBtn: false,
        i18n: {
          months: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
          monthsShort: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
          weekdays: ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'],
          weekdaysShort: ['日', '月', '火', '水', '木', '金', '土'],
          weekdaysAbbrev: ['日', '月', '火', '水', '木', '金', '土'],
          cancel: 'キャンセル',
          clear: 'クリア',
          done: '選択'
        }
      };
      
      // 日付選択用
      const datePickers = document.querySelectorAll('.datepicker');
      M.Datepicker.init(datePickers, datePickerOptions);
      
      // カスタム日付ピッカー
      const customDatePicker = document.getElementById('custom-date-picker');
      if (customDatePicker) {
        const instance = M.Datepicker.getInstance(customDatePicker);
        if (!instance) {
          const options = {
            ...datePickerOptions,
            defaultDate: startDate,
            onSelect: (date) => {
              startDate = date;
              updateGanttChart();
            }
          };
          M.Datepicker.init(customDatePicker, options);
        }
        
        // カレンダーアイコンのクリックイベント
        const calendarIcon = document.getElementById('calendar-trigger');
        if (calendarIcon) {
          calendarIcon.addEventListener('click', () => {
            const instance = M.Datepicker.getInstance(customDatePicker);
            if (instance) {
              instance.open();
            }
          });
        }
      }
      
      // 数量コントロールも設定
      setupQuantityControls();
    } catch (error) {
      console.error('日付ピッカー設定エラー:', error);
    }
  }
  
  // 数量コントロールのセットアップ
  function setupQuantityControls() {
    try {
      // マイナスボタン
      document.querySelectorAll('.quantity-btn.minus').forEach(btn => {
        btn.addEventListener('click', function() {
          const input = this.parentNode.querySelector('input[type="number"]');
          if (input) {
            const value = parseInt(input.value, 10);
            if (value > parseInt(input.min, 10)) {
              input.value = value - 1;
            }
          }
        });
      });
      
      // プラスボタン
      document.querySelectorAll('.quantity-btn.plus').forEach(btn => {
        btn.addEventListener('click', function() {
          const input = this.parentNode.querySelector('input[type="number"]');
          if (input) {
            const value = parseInt(input.value, 10);
            const max = parseInt(input.max, 10) || 999;
            if (value < max) {
              input.value = value + 1;
            }
          }
        });
      });
    } catch (error) {
      console.error('数量コントロール設定エラー:', error);
    }
  }
  
  // ユーザー情報取得
  function getUserInfo() {
    console.log('ユーザー情報取得開始');
    
    // 即座に「読み込み中...」と表示
    const usernameElement = document.getElementById('username');
    if (usernameElement) {
      usernameElement.textContent = '読み込み中...';
    }
    
    // ユーザー情報リクエスト
    google.script.run
      .withSuccessHandler(function(userInfo) {
        console.log('ユーザー情報取得成功:', userInfo);
        
        if (userInfo && userInfo.authenticated && userInfo.isRegistered) {
          // 認証済み＆登録済みユーザー
          userEmail = userInfo.email || '';
          userName = userInfo.name || userInfo.email || 'ゲスト';
          
          if (usernameElement) {
            usernameElement.textContent = userName;
          }
        } else if (userInfo && userInfo.authenticated && !userInfo.isRegistered) {
          // 認証済みだが未登録
          console.warn('未登録ユーザー:', userInfo.email);
          showUnregisteredUserMessage(userInfo.email);
        } else {
          // 未認証
          console.warn('未認証ユーザー');
          redirectToLogin();
        }
      })
      .withFailureHandler(function(error) {
        console.error('ユーザー情報取得エラー:', error);
        
        if (usernameElement) {
          usernameElement.textContent = 'エラー';
        }
        
        // 5秒後に再試行
        setTimeout(checkAuthentication, 5000);
      })
      .getUserInfo();
  }
  
  // 機材リスト取得
  function getEquipmentList() {
    console.log('機材リスト取得開始');
    
    // ユーザー情報も取得（認証済みなので再確認）
    getUserInfo();
    
    google.script.run
      .withSuccessHandler(function(data) {
        if (data && Array.isArray(data)) {
          equipmentList = data;
          console.log('機材リスト取得成功: ' + data.length + '件');
        } else {
          console.warn('機材リストが空か無効です、空のリストで続行します');
          equipmentList = [];
        }
        
        updateEquipmentSelect();
        
        // 定置場所リスト取得
        getLocationsList();
      })
      .withFailureHandler(function(error) {
        console.error('機材リスト取得失敗:', error);
        equipmentList = [];
        updateEquipmentSelect();
        
        // エラーでも次の処理に進む
        getLocationsList();
      })
      .getEquipmentList();
  }
  
  // 定置場所リスト取得
  function getLocationsList() {
    console.log('定置場所リスト取得開始');
    
    // タイムアウトを設定（10秒後にタイムアウト）
    const timeoutId = setTimeout(function() {
      console.log('定置場所リスト取得がタイムアウトしました');
      // 空のリストで続行
      locationsList = [];
      getProjectsList();
    }, 10000);
    
    google.script.run
      .withSuccessHandler(function(data) {
        // タイムアウトをクリア
        clearTimeout(timeoutId);
        
        if (data && Array.isArray(data)) {
          locationsList = data;
          console.log('定置場所リスト取得成功: ' + data.length + '件');
        } else {
          locationsList = [];
          console.warn('定置場所リストが空です');
        }
        
        // 現場リスト取得
        getProjectsList();
      })
      .withFailureHandler(function(error) {
        // タイムアウトをクリア
        clearTimeout(timeoutId);
        
        console.error('定置場所リスト取得失敗:', error);
        locationsList = [];
        
        // 現場リスト取得
        getProjectsList();
      })
      .getLocationsList();
  }
  
  // 現場リスト取得（新規追加）
  function getProjectsList() {
    console.log('現場リスト取得開始');
    
    // タイムアウトを設定（10秒後にタイムアウト）
    const timeoutId = setTimeout(function() {
      console.log('現場リスト取得がタイムアウトしました');
      // 空のリストで続行
      projectsList = [];
      getRentalData();
      restoreLastSelection();
    }, 10000);
    
    google.script.run
      .withSuccessHandler(function(data) {
        // タイムアウトをクリア
        clearTimeout(timeoutId);
        
        if (data && Array.isArray(data)) {
          projectsList = data;
          console.log('現場リスト取得成功: ' + data.length + '件');
        } else {
          projectsList = [];
          console.warn('現場リストが空です');
        }
        
        // 貸出データを取得
        getRentalData();
        
        // 前回選択していた機材を復元
        restoreLastSelection();
      })
      .withFailureHandler(function(error) {
        // タイムアウトをクリア
        clearTimeout(timeoutId);
        
        console.error('現場リスト取得失敗:', error);
        projectsList = [];
        
        // 貸出データを取得
        getRentalData();
        
        // 前回選択していた機材を復元
        restoreLastSelection();
      })
      .getProjectsList();
  }
  
  // 貸出データ取得
  function getRentalData() {
    console.log('貸出データ取得開始');
    
    // タイムアウトを設定（15秒後にタイムアウト）
    const timeoutId = setTimeout(function() {
      console.log('貸出データ取得がタイムアウトしました');
      
      // 空のリストで続行
      rentalData = [];
      initialDataLoaded = true;
      hideLoading();
      updateGanttChart();
    }, 15000);
    
    google.script.run
      .withSuccessHandler(function(data) {
        // タイムアウトをクリア
        clearTimeout(timeoutId);
        
        if (data && Array.isArray(data)) {
          // 日付文字列をDateオブジェクトに変換して保存
          rentalData = data.map(item => {
            Object.keys(item).forEach(key => {
              if (key === '借用開始日' || key === '借用終了日' || key === '登録日時' || key === '返却日') {
                if (item[key] && typeof item[key] === 'string') {
                  item[key] = new Date(item[key]);
                }
              }
            });
            
            // ステータスが設定されていない場合、返却日に基づいて判定
            if (!item['ステータス']) {
              item['ステータス'] = item['返却日'] ? '返却済み' : '貸出中';
            }
            
            return item;
          });
          
          console.log('貸出データ取得成功: ' + data.length + '件');
        } else {
          rentalData = [];
          console.warn('貸出データが空か無効です');
        }
        
        // データ取得完了フラグをセット
        initialDataLoaded = true;
        
        // ローディング非表示
        hideLoading();
        
        // ガントチャート更新
        updateGanttChart();
      })
      .withFailureHandler(function(error) {
        // タイムアウトをクリア
        clearTimeout(timeoutId);
        
        console.error('貸出データ取得失敗:', error);
        rentalData = [];
        
        // データ取得完了フラグをセット
        initialDataLoaded = true;
        
        // ローディング非表示
        hideLoading();
        
        // ガントチャート更新
        updateGanttChart();
      })
      .getRentalData();
  }
  
  // 機材セレクト更新
  function updateEquipmentSelect() {
    try {
      const select = document.getElementById('equipment-select');
      if (!select) return;
      
      // 既存の選択肢をクリア
      select.innerHTML = '<option value="" disabled selected>機材を選択してください</option>';
      
      // 機器ごとにグループ化
      const equipmentGroups = {};
      
      equipmentList.forEach(item => {
        if (!item['機器管理番号'] || !item['機器名称']) return;
        
        const id = item['機器管理番号'];
        if (!equipmentGroups[id]) {
          equipmentGroups[id] = [];
        }
        equipmentGroups[id].push(item);
      });
      
      // グループをあいうえお順でソート
      const sortedGroups = Object.keys(equipmentGroups).sort((a, b) => {
        const itemA = equipmentGroups[a][0];
        const itemB = equipmentGroups[b][0];
        return String(itemA['機器名称']).localeCompare(String(itemB['機器名称']), 'ja');
      });
      
      // 選択肢を追加
      sortedGroups.forEach(groupId => {
        const group = equipmentGroups[groupId];
        const firstItem = group[0];
        
        // 機器ごとに在庫総数を計算
        let totalStock = 0;
        group.forEach(item => {
          totalStock += (parseInt(item['総台数']) || 0);
        });
        
        // 各定置場所ごとの機材を追加
        group.forEach(item => {
          const option = document.createElement('option');
          // 機器管理番号と定置場所を組み合わせたvalue
          option.value = `${item['機器管理番号']}|${item['定置場所'] || ''}`;
          
          // 機器名のみを表示（定置場所は括弧内に小さく表示）
          let locationText = item['定置場所'] || '未設定';
          let displayText = `${item['機器名称']} (${locationText})`;
          
          option.textContent = displayText;
          select.appendChild(option);
        });
      });
      
      // MaterializeのSelectを初期化
      try {
        M.FormSelect.init(select);
      } catch (e) {
        console.error('セレクト初期化エラー:', e);
      }
    } catch (error) {
      console.error('機材セレクト更新エラー:', error);
    }
  }
  
  // 1. updateGanttChart関数の修正 - PCに特化した実装
  function updateGanttChart() {
    try {
      showLoading();
      console.log('ガントチャート更新開始');
      
      // 選択中の機材と定置場所の情報を保存
      saveCurrentSelection();
      
      // 表示する日数を拡張（より多くの日付を表示）
      let endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 60); // 60日分表示に拡張
      
      // 日付配列作成
      const days = [];
      const tempDate = new Date(startDate);
      while (tempDate < endDate) {
        days.push(new Date(tempDate));
        tempDate.setDate(tempDate.getDate() + 1);
      }
      
      // PC向けレイアウトの作成
      createDesktopLayout(days);
      
      // ガントチャートの高さを調整
      adjustGanttHeight();
      
      // 日付スライダーを追加
      setupDateSlider();
      
      hideLoading();
      
      // 選択中の機材までスクロール
      if (!skipScrollToSelectedEquipment) {
        scrollToSelectedEquipment();
      }
    } catch (error) {
      console.error('ガントチャート更新エラー:', error);
      hideLoading();
      alert('ガントチャートの更新中にエラーが発生しました: ' + error);
    }
  }
  
  // ガントチャートの高さを調整する関数の修正版 - PCに特化した実装
  function adjustGanttHeight() {
    const ganttContainer = document.querySelector('.gantt-container');
    if (!ganttContainer) return;
    
    // PC版の場合
    const ganttRows = document.querySelector('#gantt-rows');
    if (!ganttRows) return;
    
    // ガントチャートの行の数を取得
    const rowCount = ganttRows.children.length;
    
    if (rowCount === 0) {
      // 行がない場合は最小高さを設定
      ganttContainer.style.height = '100px';
    } else {
      // 画面の高さの60%を使用するように調整
      const viewportHeight = window.innerHeight;
      const headerHeight = document.querySelector('.header')?.offsetHeight || 0;
      const otherElementsHeight = 150; // ヘッダー、ボタン等の高さを考慮
      
      // ガントチャートの高さを設定（画面高さの60%）
      const ganttHeight = Math.max(400, viewportHeight * 0.6);
      ganttContainer.style.height = `${ganttHeight}px`;
      ganttContainer.style.overflowY = 'auto';
    }
  }
  
  // 日付スライダー設定関数
  function setupDateSlider() {
    try {
      // 既存のスライダーコンテナを取得または作成
      let sliderContainer = document.querySelector('.date-slider-container');
      
      if (!sliderContainer) {
        // コンテナが存在しない場合は作成
        sliderContainer = document.createElement('div');
        sliderContainer.className = 'date-slider-container';
        
        const ganttContainer = document.querySelector('.gantt-container');
        if (ganttContainer) {
          ganttContainer.parentNode.insertBefore(sliderContainer, ganttContainer);
        }
      }
      
      // スライダーコンテナのHTMLを設定
      sliderContainer.innerHTML = `
        <div class="date-slider-label" id="date-slider-start">${formatDate(startDate)}</div>
        <input type="range" id="date-slider" value="0" min="0" max="100">
        <div class="date-slider-label" id="date-slider-end">${formatDate(new Date(startDate.getTime() + 59 * 24 * 60 * 60 * 1000))}</div>
        <button class="date-slider-today" id="slider-today-btn">
          <i class="material-icons">today</i>今日
        </button>
      `;
      
      // 今日ボタンのイベント
      document.getElementById('slider-today-btn')?.addEventListener('click', function() {
        startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
        updateGanttChart();
      });
      
      // スライダーのイベント
      const slider = document.getElementById('date-slider');
      if (slider) {
        slider.addEventListener('input', function() {
          const progress = parseFloat(this.value) / 100;
          
          // 日付ヘッダーと同期スクロール
          const dateHeaders = document.getElementById('date-headers');
          if (dateHeaders) {
            const maxScroll = dateHeaders.scrollWidth - dateHeaders.clientWidth;
            dateHeaders.scrollLeft = maxScroll * progress;
          }
        });
      }
      
      // 日付ヘッダーのスクロールイベントとスライダーを同期
      const dateHeaders = document.getElementById('date-headers');
      if (dateHeaders) {
        dateHeaders.addEventListener('scroll', function() {
          const slider = document.getElementById('date-slider');
          if (slider) {
            const scrollWidth = dateHeaders.scrollWidth - dateHeaders.clientWidth;
            if (scrollWidth > 0) {
              slider.value = (dateHeaders.scrollLeft / scrollWidth) * 100;
            }
          }
        });
      }
    } catch (error) {
      console.error('日付スライダー設定エラー:', error);
    }
  }
  
  // 選択機材へのスクロール調整
  function scrollToSelectedEquipment() {
    // スキップフラグがオンの場合は何もしない
    if (skipScrollToSelectedEquipment) return;
    
    if (!selectedEquipmentWithLocation) return;
    
    console.log('scrollToSelectedEquipment called with:', selectedEquipmentWithLocation);
    
    // スクロール処理を遅延実行（チャートの描画完了を待つ）
    setTimeout(() => {
      try {
        const parts = selectedEquipmentWithLocation.split('|');
        const equipmentId = parts[0];
        const location = parts[1] || '';
        
        console.log('Searching for equipment:', equipmentId, 'at location:', location);
        
        // 選択した機材の行要素を検索
        let element = null;
        
        // PC表示の場合
        element = document.querySelector(`.gantt-row[data-equipment-id="${equipmentId}"][data-location="${location}"]`);
        
        // セレクタが見つからない場合は別の方法で検索
        if (!element) {
          console.log('Trying alternative selector');
          // 全ての行を取得してIDを比較
          const rows = document.querySelectorAll('.gantt-row');
          for (const row of rows) {
            if (row.dataset.equipmentId === equipmentId && 
                (row.dataset.location || '') === location) {
              element = row;
              break;
            }
          }
        }
        
        if (element) {
          console.log('Found element:', element);
          
          // スクロールするコンテナを取得
          const container = document.querySelector('.gantt-container');
          if (container) {
            console.log('スクロール処理を実行:');
            console.log('- 要素の位置:', element.offsetTop);
            console.log('- コンテナの位置:', container.offsetTop);
            
            // 要素を上部（少し余白を持たせて）に表示
            const scrollTop = element.offsetTop - container.offsetTop;
            container.scrollTop = scrollTop;
            
            // 確実にスクロールするため、直接コマンドも実行
            setTimeout(() => {
              // scrollIntoViewも併用
              element.scrollIntoView({block: 'start', behavior: 'auto'});
              
              // さらに遅延させて再スクロール
              setTimeout(() => {
                container.scrollTop = scrollTop;
              }, 50);
            }, 50);
            
            console.log('Scrolled to position:', scrollTop);
          } else {
            console.error('Container element not found');
          }
        } else {
          console.error('Target equipment element not found');
          console.log('Available rows:', document.querySelectorAll('.gantt-row').length);
        }
      } catch (error) {
        console.error('選択機材へのスクロールエラー:', error);
      }
    }, 800); // 遅延時間を長めに設定（800ms）
  }
  
  // PC向けレイアウト作成関数
  function createDesktopLayout(days) {
    // ガントチャートコンテナを取得
    const ganttContainer = document.querySelector('.gantt-container');
    if (!ganttContainer) return;
    
    // コンテナをクリア
    ganttContainer.innerHTML = '';
    
    // 日付ヘッダー行
    const headerRow = document.createElement('div');
    headerRow.className = 'gantt-row gantt-header';
    
    // 機材名ヘッダー
    const headerItem = document.createElement('div');
    headerItem.className = 'gantt-item';
    headerItem.textContent = '機材名';
    headerRow.appendChild(headerItem);
    
    // 日付ヘッダー
    const dateHeaders = document.createElement('div');
    dateHeaders.className = 'gantt-dates';
    dateHeaders.id = 'date-headers';
    dateHeaders.style.overflowX = 'auto'; // 横スクロール可能に
    
    // 日付ヘッダーに日付を追加
    days.forEach(day => {
      const header = document.createElement('div');
      header.className = 'gantt-date';
      header.textContent = formatDate(day, 'MM/dd');
      dateHeaders.appendChild(header);
    });
    
    // 日付ヘッダーにスクロールイベントリスナーを追加（同期スクロール用）
    dateHeaders.addEventListener('scroll', function() {
      const timelines = document.querySelectorAll('.gantt-timeline');
      timelines.forEach(timeline => {
        timeline.scrollLeft = dateHeaders.scrollLeft;
      });
      
      // スライダーとも同期
      const slider = document.getElementById('date-slider');
      if (slider) {
        const scrollWidth = dateHeaders.scrollWidth - dateHeaders.clientWidth;
        if (scrollWidth > 0) {
          slider.value = (dateHeaders.scrollLeft / scrollWidth) * 100;
        }
      }
    });
    
    headerRow.appendChild(dateHeaders);
    ganttContainer.appendChild(headerRow);
    
    // 行コンテナ
    const ganttRows = document.createElement('div');
    ganttRows.id = 'gantt-rows';
    ganttRows.style.overflowY = 'auto'; // 縦スクロール可能に
    ganttContainer.appendChild(ganttRows);
    
    // 選択中の機器+定置場所の情報を取得
    let selectedPlaceInfo = null;
    if (selectedEquipmentWithLocation) {
      const parts = selectedEquipmentWithLocation.split('|');
      if (parts.length > 1) {
        selectedPlaceInfo = {
          id: parts[0],
          location: parts[1] || ''
        };
      }
    }
    
    // 機材をあいうえお順に並べ替え
    const sortedEquipmentList = [...equipmentList]
      .filter(item => (parseInt(item['総台数']) || 0) > 0) // 台数が0の場合は表示しない
      .sort((a, b) => {
        if (!a['機器名称']) return 1;
        if (!b['機器名称']) return -1;
        return String(a['機器名称']).localeCompare(String(b['機器名称']), 'ja');
      });

    // すべての機材を表示対象とする
    const displayEquipment = sortedEquipmentList;
    
    // 表示対象が存在しない場合
    if (displayEquipment.length === 0) {
      const emptyRow = document.createElement('div');
      emptyRow.className = 'gantt-row';
      emptyRow.style.height = '100px';
      
      const emptyMessage = document.createElement('div');
      emptyMessage.className = 'gantt-item center-align';
      emptyMessage.style.width = '100%';
      emptyMessage.style.padding = '20px';
      emptyMessage.style.color = '#666';
      emptyMessage.textContent = '表示する機材がありません。機材マスターから機材を追加してください。';
      
      emptyRow.appendChild(emptyMessage);
      ganttRows.appendChild(emptyRow);
      
      return;
    }
    
    // 各機材の行を作成
    displayEquipment.forEach(item => {
      if (!item['機器管理番号']) return;
      
      const equipmentId = item['機器管理番号'];
      const location = item['定置場所'] || '';
      
      // 行作成
      const row = document.createElement('div');
      row.className = 'gantt-row';
      row.dataset.equipmentId = equipmentId;
      row.dataset.location = location;
      
      // 現在選択中の機器+定置場所かどうかチェック
      const isSelected = selectedPlaceInfo && 
                        String(equipmentId) === String(selectedPlaceInfo.id) && 
                        String(location) === String(selectedPlaceInfo.location);
      
      if (isSelected) {
        row.classList.add('selected-equipment');
      }
      
      // 機材名セル
      const nameCell = document.createElement('div');
      nameCell.className = 'gantt-item';

      const infoContainer = document.createElement('div');
      infoContainer.className = 'equipment-info';

      // 機材名と機器管理番号
      const nameDiv = document.createElement('div');
      nameDiv.className = 'equipment-name';
      nameDiv.textContent = `${item['機器名称']} (${equipmentId})`;
      infoContainer.appendChild(nameDiv);
      
      // 定置場所
      if (item['定置場所']) {
        const locationDiv = document.createElement('div');
        locationDiv.className = 'equipment-location';
        locationDiv.textContent = `${item['定置場所']}`;
        infoContainer.appendChild(locationDiv);
      }
      
      // 在庫台数
      const stockDiv = document.createElement('div');
      stockDiv.className = 'equipment-stock';
      stockDiv.textContent = `在庫台数: ${item['総台数'] || 0}台`;
      infoContainer.appendChild(stockDiv);
      
      // 追加情報: 仕様
      if (item['仕様']) {
        addDetailLine(infoContainer, '仕様', item['仕様']);
      }
      
      // 追加情報: 型番
      if (item['型番']) {
        addDetailLine(infoContainer, '型番', item['型番']);
      }
      
      // 追加情報: メーカー
      if (item['メーカー']) {
        addDetailLine(infoContainer, 'メーカー', item['メーカー']);
      }
      
      // 追加情報: 備考1
      if (item['備考1']) {
        addDetailLine(infoContainer, '備考1', item['備考1']);
      }
      
      // 追加情報: 備考2
      if (item['備考2']) {
        addDetailLine(infoContainer, '備考2', item['備考2']);
      }
      
      nameCell.appendChild(infoContainer);

      if (isSelected) {
        nameCell.style.backgroundColor = '#e3f2fd';
      }

      row.appendChild(nameCell);
      
      // タイムライン作成
      const timeline = document.createElement('div');
      timeline.className = 'gantt-timeline';
      timeline.style.position = 'relative';
      timeline.style.flex = '1';
      timeline.dataset.equipment = equipmentId;
      timeline.dataset.location = location;
      
      // 横スクロールバーを表示しない（スクロールは親要素と同期）
      timeline.style.overflowX = 'hidden';
      
      // マウスホイールを無効化してスクロール同期を維持
      timeline.addEventListener('wheel', function(e) {
        if (e.shiftKey) {
          e.preventDefault();
          const dateHeaders = document.querySelector('#date-headers');
          if (dateHeaders) {
            dateHeaders.scrollLeft += e.deltaY;
          }
        }
      });
      
      // マウスダウンイベント設定
      timeline.addEventListener('mousedown', onTimelineMouseDown);
      
      // 日付セル作成
      days.forEach((day, index) => {
        const dayCell = document.createElement('div');
        dayCell.className = 'gantt-day';
        dayCell.dataset.date = formatDate(day);
        dayCell.dataset.equipment = equipmentId;
        dayCell.dataset.location = location;
        dayCell.dataset.index = index;
        timeline.appendChild(dayCell);
      });
      
      // 機器と定置場所が一致する貸出だけを表示
      const myRentals = rentalData.filter(rental => {
        if (!rental) return false;
        
        const rentalEquipId = String(rental['機器管理番号'] || '');
        const targetEquipId = String(equipmentId || '');
        const equipMatch = (rentalEquipId === targetEquipId);
        
        const rentalLocation = String(rental['貸出元'] || '');
        const targetLocation = String(location || '');
        const locationMatch = (rentalLocation === targetLocation);
        
        const isActive = rental['ステータス'] !== '返却済み' || !rental['返却日'];
        
        return equipMatch && locationMatch && isActive;
      });
      
      // 貸出が複数ある場合に重ならないように処理する
      if (myRentals.length > 0) {
        // 貸出を日付範囲に変換
        const rentalRanges = myRentals.map(rental => {
          let startDay = parseDate(rental['借用開始日']);
          let endDay = parseDate(rental['借用終了日']);
          
          if (!startDay || !endDay) return null;
          
          startDay.setHours(0, 0, 0, 0);
          endDay.setHours(0, 0, 0, 0);
          
          return {
            rental: rental,
            startDay: startDay,
            endDay: endDay,
            layer: null
          };
        }).filter(range => range !== null);
        
        // 表示範囲を考慮
        const rangeStart = new Date(days[0]);
        const rangeEnd = new Date(days[days.length - 1]);
        rangeStart.setHours(0, 0, 0, 0);
        rangeEnd.setHours(23, 59, 59, 999);
        
        // 貸出を日付順にソート
        rentalRanges.sort((a, b) => a.startDay.getTime() - b.startDay.getTime());
        
        // 各貸出に表示レイヤーを割り当て
        const layers = [];
        
        // 各貸出に対してレイヤーを割り当てる
        rentalRanges.forEach(rentalRange => {
          let assignedLayer = false;
          
          for (let i = 0; i < layers.length; i++) {
            let hasConflict = false;
            
            for (const existingRange of layers[i]) {
              if (!(rentalRange.endDay < existingRange.startDay || 
                   rentalRange.startDay > existingRange.endDay)) {
                hasConflict = true;
                break;
              }
            }
            
            if (!hasConflict) {
              layers[i].push(rentalRange);
              rentalRange.layer = i;
              assignedLayer = true;
              break;
            }
          }
          
          if (!assignedLayer) {
            layers.push([rentalRange]);
            rentalRange.layer = layers.length - 1;
          }
        });
        
        // レイヤー数に基づいて行の高さを調整（最低2つのレイヤーを確保）
        const layerCount = Math.max(2, layers.length);
        row.style.height = (layerCount * 40) + 'px';
        timeline.style.height = (layerCount * 40) + 'px';
        
        // 各貸出バーを作成
        rentalRanges.forEach(rentalRange => {
          try {
            const rental = rentalRange.rental;
            const startDay = rentalRange.startDay;
            const endDay = rentalRange.endDay;
            const layer = rentalRange.layer;
            
            // 範囲外なら表示しない
            if (endDay < rangeStart || startDay > rangeEnd) return;
            
            // バーの日付範囲
            let visibleStartDay = startDay < rangeStart ? rangeStart : startDay;
            let visibleEndDay = endDay > rangeEnd ? rangeEnd : endDay;
            
            // インデックスを計算
            let startIdx = -1;
            let endIdx = -1;
            
            for (let i = 0; i < days.length; i++) {
              const currentDay = new Date(days[i]);
              currentDay.setHours(0, 0, 0, 0);
              
              if (startIdx === -1 && visibleStartDay.getTime() <= currentDay.getTime()) {
                startIdx = i;
              }
              
              if (visibleEndDay.getTime() >= currentDay.getTime()) {
                endIdx = i;
              }
            }
            
            // インデックスチェック
            if (startIdx === -1 || endIdx === -1 || startIdx > endIdx) return;
            
            // セル幅を取得
            const cellWidth = userSettings.cellWidth || 80;
            
            const width = ((endIdx - startIdx) + 1) * cellWidth;
            const left = startIdx * cellWidth;
            const top = layer * 40;
            
            // バー要素作成
            const bar = document.createElement('div');
            bar.className = 'rental-bar';
            bar.style.position = 'absolute';
            bar.style.left = left + 'px';
            bar.style.top = top + 'px';
            bar.style.width = width + 'px';
            bar.style.height = '30px';
            bar.style.borderRadius = '3px';
            bar.style.color = 'white';
            bar.style.padding = '5px 30px 5px 5px';
            bar.style.fontSize = '12px';
            bar.style.zIndex = '10';
            bar.style.cursor = 'pointer';
            bar.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            bar.style.overflow = 'hidden';
            bar.style.textOverflow = 'ellipsis';
            bar.style.whiteSpace = 'nowrap';

            // バーデータとテキスト
            bar.dataset.rentalId = rental['登録日時'] ? rental['登録日時'].toString() : '';
            bar.dataset.layer = layer;
            bar.dataset.location = location;

            bar.textContent = `${rental['数量']}台-${rental['使用場所']}(${getUserDisplayName(rental['借用者'])})`;
            
            // 定置場所と使用場所に基づいて色を決定
            if (location && rental['使用場所'] && location === rental['使用場所']) {
              // 同じ場所の場合は緑色
              bar.style.backgroundColor = '#26a69a';
            } else {
              // 異なる場所の場合はオレンジ色
              bar.style.backgroundColor = '#ff9800';
            }

            // ドラッグ＆リサイズ機能を有効化
            enableBarDragAndResize(bar, rental);

            // タイムラインに追加
            timeline.appendChild(bar);
          } catch (error) {
            console.error('貸出バー作成エラー:', error);
          }
        });
      }
      
      row.appendChild(timeline);
      ganttRows.appendChild(row);
    });
  }
  
  // 詳細行を追加するヘルパー関数
  function addDetailLine(container, label, value) {
    if (!value) return;
    
    const detailLine = document.createElement('div');
    detailLine.className = 'equipment-detail';
    detailLine.textContent = `${label}: ${value}`;
    container.appendChild(detailLine);
  }
  
  // ユーザー表示名の取得関数
  function getUserDisplayName(email) {
    if (!email) return '';
    
    // @より前の部分を取得
    const username = email.split('@')[0];
    return username;
  }
  
  // バーのドラッグ＆リサイズ機能を有効化
  function enableBarDragAndResize(bar, rental) {
    if (!bar || !rental) return;
    
    // 編集可能クラスを追加
    bar.classList.add('editable');
    
    // 左リサイズハンドル（ドラッグで開始日を変更）
    const leftHandle = document.createElement('div');
    leftHandle.className = 'resize-handle left-handle';
    leftHandle.style.position = 'absolute';
    leftHandle.style.top = '0';
    leftHandle.style.left = '0';
    leftHandle.style.width = '20px';
    leftHandle.style.height = '100%';
    leftHandle.style.cursor = 'ew-resize';
    
    // 右リサイズハンドル（ドラッグで終了日を変更）
    const rightHandle = document.createElement('div');
    rightHandle.className = 'resize-handle right-handle';
    rightHandle.style.position = 'absolute';
    rightHandle.style.top = '0';
    rightHandle.style.right = '0';
    rightHandle.style.width = '20px';
    rightHandle.style.height = '100%';
    rightHandle.style.cursor = 'ew-resize';
    
    // 返却ボタン
    const returnButton = document.createElement('button');
    returnButton.className = 'btn-floating btn-small red return-button';
    returnButton.innerHTML = '<i class="material-icons">keyboard_return</i>';
    returnButton.title = '返却';
    
    // 返却ボタンのクリックイベント
    returnButton.addEventListener('click', (e) => {
      e.stopPropagation(); // バーのクリックイベントを発生させない
      showReturnModal(rental);
    });
    
    // バーにハンドルを追加
    bar.appendChild(leftHandle);
    bar.appendChild(rightHandle);
    bar.appendChild(returnButton);
    
    // バークリックイベント
    bar.addEventListener('click', function(e) {
      // ハンドルをクリックした場合は無視（ハンドルは別のリスナーで処理）
      if (e.target.classList.contains('resize-handle') || e.target.classList.contains('return-button')) {
        return;
      }
      
      // クリックしたバーにある返却ボタンを使って返却モーダルを表示
      showReturnModal(rental);
    });
    
    // ドラッグ関連変数
    let startX;
    let startLeft;
    let startWidth;
    let dragMode = null; // 'move', 'resize-start', 'resize-end'
    let timeline;
    
    // 左ハンドルマウスダウン（開始日変更）
    leftHandle.addEventListener('mousedown', function(e) {
      e.stopPropagation();
      dragMode = 'resize-start';
      startResize(e);
    });
    
    // 右ハンドルマウスダウン（終了日変更）
    rightHandle.addEventListener('mousedown', function(e) {
      e.stopPropagation();
      dragMode = 'resize-end';
      startResize(e);
    });
    
    // バー本体マウスダウン（移動）
    bar.addEventListener('mousedown', function(e) {
      // ハンドルまたは返却ボタンをクリックした場合は無視
      if (e.target.classList.contains('resize-handle') || 
          e.target === returnButton || 
          e.target.closest('.return-button')) {
        return;
      }
      
      e.stopPropagation();
      dragMode = 'move';
      startDrag(e);
    });
    
    // リサイズ開始
    function startResize(e) {
      if (isResizingBar || isDraggingBar) return;
      e.preventDefault();
      
      isResizingBar = true;
      startX = e.clientX;
      startLeft = parseInt(bar.style.left, 10);
      startWidth = parseInt(bar.style.width, 10);
      timeline = bar.closest('.gantt-timeline');
      
      // ドラッグ中のスタイル調整
      bar.classList.add('resizing');
      
      // リサイズ中のグローバル変数を設定
      dragBarElement = bar;
      dragBarData = {
        startX: startX,
        startLeft: startLeft,
        startWidth: startWidth,
        timeline: timeline,
        rental: rental,
        mode: dragMode
      };
      
      // グローバルイベントリスナーを追加
      document.addEventListener('mousemove', onResizeMove);
      document.addEventListener('mouseup', onResizeEnd);
    }
    
    // ドラッグ開始
    function startDrag(e) {
      if (isDraggingBar || isResizingBar) return;
      e.preventDefault();
      
      isDraggingBar = true;
      startX = e.clientX;
      startLeft = parseInt(bar.style.left, 10);
      timeline = bar.closest('.gantt-timeline');
      
      // ドラッグ中のスタイル調整
      bar.classList.add('dragging');
      
      // ドラッグ中のグローバル変数を設定
      dragBarElement = bar;
      dragBarData = {
        startX: startX,
        startLeft: startLeft,
        timeline: timeline,
        rental: rental,
        mode: 'move'
      };
      
      // ドラッグ開始位置を保存（元に戻す場合用）
      dragBarOriginalPosition = {
        left: startLeft,
        width: parseInt(bar.style.width, 10)
      };
      
      // グローバルイベントリスナーを追加
      document.addEventListener('mousemove', onDragMove);
      document.addEventListener('mouseup', onDragEnd);
    }
  }
  
  // リサイズ移動時のハンドラ（グローバルイベント）
  function onResizeMove(e) {
    if (!isResizingBar || !dragBarElement || !dragBarData) return;
    e.preventDefault();
    
    const bar = dragBarElement;
    const startX = dragBarData.startX;
    const startLeft = dragBarData.startLeft;
    const startWidth = dragBarData.startWidth;
    const timeline = dragBarData.timeline;
    const resizeMode = dragBarData.mode;
    
    // マウス移動量
    const deltaX = e.clientX - startX;
    
    // セル幅を取得
    const cellWidth = userSettings.cellWidth || 80;
    
    // タイムラインの日付セルを取得
    const dateCells = Array.from(timeline.querySelectorAll('.gantt-day'));
    if (dateCells.length === 0) return;
    
    // グリッドにスナップするためのステップ計算
    const step = cellWidth;
    
    if (resizeMode === 'resize-start') {
      // 左側リサイズ処理
      
      // 新しい左位置
      const newLeft = startLeft + Math.round(deltaX / step) * step;
      
      // 最小幅を確保（1セル）
      const minWidth = 1 * step;
      
      // 新しい幅計算
      const newWidth = startWidth - (newLeft - startLeft);
      
      // 最小幅を下回る場合は位置を調整
      if (newWidth < minWidth) {
        bar.style.left = `${startLeft + startWidth - minWidth}px`;
        bar.style.width = `${minWidth}px`;
      } else {
        bar.style.left = `${newLeft}px`;
        bar.style.width = `${newWidth}px`;
      }
    } else if (resizeMode === 'resize-end') {
      // 右側リサイズ処理
      
      // 新しい幅
      const newWidth = startWidth + Math.round(deltaX / step) * step;
      
      // 最小幅を確保（1セル）
      const minWidth = 1 * step;
      
      // 幅を設定
      bar.style.width = `${Math.max(newWidth, minWidth)}px`;
    }
  }
  
  // リサイズ終了時のハンドラ
  function onResizeEnd(e) {
    if (!isResizingBar || !dragBarElement || !dragBarData) return;
    e.preventDefault();
    
    // グローバルイベントリスナーを削除
    document.removeEventListener('mousemove', onResizeMove);
    document.removeEventListener('mouseup', onResizeEnd);
    
    const bar = dragBarElement;
    const timeline = dragBarData.timeline;
    const rental = dragBarData.rental;
    const resizeMode = dragBarData.mode;
    
    // リサイズ中のスタイルを削除
    bar.classList.remove('resizing');
    
    // バーの位置とサイズを取得
    const barLeft = parseInt(bar.style.left, 10);
    const barWidth = parseInt(bar.style.width, 10);
    
    // セル幅を取得
    const cellWidth = userSettings.cellWidth || 80;
    
    // タイムラインの日付セルを取得
    const dateCells = Array.from(timeline.querySelectorAll('.gantt-day'));
    if (dateCells.length === 0) {
      // リセット
      isResizingBar = false;
      dragBarElement = null;
      dragBarData = null;
      return;
    }
    
    // 左端からのセルインデックスを計算
    const startCellIndex = Math.floor(barLeft / cellWidth);
    const endCellIndex = Math.floor((barLeft + barWidth - 1) / cellWidth);
    
    // インデックスが範囲内かチェック
    if (startCellIndex < 0 || startCellIndex >= dateCells.length || 
        endCellIndex < 0 || endCellIndex >= dateCells.length) {
      // 範囲外なので元に戻す
      if (dragBarOriginalPosition) {
        bar.style.left = `${dragBarOriginalPosition.left}px`;
        bar.style.width = `${dragBarOriginalPosition.width}px`;
      }
      
      // リセット
      isResizingBar = false;
      dragBarElement = null;
      dragBarData = null;
      return;
    }
    
    // 変更前の日付
    const originalStartDate = parseDate(rental['借用開始日']);
    const originalEndDate = parseDate(rental['借用終了日']);
    
    // 変更後の日付
    let newStartDate = null;
    let newEndDate = null;
    
    try {
      // 対応するセルから日付を取得
      const startCell = dateCells[startCellIndex];
      const endCell = dateCells[endCellIndex];
      
      if (startCell && endCell) {
        newStartDate = startCell.dataset.date;
        newEndDate = endCell.dataset.date;
      }
    } catch (error) {
      console.error('日付取得エラー:', error);
      
      // 元の位置に戻す
      if (dragBarOriginalPosition) {
        bar.style.left = `${dragBarOriginalPosition.left}px`;
        bar.style.width = `${dragBarOriginalPosition.width}px`;
      }
      
      // リセット
      isResizingBar = false;
      dragBarElement = null;
      dragBarData = null;
      return;
    }
    
    // リセット
    isResizingBar = false;
    dragBarElement = null;
    dragBarData = null;
    
    // 日付が変更されたかチェック
    const isStartDateChanged = formatDate(originalStartDate) !== newStartDate;
    const isEndDateChanged = formatDate(originalEndDate) !== newEndDate;
    
    if (!isStartDateChanged && !isEndDateChanged) {
      return; // 変更なし
    }
    
    // 確認ダイアログ
    if (userSettings.showConfirmDialog) {
      let message = '';
      if (resizeMode === 'resize-start') {
        message = `借用開始日を「${newStartDate}」に変更しますか？`;
      } else if (resizeMode === 'resize-end') {
        message = `借用終了日を「${newEndDate}」に変更しますか？`;
      }
      
      if (!confirm(message)) {
        // 元の位置に戻す
        if (dragBarOriginalPosition) {
          bar.style.left = `${dragBarOriginalPosition.left}px`;
          bar.style.width = `${dragBarOriginalPosition.width}px`;
        }
        return;
      }
    }
    
    // 貸出データ変更
    updateRentalDates(rental, newStartDate, newEndDate);
  }
  
  // ドラッグ移動時のハンドラ（グローバルイベント）
  function onDragMove(e) {
    if (!isDraggingBar || !dragBarElement || !dragBarData) return;
    e.preventDefault();
    
    const bar = dragBarElement;
    const startX = dragBarData.startX;
    const startLeft = dragBarData.startLeft;
    const timeline = dragBarData.timeline;
    
    // マウス移動量
    const deltaX = e.clientX - startX;
    
    // セル幅を取得
    const cellWidth = userSettings.cellWidth || 80;
    
    // グリッドにスナップするためのステップ計算
    const step = cellWidth;
    
    // 新しい左位置
    const newLeft = startLeft + Math.round(deltaX / step) * step;
    
    // 範囲チェック
    const timelineWidth = timeline.scrollWidth;
    const barWidth = parseInt(bar.style.width, 10);
    
    if (newLeft < 0) {
      bar.style.left = '0px';
    } else if (newLeft + barWidth > timelineWidth) {
      bar.style.left = `${timelineWidth - barWidth}px`;
    } else {
      bar.style.left = `${newLeft}px`;
    }
  }
  
  // ドラッグ終了時のハンドラ
  function onDragEnd(e) {
    if (!isDraggingBar || !dragBarElement || !dragBarData) return;
    e.preventDefault();
    
    // グローバルイベントリスナーを削除
    document.removeEventListener('mousemove', onDragMove);
    document.removeEventListener('mouseup', onDragEnd);
    
    const bar = dragBarElement;
    const timeline = dragBarData.timeline;
    const rental = dragBarData.rental;
    
    // ドラッグ中のスタイルを削除
    bar.classList.remove('dragging');
    
    // バーの位置とサイズを取得
    const barLeft = parseInt(bar.style.left, 10);
    const barWidth = parseInt(bar.style.width, 10);
    
    // セル幅を取得
    const cellWidth = userSettings.cellWidth || 80;
    
    // タイムラインの日付セルを取得
    const dateCells = Array.from(timeline.querySelectorAll('.gantt-day'));
    if (dateCells.length === 0) {
      // リセット
      isDraggingBar = false;
      dragBarElement = null;
      dragBarData = null;
      return;
    }
    
    // 左端からのセルインデックスを計算
    const startCellIndex = Math.floor(barLeft / cellWidth);
    const endCellIndex = Math.floor((barLeft + barWidth - 1) / cellWidth);
    
    // インデックスが範囲内かチェック
    if (startCellIndex < 0 || startCellIndex >= dateCells.length || 
        endCellIndex < 0 || endCellIndex >= dateCells.length) {
      // 範囲外なので元に戻す
      if (dragBarOriginalPosition) {
        bar.style.left = `${dragBarOriginalPosition.left}px`;
        bar.style.width = `${dragBarOriginalPosition.width}px`;
      }
      
      // リセット
      isDraggingBar = false;
      dragBarElement = null;
      dragBarData = null;
      return;
    }
    
    // 変更前の日付
    const originalStartDate = parseDate(rental['借用開始日']);
    
    // 変更後の日付
    let newStartDate = null;
    let newEndDate = null;
    
    try {
      // 対応するセルから日付を取得
      const startCell = dateCells[startCellIndex];
      const endCell = dateCells[endCellIndex];
      
      if (startCell && endCell) {
        newStartDate = startCell.dataset.date;
        newEndDate = endCell.dataset.date;
      }
    } catch (error) {
      console.error('日付取得エラー:', error);
      
      // 元の位置に戻す
      if (dragBarOriginalPosition) {
        bar.style.left = `${dragBarOriginalPosition.left}px`;
        bar.style.width = `${dragBarOriginalPosition.width}px`;
      }
      
      // リセット
      isDraggingBar = false;
      dragBarElement = null;
      dragBarData = null;
      return;
    }
    
    // リセット
    isDraggingBar = false;
    dragBarElement = null;
    dragBarData = null;
    
    // 開始日が変更されたかチェック
    if (formatDate(originalStartDate) === newStartDate) {
      return; // 変更なし
    }
    
    // 確認ダイアログ
    if (userSettings.showConfirmDialog) {
      const message = `借用期間を「${newStartDate}」から「${newEndDate}」に変更しますか？`;
      if (!confirm(message)) {
        // 元の位置に戻す
        if (dragBarOriginalPosition) {
          bar.style.left = `${dragBarOriginalPosition.left}px`;
          bar.style.width = `${dragBarOriginalPosition.width}px`;
        }
        return;
      }
    }
    
    // 貸出データ変更
    updateRentalDates(rental, newStartDate, newEndDate);
  }
  
  // 貸出日付を更新
  function updateRentalDates(rental, newStartDate, newEndDate) {
    try {
      // データ準備
      const data = {
        rentalId: rental['登録日時'] ? rental['登録日時'].toString() : '',
        startDate: newStartDate,
        endDate: newEndDate
      };
      
      if (!data.rentalId) {
        console.error('貸出IDがありません');
        return;
      }
      
      // 位置情報を保存
      saveScrollPosition();
      
      // 保存API実行
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          if (response && response.success) {
            // 成功処理
            console.log('日付更新成功:', response);
            
            // Undoスタック追加
            undoStack.push({
              action: 'undoRentalDates',
              id: rental['登録日時'].toString(),
              oldStartDate: formatDate(rental['借用開始日']),
              oldEndDate: formatDate(rental['借用終了日'])
            });
            
            // Undoボタン有効化
            const undoButton = document.getElementById('undo-button');
            if (undoButton) undoButton.disabled = false;
            
            // データ再読み込み
            getRentalData();
          } else {
            // 失敗処理
            hideLoading();
            console.error('日付更新失敗:', response);
            alert('更新に失敗しました: ' + (response ? response.error : '不明なエラー'));
            updateGanttChart();
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('日付更新エラー:', error);
          alert('更新に失敗しました: ' + error);
          updateGanttChart();
        })
        .updateRentalDates(data);
    } catch (error) {
      console.error('貸出日付更新エラー:', error);
      alert('貸出日付更新でエラーが発生しました: ' + error);
    }
  }
  
  // 現在の選択状態を保存
  function saveCurrentSelection() {
    if (selectedEquipmentWithLocation) {
      localStorage.setItem('lastSelectedEquipment', selectedEquipmentWithLocation);
    }
  }

  // 前回の選択状態を復元
  function restoreLastSelection() {
    const lastSelected = localStorage.getItem('lastSelectedEquipment');
    
    if (lastSelected) {
      // セレクトボックスの値を設定
      const selectBox = document.getElementById('equipment-select');
      if (selectBox) {
        // オプションが存在するか確認
        const options = Array.from(selectBox.options);
        const found = options.some(option => option.value === lastSelected);
        
        if (found) {
          selectBox.value = lastSelected;
          selectedEquipmentWithLocation = lastSelected;
          
          // 機器管理番号を取得
          const parts = lastSelected.split('|');
          selectedEquipment = parts[0];
          
          // Materializeのセレクトを更新
          try {
            M.FormSelect.init(selectBox);
          } catch (e) {
            console.error('セレクト初期化エラー:', e);
          }
        } else {
          // 前回の選択が見つからない場合は、機材名順で最初の機材を選択
          selectFirstEquipmentByName();
        }
      }
    } else {
      // localStorage に記録がない場合は、機材名順で最初の機材を選択
      selectFirstEquipmentByName();
    }
  }
  
  // 機材名順で最初の機材を選択する関数
  function selectFirstEquipmentByName() {
    if (equipmentList.length === 0) return;
    
    // 機材を機材名でソート
    const sortedEquipment = [...equipmentList].sort((a, b) => {
      if (!a['機器名称']) return 1;
      if (!b['機器名称']) return -1;
      return String(a['機器名称']).localeCompare(String(b['機器名称']), 'ja');
    });
    
    // 最初の機材を選択
    const firstEquipment = sortedEquipment[0];
    if (firstEquipment && firstEquipment['機器管理番号']) {
      selectedEquipment = firstEquipment['機器管理番号'];
      selectedEquipmentWithLocation = `${firstEquipment['機器管理番号']}|${firstEquipment['定置場所'] || ''}`;
      
      // セレクトボックスの値も更新
      const selectBox = document.getElementById('equipment-select');
      if (selectBox) {
        selectBox.value = selectedEquipmentWithLocation;
        // Materializeのセレクトを更新
        try {
          M.FormSelect.init(selectBox);
        } catch (e) {
          console.error('セレクト初期化エラー:', e);
        }
      }
    }
  }

  // 日付パース関数（文字列またはDate型からDateオブジェクトを返す）
  function parseDate(dateInput) {
    if (!dateInput) return null;
    
    // すでにDateオブジェクトなら変換不要
    if (dateInput instanceof Date) {
      return new Date(dateInput);
    }
    
    // 文字列の場合
    if (typeof dateInput === 'string') {
      // yyyy-MM-dd または yyyy/MM/dd 形式を想定
      const date = new Date(dateInput);
      if (!isNaN(date.getTime())) {
        return date;
      }
      
      // フォーマットを明示的に処理
      const parts = dateInput.split(/[-\/]/);
      if (parts.length === 3) {
        // 年月日の順番を判断
        let year, month, day;
        
        if (parts[0].length === 4) {
          // yyyy-MM-dd形式
          year = parseInt(parts[0]);
          month = parseInt(parts[1]) - 1; // 月は0始まり
          day = parseInt(parts[2]);
        } else {
          // MM/dd/yyyy形式かもしれない
          month = parseInt(parts[0]) - 1;
          day = parseInt(parts[1]);
          year = parseInt(parts[2]);
        }
        
        const newDate = new Date(year, month, day);
        if (!isNaN(newDate.getTime())) {
          return newDate;
        }
      }
    }
    
    console.warn('不正な日付形式:', dateInput);
    return null;
  }
  
  // タイムラインドラッグ処理
  function onTimelineMouseDown(e) {
    // レンタルバーなら無視
    if (e.target.classList.contains('rental-bar') || e.target.closest('.rental-bar')) return;
    
    // 右クリックは無視
    if (e.button !== 0) return;
    
    e.preventDefault();
    e.stopPropagation(); // イベント伝播を止める
    
    // クリックした要素がタイムラインかセルか
    let targetCell = e.target;
    const timeline = e.currentTarget;
    
    // ドラッグされた列の機器管理番号と定置場所を取得
    const timelineEquipmentId = timeline.dataset.equipment;
    const timelineLocation = timeline.dataset.location || '';
    
    if (!timelineEquipmentId) {
      console.error('タイムラインに機器管理番号情報がありません');
      return;
    }
    
    // タイムラインをクリックした場合は近いセルを特定
    if (!targetCell.classList.contains('gantt-day')) {
      const cells = Array.from(timeline.querySelectorAll('.gantt-day'));
      if (cells.length === 0) return;
      
      // セル幅を取得
      const cellWidth = userSettings.cellWidth || 80;
      
      const timelineRect = timeline.getBoundingClientRect();
      const x = Math.max(0, e.clientX - timelineRect.left);
      const cellIndex = Math.floor(x / cellWidth);
      
      if (cellIndex >= 0 && cellIndex < cells.length) {
        targetCell = cells[cellIndex];
      } else {
        return;
      }
    }
    
    // セルから日付情報取得
    const startDate = targetCell.dataset.date;
    
    if (!startDate) {
      console.error('セルのデータ属性がありません', targetCell);
      return;
    }
    
    // ドラッグ開始
    isDragging = true;
    dragStartCell = targetCell;
    
    // ハイライト表示
    targetCell.classList.add('drag-highlight');
    
    // 全セル取得
    const cells = Array.from(timeline.querySelectorAll('.gantt-day'));
    const startIndex = cells.indexOf(targetCell);
    
    console.log(`ドラッグ開始: セル${startIndex}, 日付=${startDate}, 機器=${timelineEquipmentId}, 定置場所=${timelineLocation}`);
    
    // マウス移動イベント
    function onMouseMove(moveEvent) {
      moveEvent.preventDefault();
      if (!isDragging) return;
      
      // マウス位置を計算
      const rect = timeline.getBoundingClientRect();
      const x = Math.max(0, Math.min(moveEvent.clientX - rect.left, rect.width));
      
      // セル幅を取得
      const cellWidth = userSettings.cellWidth || 80;
      
      const cellIndex = Math.min(Math.max(0, Math.floor(x / cellWidth)), cells.length - 1);
      
      // ハイライトクリア
      cells.forEach(cell => cell.classList.remove('drag-highlight'));
      
      // 範囲ハイライト
      const minIdx = Math.min(startIndex, cellIndex);
      const maxIdx = Math.max(startIndex, cellIndex);
      
      for (let i = minIdx; i <= maxIdx; i++) {
        cells[i].classList.add('drag-highlight');
      }
    }
    
    // マウスアップイベント
    function onMouseUp(upEvent) {
      upEvent.preventDefault();
      
      // イベント削除
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
      
      if (!isDragging) return;
      
      // マウス位置を計算
      const rect = timeline.getBoundingClientRect();
      const x = Math.max(0, Math.min(upEvent.clientX - rect.left, rect.width));
      
      // セル幅を取得
      const cellWidth = userSettings.cellWidth || 80;
      
      const cellIndex = Math.min(Math.max(0, Math.floor(x / cellWidth)), cells.length - 1);
      
      // 選択範囲の日付を取得
      const minIdx = Math.min(startIndex, cellIndex);
      const maxIdx = Math.max(startIndex, cellIndex);
      
      const fromDate = cells[minIdx].dataset.date;
      const toDate = cells[maxIdx].dataset.date;
      
      console.log(`ドラッグ終了: 開始=${fromDate}, 終了=${toDate}, 機器=${timelineEquipmentId}, 定置場所=${timelineLocation}`);
      
      // ハイライトクリア
      cells.forEach(cell => cell.classList.remove('drag-highlight'));
      
      // ドラッグリセット
      isDragging = false;
      dragStartCell = null;
      
      // 貸出モーダル表示 - ドラッグした列の機器情報を渡す
      showRentalModal(timelineEquipmentId, fromDate, toDate, timelineLocation);
    }
    
    // イベント追加
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }

  // 貸出モーダル表示の修正
	function showRentalModal(equipmentId, startDateStr, endDateStr, location) {
    try {
      console.log('貸出モーダル表示:', equipmentId, startDateStr, endDateStr, '定置場所:', location);
      
      // 既に開いているモーダルをすべて閉じる
      closeAllModals();
      
      // ドラッグされた列の機器と定置場所の情報を取得
      let equipment = null;
      
      // 指定された機器ID + 定置場所で機材を検索
      equipment = equipmentList.find(item => 
        String(item['機器管理番号']) === String(equipmentId) && 
        String(item['定置場所'] || '') === String(location || '')
      );
      
      // 見つからなければ機器IDだけで検索
      if (!equipment) {
        equipment = equipmentList.find(item => 
          String(item['機器管理番号']) === String(equipmentId)
        );
      }
      
      if (!equipment) {
        alert(`機材情報の取得に失敗しました。\n機器管理番号: ${equipmentId}\n定置場所: ${location || '未設定'}`);
        return;
      }
      
      // モーダル要素の取得
      const modal = document.getElementById('rental-modal');
      if (!modal) {
        alert('モーダル要素が見つかりません');
        return;
      }
      
      // フォーム要素の取得
      const equipmentField = document.getElementById('rental-equipment');
      const startDateField = document.getElementById('rental-start');
      const endDateField = document.getElementById('rental-end');
      const quantityField = document.getElementById('rental-quantity');
      const projectSelect = document.getElementById('rental-project');
      const newProjectField = document.getElementById('new-project');
      const sourceLocationField = document.getElementById('rental-source-location');
      
      if (!equipmentField || !startDateField || !endDateField || !quantityField || 
          !projectSelect || !newProjectField || !sourceLocationField) {
        alert('フォーム要素が見つかりません');
        return;
      }
      
      // 機材名称の設定 - 機材名と管理番号を表示
      equipmentField.value = `${equipment['機器名称']} (${equipment['機器管理番号']})`;
      
      // 借用開始日と終了日の設定
      startDateField.value = startDateStr;
      endDateField.value = endDateStr;
      
      // 数量の初期値を1に設定
      quantityField.value = 1;
      
      // 新しい現場名入力欄をクリア（追加）
      newProjectField.value = '';
      
      // 貸出元（定置場所）の設定
      sourceLocationField.value = location || '';
      
      // 現場マスターのリストをドロップダウンに設定
      projectSelect.innerHTML = '<option value="" disabled selected>現場を選択</option>';
      if (projectsList && projectsList.length > 0) {
        // 現場をあいうえお順にソート
        const sortedProjects = [...projectsList].sort((a, b) => 
          String(a.name || '').localeCompare(String(b.name || ''), 'ja')
        );
        
        // 選択肢を追加
        sortedProjects.forEach(project => {
          if (!project.name) return;
          
          const option = document.createElement('option');
          option.value = project.name;
          option.textContent = project.name;
          projectSelect.appendChild(option);
        });
      }
      
      // ラベルを浮かせる（Materialize CSS）
      M.updateTextFields();
      
      // モーダル表示
      const instance = M.Modal.getInstance(modal);
      if (instance) {
        instance.open();
      } else {
        const modalOptions = {
          dismissible: true,
          opacity: 0.5,
          inDuration: 300,
          outDuration: 200,
          preventScrolling: true
        };
        M.Modal.init(modal, modalOptions).open();
      }
    } catch (error) {
      console.error('貸出モーダル表示エラー:', error);
      alert('貸出モーダル表示中にエラーが発生しました: ' + error);
    }
    // モーダル表示後に日付ピッカーを初期化
    setTimeout(() => {
      setupDatePickers();
    }, 100);
    // モーダル表示後に数量コントロールを設定
    setTimeout(() => {
      setupQuantityControls();
    }, 100);
  }
  
  // 返却モーダル表示の修正
	function showReturnModal(rental) {
	  try {
	    console.log('返却モーダル表示:', rental['機器管理番号'], 'Rental ID:', rental['登録日時']?.toString());
	    
	    // 既に開いているモーダルをすべて閉じる
	    closeAllModals();
	    
	    // 貸出データを詳細ログ出力
	    console.log('Rental data for return:', JSON.stringify(rental));
	    
	    // 機材情報取得
	    const equipment = equipmentList.find(item => 
	      String(item['機器管理番号']) === String(rental['機器管理番号'])
	    );
	    
	    if (!equipment) {
	      alert('機材情報の取得に失敗しました');
	      return;
	    }
	    
	    // 返却モーダルの要素取得と設定
	    const modal = document.getElementById('return-modal');
	    if (!modal) {
	      alert('返却モーダル要素が見つかりません');
	      return;
	    }
	    
	    // フォーム要素取得
	    const equipmentField = document.getElementById('return-equipment');
	    const returnDateField = document.getElementById('return-date');
	    const quantitySelect = document.getElementById('return-quantity');
	    
	    if (!equipmentField || !returnDateField || !quantitySelect) {
	      alert('フォーム要素が見つかりません');
	      return;
	    }
	    
	    // 機材情報の設定
	    equipmentField.value = `${equipment['機器名称']} (${rental['機器管理番号']})`;
	    
	    // 返却日に本日の日付を設定
	    const today = new Date();
	    returnDateField.value = formatDate(today);
	    
	    // 選択肢をクリア
	    quantitySelect.innerHTML = '';
	    
	    // 数量の選択肢を追加
	    const maxQuantity = parseInt(rental['数量']) || 1;
	    for (let i = 1; i <= maxQuantity; i++) {
	      const option = document.createElement('option');
	      option.value = i;
	      option.textContent = `${i}台`;
	      quantitySelect.appendChild(option);
	    }
	    
	    // 初期値を設定
	    quantitySelect.value = maxQuantity;
	    
	    // ラベルを浮かせる（Materialize CSS）
	    M.updateTextFields();
	    
	    // 貸出元（定置場所）の情報を保存
	    const sourceLocation = rental['貸出元'] || '';
	    
	    // 保存ボタンにデータ属性を設定
	    const saveReturnBtn = document.getElementById('save-return');
	    if (saveReturnBtn) {
	      saveReturnBtn.dataset.rentalId = rental['登録日時'] ? rental['登録日時'].toString() : '';
	      saveReturnBtn.dataset.sourceLocation = sourceLocation;
	    }
	    
	    // 返却モーダルを表示
	    try {
	      // 既存のインスタンスを取得または新規作成
	      let instance = M.Modal.getInstance(modal);
	      if (!instance) {
	        const modalOptions = {
	          dismissible: true,
	          opacity: 0.5,
	          inDuration: 300,
	          outDuration: 200,
	          preventScrolling: true
	        };
	        instance = M.Modal.init(modal, modalOptions);
	      }
	      instance.open();
	    } catch (error) {
	      console.error('返却モーダル表示エラー:', error);
	      alert('モーダルの表示に失敗しました: ' + error);
	    }
	  } catch (error) {
	    console.error('返却モーダル表示エラー:', error);
	    alert('返却モーダルの表示中にエラーが発生しました: ' + error);
	  }
	  // モーダル表示後に日付ピッカーを初期化
	  setTimeout(() => {
	    setupDatePickers();
	  }, 100);
	}
  
  // 貸出保存関数
  function saveRental() {
    try {
      console.log('貸出登録開始');
      
      // フォーム要素取得
      const equipmentField = document.getElementById('rental-equipment');
      const startDateField = document.getElementById('rental-start');
      const endDateField = document.getElementById('rental-end');
      const quantityField = document.getElementById('rental-quantity');
      const projectSelect = document.getElementById('rental-project');
      const newProjectField = document.getElementById('new-project');
      const sourceLocationField = document.getElementById('rental-source-location');
      
      if (!equipmentField || !startDateField || !endDateField || !quantityField || 
          !projectSelect || !newProjectField || !sourceLocationField) {alert('フォーム要素が見つかりません');
        return;
      }
      
      // 機材ID抽出
      const equipmentValue = equipmentField.value;
      let equipmentId = '';
      
      // 括弧内の文字列を抽出する安全な方法
      const lastOpenBracket = equipmentValue.lastIndexOf('(');
      const lastCloseBracket = equipmentValue.lastIndexOf(')');
      
      if (lastOpenBracket !== -1 && lastCloseBracket !== -1 && lastOpenBracket < lastCloseBracket) {
        equipmentId = equipmentValue.substring(lastOpenBracket + 1, lastCloseBracket).trim();
      } else {
        alert('機材情報の形式が不正です');
        return;
      }
      
      const startDate = startDateField.value;
      const endDate = endDateField.value;
      const quantity = parseInt(quantityField.value);
      const sourceLocation = sourceLocationField.value;
      
      // 現場の取得（選択または新規入力）
      let project = projectSelect.value;
      const newProject = newProjectField.value.trim();
      
      if (newProject !== '') {
        project = newProject;
      }
      
      // バリデーション
      if (!startDate || !endDate) {
        alert('日付を入力してください');
        return;
      }
      
      if (!quantity || isNaN(quantity) || quantity <= 0) {
        alert('有効な数量を入力してください');
        return;
      }
      
      if (!project) {
        alert('現場名を選択または入力してください');
        return;
      }
      
      if (new Date(startDate) > new Date(endDate)) {
        alert('借用開始日は借用終了日より前にしてください');
        return;
      }
      
      // 機材情報取得（選択された定置場所との組み合わせで）
      const equipment = equipmentList.find(item => 
        String(item['機器管理番号']) === String(equipmentId) && 
        String(item['定置場所'] || '') === String(sourceLocation)
      );
      
      if (!equipment) {
        alert(`機材情報の取得に失敗しました。\n機器管理番号: ${equipmentId}\n定置場所: ${sourceLocation}`);
        return;
      }
      
      // 総台数チェック
      const totalQuantity = parseInt(equipment['総台数']) || 0;
      
      if (quantity > totalQuantity) {
        alert(`この定置場所の在庫は${totalQuantity}台です。\n数量は1～${totalQuantity}の間で入力してください。`);
        return;
      }
      
      // 貸出可能チェック（定置場所を考慮）
      if (!checkAvailability(equipmentId, sourceLocation, startDate, endDate, quantity)) {
        return;
      }
      
      // スクロール位置を保存
      saveScrollPosition();
      
      // データ準備
      const data = {
        equipmentId: equipmentId,
        equipmentName: equipment['機器名称'],
        startDate: startDate,
        endDate: endDate,
        quantity: quantity,
        project: project,
        sourceLocation: sourceLocation // 貸出元の定置場所
      };
      
      console.log('送信データ:', data);
      
      // 登録前にモーダルを閉じる
      try {
        const modal = document.getElementById('rental-modal');
        const instance = M.Modal.getInstance(modal);
        if (instance) instance.close();
      } catch (error) {
        console.error('モーダル閉じるエラー:', error);
      }
      
      // 保存API実行
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();
          
          if (response && response.success) {
            // 成功処理
            console.log('保存成功:', response);
            
            // Undoスタック追加
            undoStack.push({
              action: 'deleteRental',
              id: response.id
            });
            
            // Undoボタン有効化
            const undoButton = document.getElementById('undo-button');
            if (undoButton) undoButton.disabled = false;
            
            // 現場リスト再取得（新しい現場が追加された可能性あり）
            getProjectsList();
            
            // 成功メッセージ
            alert('貸出を登録しました');
          } else {
            // 失敗処理
            console.error('保存失敗:', response);
            alert('貸出登録に失敗しました: ' + (response ? response.error : '不明なエラー'));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('保存エラー:', error);
          alert('貸出登録に失敗しました: ' + error);
        })
        .saveRental(data);
    } catch (error) {
      console.error('貸出保存エラー:', error);
      alert('貸出保存処理でエラーが発生しました: ' + error);
    }
  }
  
  // 返却保存関数
  function saveReturn() {
    try {
      console.log('返却登録開始');
      
      // 保存ボタンからID取得
      const saveReturnBtn = document.getElementById('save-return');
      if (!saveReturnBtn) {
        alert('返却ボタンが見つかりません');
        return;
      }
      
      // データ属性とHTML属性の両方から取得を試みる
      let rentalId = saveReturnBtn.dataset.rentalId || saveReturnBtn.getAttribute('data-rental-id');
      
      console.log('Button rental ID:', rentalId);
      
      if (!rentalId) {
        alert('返却データのIDが取得できません');
        return;
      }
      
      const sourceLocation = saveReturnBtn.dataset.sourceLocation || saveReturnBtn.getAttribute('data-source-location') || '';
      
      // フォーム要素取得
      const returnDateField = document.getElementById('return-date');
      const quantitySelect = document.getElementById('return-quantity');
      
      if (!returnDateField || !quantitySelect) {
        alert('フォーム要素が見つかりません');
        return;
      }
      
      const returnDate = returnDateField.value;
      const returnQuantity = parseInt(quantitySelect.value) || 0;
      
      // バリデーション
      if (!returnDate) {
        alert('返却日を入力してください');
        return;
      }
      
      if (returnQuantity <= 0) {
        alert('返却台数を選択してください');
        return;
      }
      
      // 該当の貸出データが存在するか確認
      let rental = rentalData.find(item => item['登録日時'] && item['登録日時'].toString() === rentalId);
      
      // 完全一致しない場合は部分一致で検索
      if (!rental) {
        console.log('完全一致する貸出データが見つかりません。部分一致で検索します。');
        
        rental = rentalData.find(item => {
          if (!item['登録日時']) return false;
          
          const itemId = item['登録日時'].toString();
          return itemId.includes(rentalId) || rentalId.includes(itemId);
        });
      }
      
      if (!rental) {
        alert('該当する貸出データが見つかりません。画面をリロードして再試行してください。');
        
        // デバッグ情報を表示
        console.log('Rental ID:', rentalId);
        console.log('Available rental data:', rentalData);
        
        return;
      }
      
      // スクロール位置を保存
      saveScrollPosition();
      
      // データ準備
      const data = {
        rentalId: rental['登録日時'].toString(), // 確実に見つかった貸出の正しいIDを使用
        returnDate: returnDate,
        returnQuantity: returnQuantity,
        returnLocation: sourceLocation  // 貸出元と同じ場所に返却
      };
      
      console.log('送信データ:', data);
      
      // 登録前にモーダルを閉じる
      try {
        const modal = document.getElementById('return-modal');
        const instance = M.Modal.getInstance(modal);
        if (instance) instance.close();
      } catch (error) {
        console.error('モーダル閉じるエラー:', error);
      }
      
      // 保存API実行
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          if (response && response.success) {
            // 成功処理
            console.log('保存成功:', response);
            
            // Undoスタック追加
            undoStack.push({
              action: 'undoReturn',
              id: rental['登録日時'].toString() // 確実に正しいIDを使用
            });
            
            // Undoボタン有効化
            const undoButton = document.getElementById('undo-button');
            if (undoButton) undoButton.disabled = false;
            
            // データ再読み込み - 最新の貸出データを取得
            google.script.run
              .withSuccessHandler(function(rentalDataResponse) {
                hideLoading();
                
                if (rentalDataResponse && Array.isArray(rentalDataResponse)) {
                  // 日付文字列をDateオブジェクトに変換
                  const processedData = rentalDataResponse.map(item => {
                    // 各プロパティの型確認
                    Object.keys(item).forEach(key => {
                      if (key === '借用開始日' || key === '借用終了日' || key === '登録日時' || key === '返却日') {
                        if (item[key] && typeof item[key] === 'string') {
                          item[key] = new Date(item[key]);
                        }
                      }
                    });
                    
                    // ステータスが設定されていない場合、返却日に基づいて判定
                    if (!item['ステータス']) {
                      item['ステータス'] = item['返却日'] ? '返却済み' : '貸出中';
                    }
                    
                    return item;
                  });
                  
                  rentalData = processedData;
                  updateGanttChart();
                  
                  // 成功メッセージ
                  alert('返却を登録しました');
                } else {
                  rentalData = [];
                  updateGanttChart();
                  alert('返却を登録しましたが、データの再取得に失敗しました');
                }
              })
              .withFailureHandler(function(error) {
                hideLoading();
                console.error('貸出データ再取得失敗:', error);
                // エラー時も古いデータでチャートを更新
                updateGanttChart();
                alert('返却を登録しました');
              })
              .getRentalData();
          } else {
            // 失敗処理
            hideLoading();
            console.error('保存失敗:', response);
            alert('返却登録に失敗しました: ' + (response ? response.error : '不明なエラー'));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('保存エラー:', error);
          alert('返却登録に失敗しました: ' + error);
        })
        .saveReturn(data);
    } catch (error) {
      console.error('返却保存エラー:', error);
      alert('返却保存処理でエラーが発生しました: ' + error);
    }
  }
  
  // 貸出可能チェック
  function checkAvailability(equipmentId, sourceLocation, startDate, endDate, requestedQuantity) {
    try {
      // 機材情報取得（機器管理番号と定置場所で絞り込み）
      const equipment = equipmentList.find(item => 
        String(item['機器管理番号']) === String(equipmentId) && 
        String(item['定置場所'] || '') === String(sourceLocation)
      );
      
      if (!equipment) {
        alert(`機材情報の取得に失敗しました。\n機器管理番号: ${equipmentId}\n定置場所: ${sourceLocation}`);
        return false;
      }
      
      const totalQuantity = parseInt(equipment['総台数']) || 0;
      
      // 日付範囲
      const start = new Date(startDate);
      const end = new Date(endDate);
      
      // 各日にちで利用可能数チェック
      let currentDate = new Date(start);
      
      while (currentDate <= end) {
        const dateStr = formatDate(currentDate);
        let rentedQuantity = 0;
        
        // この日付で貸出中の数量を計算（該当の定置場所からの貸出のみ集計）
        rentalData.forEach(rental => {
          if (!rental) return;
          
          // この機材の貸出（同じ機器管理番号 AND 同じ貸出元）
          if (String(rental['機器管理番号']) === String(equipmentId) && 
              String(rental['貸出元'] || '') === String(sourceLocation)) {
              
            // ステータスが返却済みの場合はスキップ
            if (rental['ステータス'] === '返却済み') return;
            
            // 返却日がある場合も返却済みとみなしてスキップ
            if (rental['返却日'] && rental['ステータス'] === '返却済み') return;
            
            // 日付型変換
            let rentalStart = parseDate(rental['借用開始日']);
            let rentalEnd = parseDate(rental['借用終了日']);
            
            // 日付有効性チェック
            if (!rentalStart || !rentalEnd) {
              return;
            }
            
            // 日付範囲チェック
            if (rentalStart <= currentDate && rentalEnd >= currentDate) {
              rentedQuantity += parseInt(rental['数量']) || 0;
            }
          }
        });
        
        // 利用可能数チェック
        const availableQuantity = totalQuantity - rentedQuantity;
        
        if (requestedQuantity > availableQuantity) {
          alert(`${dateStr}には${availableQuantity}台しか利用できません。期間または数量を変更してください。`);
          return false;
        }
        
        // 次の日へ
        currentDate.setDate(currentDate.getDate() + 1);
      }
      
      return true;
    } catch (error) {
      console.error('貸出可能チェックエラー:', error);
      alert('貸出可能性のチェックに失敗しました: ' + error);
      return false;
    }
  }
  
  // Undo実行
  function executeUndo(action) {
    if (!action || !action.action || !action.id) {
      console.error('無効なUndo操作:', action);
      return;
    }
    
    showLoading();
    
    switch (action.action) {
      case 'deleteRental':
        google.script.run
          .withSuccessHandler(function(response) {
            hideLoading();
            
            if (response && response.success) {
              // データ再取得
              google.script.run
                .withSuccessHandler(function(rentalDataResponse) {
                  if (rentalDataResponse && Array.isArray(rentalDataResponse)) {
                    // 日付文字列をDateオブジェクトに変換して保存
                    rentalData = rentalDataResponse.map(item => {
                      Object.keys(item).forEach(key => {
                        if (key === '借用開始日' || key === '借用終了日' || key === '登録日時' || key === '返却日') {
                          if (item[key] && typeof item[key] === 'string') {
                            item[key] = new Date(item[key]);
                          }
                        }
                      });
                      
                      if (!item['ステータス']) {
                        item['ステータス'] = item['返却日'] ? '返却済み' : '貸出中';
                      }
                      
                      return item;
                    });
                  } else {
                    rentalData = [];
                  }
                  
                  updateGanttChart();
                })
                .withFailureHandler(function(error) {
                  console.error('貸出データ再取得失敗:', error);
                  updateGanttChart();
                })
                .getRentalData();
              
              alert('貸出登録を取り消しました');
            } else {
              alert('取消に失敗しました: ' + (response ? response.error : '不明なエラー'));
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            console.error('Undoエラー:', error);
            alert('取消に失敗しました: ' + error);
          })
          .deleteRental(action.id);
        break;
        
      case 'undoReturn':
        google.script.run
          .withSuccessHandler(function(response) {
            hideLoading();
            
            if (response && response.success) {
              // データ再取得
              google.script.run
                .withSuccessHandler(function(rentalDataResponse) {
                  if (rentalDataResponse && Array.isArray(rentalDataResponse)) {
                    // 日付文字列をDateオブジェクトに変換して保存
                    rentalData = rentalDataResponse.map(item => {
                      Object.keys(item).forEach(key => {
                        if (key === '借用開始日' || key === '借用終了日' || key === '登録日時' || key === '返却日') {
                          if (item[key] && typeof item[key] === 'string') {
                            item[key] = new Date(item[key]);
                          }
                        }
                      });
                      
                      if (!item['ステータス']) {
                        item['ステータス'] = item['返却日'] ? '返却済み' : '貸出中';
                      }
                      
                      return item;
                    });
                  } else {
                    rentalData = [];
                  }
                  
                  updateGanttChart();
                })
                .withFailureHandler(function(error) {
                  console.error('貸出データ再取得失敗:', error);
                  updateGanttChart();
                })
                .getRentalData();
              
              alert('返却を取り消しました');
            } else {
              alert('取消に失敗しました: ' + (response ? response.error : '不明なエラー'));
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            console.error('Undoエラー:', error);
            alert('取消に失敗しました: ' + error);
          })
          .undoReturn(action.id);
        break;
        
      default:
        hideLoading();
        console.error('不明なUndo操作:', action);
    }
  }
  
  // 日付フォーマット
  function formatDate(date, format = 'yyyy-MM-dd') {
    try {
      if (!date) return '';
      
      if (!(date instanceof Date)) {
        date = new Date(date);
      }
      
      if (isNaN(date.getTime())) {
        console.error('無効な日付:', date);
        return '';
      }
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      
      if (format === 'yyyy-MM-dd') {
        return `${year}-${month}-${day}`;
      } else if (format === 'MM/dd') {
        return `${month}/${day}`;
      }
      
      return `${year}-${month}-${day}`;
    } catch (error) {
      console.error('日付フォーマットエラー:', error);
      return '';
    }
  }
  
  // ローディング表示
  function showLoading() {
    try {
      const loading = document.getElementById('loading');
      if (loading) loading.classList.remove('hidden');
    } catch (error) {
      console.error('ローディング表示エラー:', error);
    }
  }
  
  // ローディング非表示
  function hideLoading() {
    try {
      const loading = document.getElementById('loading');
      if (loading) loading.classList.add('hidden');
    } catch (error) {
      console.error('ローディング非表示エラー:', error);
    }
  }
  
  // 現場マスター管理モーダルを開く
	function openProjectsModal() {
	  try {
	    console.log('現場マスター管理モーダル表示');
	    
	    // 現場リストが空の場合は先に取得する
	    if (!projectsList || projectsList.length === 0) {
	      showLoading();
	      google.script.run
	        .withSuccessHandler(function(data) {
	          hideLoading();
	          if (data && Array.isArray(data)) {
	            projectsList = data;
	          } else {
	            projectsList = [];
	          }
	          // 現場リストをテーブルに表示
	          updateProjectsTable();
	          showProjectsModal();
	        })
	        .withFailureHandler(function(error) {
	          hideLoading();
	          console.error('現場リスト取得エラー:', error);
	          projectsList = [];
	          updateProjectsTable();
	          showProjectsModal();
	        })
	        .getProjectsList();
	    } else {
	      // 現場リストをテーブルに表示
	      updateProjectsTable();
	      showProjectsModal();
	    }
	  } catch (error) {
	    console.error('現場マスター管理モーダル表示エラー:', error);
	  }
	}
	
  // モーダル表示部分を分離
	function showProjectsModal() {
	  // モーダル表示
	  const modal = document.getElementById('projects-modal');
	  if (!modal) {
	    alert('モーダル要素が見つかりません');
	    return;
	  }
	  
	  try {
	    // 既存のインスタンスを削除
	    const oldInstance = M.Modal.getInstance(modal);
	    if (oldInstance) {
	      oldInstance.destroy();
	    }
	    
	    // 新しいインスタンスを作成して開く
	    const modalOptions = {
	      dismissible: true,
	      opacity: 0.5,
	      inDuration: 300,
	      outDuration: 200,
	      preventScrolling: true
	    };
	    
	    setTimeout(() => {
	      const instance = M.Modal.init(modal, modalOptions);
	      instance.open();
	    }, 50);
	  } catch (error) {
	    console.error('現場マスターモーダル表示エラー:', error);
	    alert('モーダルの表示に失敗しました: ' + error);
	  }
	}
  
  // 現場リストをテーブルに表示
  function updateProjectsTable() {
    try {
      const tableBody = document.getElementById('projects-list');
      if (!tableBody) return;
      
      // 既存の行をクリア
      tableBody.innerHTML = '';
      
      if (!projectsList || projectsList.length === 0) {
        const emptyRow = document.createElement('tr');
        const emptyCell = document.createElement('td');
        emptyCell.colSpan = 3;
        emptyCell.textContent = '登録されている現場はありません';
        emptyCell.style.textAlign = 'center';
        emptyRow.appendChild(emptyCell);
        tableBody.appendChild(emptyRow);
        return;
      }
      
      // 現場をあいうえお順にソート
      const sortedProjects = [...projectsList].sort((a, b) => 
        String(a.name).localeCompare(String(b.name), 'ja')
      );
      
      // 現場の行を作成
      sortedProjects.forEach(project => {
        const row = document.createElement('tr');
        
        // チェックボックスセル
        const checkCell = document.createElement('td');
        const checkboxLabel = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `project-${project.id}`;
        checkbox.value = project.id;
        checkbox.className = 'project-checkbox';
        
        const checkboxSpan = document.createElement('span');
        
        checkboxLabel.appendChild(checkbox);
        checkboxLabel.appendChild(checkboxSpan);
        checkCell.appendChild(checkboxLabel);
        
        // 現場名セル
        const nameCell = document.createElement('td');
        nameCell.textContent = project.name;
        
        // 作成日セル
        const dateCell = document.createElement('td');
        dateCell.textContent = project.createdAt ? formatDate(new Date(project.createdAt)) : '-';
        
        // 行に追加
        row.appendChild(checkCell);
        row.appendChild(nameCell);
        row.appendChild(dateCell);
        
        // テーブルに追加
        tableBody.appendChild(row);
      });
    } catch (error) {
      console.error('現場テーブル更新エラー:', error);
    }
  }
  
  // 機器マスター管理モーダルを開く
  function openEquipmentModal() {
    try {
      console.log('機器マスター管理モーダル表示');
      
      // 定置場所リストをセットアップ
      setupLocationSelection();
      
      // 機材リストをテーブルに表示
      updateEquipmentTable();
      
      // モーダル表示
      const modal = document.getElementById('equipment-modal');
      if (!modal) {
        alert('モーダル要素が見つかりません');
        return;
      }
      
      try {
        // 既存のインスタンスを削除
        const oldInstance = M.Modal.getInstance(modal);
        if (oldInstance) {
          oldInstance.destroy();
        }
        
        // 新しいインスタンスを作成して開く
        const modalOptions = {
          dismissible: true,
          opacity: 0.5,
          inDuration: 300,
          outDuration: 200,
          preventScrolling: true
        };
        
        setTimeout(() => {
          // フォーム初期化
          document.getElementById('new-equipment-name')?.value = '';
          document.getElementById('new-equipment-spec')?.value = '';
          document.getElementById('new-equipment-model')?.value = '';
          document.getElementById('new-equipment-maker')?.value = '';
          document.getElementById('new-equipment-serial')?.value = '';
          document.getElementById('new-equipment-quantity')?.value = '1';
          document.getElementById('new-equipment-alias')?.value = '';
          
          // フィールドラベル更新
          M.updateTextFields();
          
          // モーダル表示
          const instance = M.Modal.init(modal, modalOptions);
          instance.open();
        }, 50);
      } catch (error) {
        console.error('機器マスターモーダル表示エラー:', error);
        alert('モーダルの表示に失敗しました: ' + error);
      }
    } catch (error) {
      console.error('機器マスター管理モーダル表示エラー:', error);
    }
  }
  
  // 定置場所選択リストのセットアップ
  function setupLocationSelection() {
    try {
      const locationSelect = document.getElementById('new-equipment-location');
      if (!locationSelect) return;
      
      // 選択肢をクリア
      locationSelect.innerHTML = '<option value="" selected>定置場所を選択</option>';
      
      // 定置場所が空なら取得
      if (!locationsList || locationsList.length === 0) {
        // 定置場所取得APIを呼び出す
        google.script.run
          .withSuccessHandler(function(data) {
            if (data && Array.isArray(data)) {
              locationsList = data;
              populateLocationOptions(locationSelect);
            }
          })
          .withFailureHandler(function(error) {
            console.error('定置場所取得エラー:', error);
          })
          .getLocationsList();
      } else {
        // 既存のリストを使用
        populateLocationOptions(locationSelect);
      }
    } catch (error) {
      console.error('定置場所選択設定エラー:', error);
    }
  }
  
  // 定置場所オプションを埋める
  function populateLocationOptions(selectElement) {
    if (!selectElement || !locationsList) return;
    
    // あいうえお順にソート
    const sortedLocations = [...locationsList].sort((a, b) => 
      String(a.name || '').localeCompare(String(b.name || ''), 'ja')
    );
    
    // 選択肢を追加
    sortedLocations.forEach(location => {
      if (!location.name) return;
      
      const option = document.createElement('option');
      option.value = location.name;
      option.textContent = location.name;
      selectElement.appendChild(option);
    });
  }
  
  // 機材リストをテーブルに表示
  function updateEquipmentTable() {
    try {
      const tableBody = document.getElementById('equipment-list');
      if (!tableBody) return;
      
      // 既存の行をクリア
      tableBody.innerHTML = '';
      
      if (!equipmentList || equipmentList.length === 0) {
        const emptyRow = document.createElement('tr');
        const emptyCell = document.createElement('td');
        emptyCell.colSpan = 5;
        emptyCell.textContent = '登録されている機材はありません';
        emptyCell.style.textAlign = 'center';
        emptyRow.appendChild(emptyCell);
        tableBody.appendChild(emptyRow);
        return;
      }
      
      // 機材をあいうえお順にソート
      const sortedEquipment = [...equipmentList].sort((a, b) => {
        if (!a['機器名称']) return 1;
        if (!b['機器名称']) return -1;
        return String(a['機器名称']).localeCompare(String(b['機器名称']), 'ja');
      });
      
      // 機材の行を作成（機器管理番号+定置場所ごとに）
      sortedEquipment.forEach(equipment => {
        const row = document.createElement('tr');
        
        // チェックボックスセル
        const checkCell = document.createElement('td');
        const checkboxLabel = document.createElement('label');
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `equipment-${equipment['機器管理番号']}-${equipment['定置場所'] || 'none'}`;
        checkbox.value = JSON.stringify({
          id: equipment['機器管理番号'],
          location: equipment['定置場所'] || ''
        });
        checkbox.className = 'equipment-checkbox';
        
        const checkboxSpan = document.createElement('span');
        
        checkboxLabel.appendChild(checkbox);
        checkboxLabel.appendChild(checkboxSpan);
        checkCell.appendChild(checkboxLabel);
        
        // 管理番号セル
        const idCell = document.createElement('td');
        idCell.textContent = equipment['機器管理番号'] || '';
        
        // 機材名セル
        const nameCell = document.createElement('td');
        nameCell.textContent = equipment['機器名称'] || '';
        
        // 型番セル
        const modelCell = document.createElement('td');
        modelCell.textContent = equipment['型番'] || '';
        
        // 台数セル
        const quantityCell = document.createElement('td');
        quantityCell.textContent = equipment['総台数'] || '0';
        quantityCell.style.textAlign = 'right';
        
        // 行に追加
        row.appendChild(checkCell);
        row.appendChild(idCell);
        row.appendChild(nameCell);
        row.appendChild(modelCell);
        row.appendChild(quantityCell);
        
        // テーブルに追加
        tableBody.appendChild(row);
      });
    } catch (error) {
      console.error('機材テーブル更新エラー:', error);
    }
  }
  
  // 現場追加関数
  function addProject() {
    try {
      const projectNameInput = document.getElementById('new-project-name');
      if (!projectNameInput) {
        alert('入力欄が見つかりません');
        return;
      }
      
      const projectName = projectNameInput.value.trim();
      if (!projectName) {
        alert('現場名を入力してください');
        return;
      }
      
      // 同名の現場がないかチェック
      const existingProject = projectsList.find(project => 
        project.name.toLowerCase() === projectName.toLowerCase()
      );
      
      if (existingProject) {
        alert('その現場名は既に登録されています');
        return;
      }
      
      // データ準備
      const data = {
        name: projectName
      };
      
      // 保存API実行
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();
          
          if (response && response.success) {
            // 成功処理
            projectNameInput.value = ''; // 入力欄をクリア
            
            // 現場リスト再取得
            google.script.run
              .withSuccessHandler(function(data) {
                if (data && Array.isArray(data)) {
                  projectsList = data;
                  updateProjectsTable();
                }
              })
              .withFailureHandler(function(error) {
                console.error('現場リスト再取得エラー:', error);
              })
              .getProjectsList();
            
            alert('現場を追加しました');
          } else {
            // 失敗処理
            alert('現場追加に失敗しました: ' + (response ? response.error : '不明なエラー'));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('現場追加エラー:', error);
          alert('現場追加に失敗しました: ' + error);
        })
        .addProject(data);
    } catch (error) {
      console.error('現場追加処理エラー:', error);
      alert('現場追加処理でエラーが発生しました: ' + error);
    }
  }
  
  // 現場削除関数
  function deleteProjects() {
    try {
      // チェックされた現場を取得
      const checkboxes = document.querySelectorAll('.project-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('削除する現場を選択してください');
        return;
      }
      
      // 確認ダイアログ
      if (!confirm(`選択した${checkboxes.length}件の現場を削除しますか？`)) {
        return;
      }
      
      // 削除対象IDを取得
      const projectIds = Array.from(checkboxes).map(checkbox => checkbox.value);
      
      // 削除API実行
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();
          
          if (response && response.success) {
            // 成功処理
            
            // 現場リスト再取得
            google.script.run
              .withSuccessHandler(function(data) {
                if (data && Array.isArray(data)) {
                  projectsList = data;
                  updateProjectsTable();
                }
              })
              .withFailureHandler(function(error) {
                console.error('現場リスト再取得エラー:', error);
              })
              .getProjectsList();
            
            alert(`${response.deletedCount}件の現場を削除しました`);
          } else {
            // 失敗処理
            alert('現場削除に失敗しました: ' + (response ? response.error : '不明なエラー'));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('現場削除エラー:', error);
          alert('現場削除に失敗しました: ' + error);
        })
        .deleteProjects(projectIds);
    } catch (error) {
      console.error('現場削除処理エラー:', error);
      alert('現場削除処理でエラーが発生しました: ' + error);
    }
  }
  
  // 機材追加関数
  function addEquipment() {
    try {
      // 入力値取得
      const nameInput = document.getElementById('new-equipment-name');
      const specInput = document.getElementById('new-equipment-spec');
      const modelInput = document.getElementById('new-equipment-model');
      const makerInput = document.getElementById('new-equipment-maker');
      const serialInput = document.getElementById('new-equipment-serial');
      const quantityInput = document.getElementById('new-equipment-quantity');
      const aliasInput = document.getElementById('new-equipment-alias');
      const locationSelect = document.getElementById('new-equipment-location');
      const note1Input = document.getElementById('new-equipment-note1');
      const note2Input = document.getElementById('new-equipment-note2');
      
      if (!nameInput || !quantityInput) {
        alert('入力欄が見つかりません');
        return;
      }
      
      // 必須項目チェック
      const name = nameInput.value.trim();
      if (!name) {
        alert('機器名称を入力してください');
        nameInput.focus();
        return;
      }
      
      const quantity = parseInt(quantityInput.value) || 0;
      if (quantity <= 0) {
        alert('有効な総台数を入力してください');
        quantityInput.focus();
        return;
      }
      
      // データ準備
      const data = {
        name: name,
        spec: specInput?.value.trim() || '',
        model: modelInput?.value.trim() || '',
        maker: makerInput?.value.trim() || '',
        serial: serialInput?.value.trim() || '',
        quantity: quantity,
        alias: aliasInput?.value.trim() || '',
        location: locationSelect?.value || '',
        note1: note1Input?.value.trim() || '',
        note2: note2Input?.value.trim() || ''
      };
      
      // 保存API実行
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();
          
          if (response && response.success) {
            // 成功処理
            nameInput.value = ''; // 入力欄をクリア
            specInput.value = '';
            modelInput.value = '';
            makerInput.value = '';
            serialInput.value = '';
            quantityInput.value = '1';
            aliasInput.value = '';
            locationSelect.value = '';
            note1Input.value = '';
            note2Input.value = '';
            
            // フィールドラベル更新
            M.updateTextFields();
            
            // 機材リスト再取得
            getEquipmentList();
            
            alert('機材を追加しました');
          } else {
            // 失敗処理
            alert('機材追加に失敗しました: ' + (response ? response.error : '不明なエラー'));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('機材追加エラー:', error);
          alert('機材追加に失敗しました: ' + error);
        })
        .addEquipment(data);
    } catch (error) {
      console.error('機材追加処理エラー:', error);
      alert('機材追加処理でエラーが発生しました: ' + error);
    }
  }
  
  // 機材削除関数
  function deleteEquipment() {
    try {
      // チェックされた機材を取得
      const checkboxes = document.querySelectorAll('.equipment-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('削除する機材を選択してください');
        return;
      }
      
      // 確認ダイアログ
      if (!confirm(`選択した${checkboxes.length}件の機材を削除しますか？`)) {
        return;
      }
      
      // 削除対象データを取得
      const equipmentItems = Array.from(checkboxes).map(checkbox => {
        try {
          return JSON.parse(checkbox.value);
        } catch (e) {
          console.error('JSONパースエラー:', e);
          return null;
        }
      }).filter(item => item !== null);
      
      // バックアップ用に最後の削除アイテムを保存
      if (equipmentItems.length > 0) {
        lastDeletedEquipment = equipmentItems[equipmentItems.length - 1];
      }
      
      // 削除API実行
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();
          
          if (response && response.success) {
            // 成功処理
            
            // 機材リスト再取得
            getEquipmentList();
            
            alert(`${response.deletedCount}件の機材を削除しました`);
          } else {
            // 失敗処理
            alert('機材削除に失敗しました: ' + (response ? response.error : '不明なエラー'));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('機材削除エラー:', error);
          alert('機材削除に失敗しました: ' + error);
        })
        .deleteEquipment(equipmentItems);
    } catch (error) {
      console.error('機材削除処理エラー:', error);
      alert('機材削除処理でエラーが発生しました: ' + error);
    }
  }
  
  // 機材削除の取り消し
  function undoEquipmentDelete() {
    try {
      if (!lastDeletedEquipment) {
        alert('取り消す削除操作がありません');
        return;
      }
      
      // 確認ダイアログ
      if (!confirm('最後に削除した機材を復元しますか？')) {
        return;
      }
      
      // 復元API実行
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();
          
          if (response && response.success) {
            // 成功処理
            
            // 機材リスト再取得
            getEquipmentList();
            
            // 復元したので削除履歴をクリア
            lastDeletedEquipment = null;
            
            alert('削除を取り消しました');
          } else {
            // 失敗処理
            alert('削除取り消しに失敗しました: ' + (response ? response.error : '不明なエラー'));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('削除取り消しエラー:', error);
          alert('削除取り消しに失敗しました: ' + error);
        })
        .undoEquipmentDelete(lastDeletedEquipment);
    } catch (error) {
      console.error('削除取り消し処理エラー:', error);
      alert('削除取り消し処理でエラーが発生しました: ' + error);
    }
  }
  
  // モーダルをすべて閉じる関数
  function closeAllModals() {
    try {
      // すべてのモーダル要素を取得
      const modals = document.querySelectorAll('.modal');
      
      // 各モーダルを閉じる
      modals.forEach(modal => {
        const instance = M.Modal.getInstance(modal);
        if (instance) {
          instance.close();
        }
      });
    } catch (error) {
      console.error('モーダル閉じるエラー:', error);
    }
  }
  
  // スクロール位置保存
  function saveScrollPosition() {
    try {
      const container = document.querySelector('.gantt-container');
      if (container) {
        savedScrollPosition = {
          top: container.scrollTop,
          left: container.scrollLeft
        };
      }
    } catch (error) {
      console.error('スクロール位置保存エラー:', error);
    }
  }
  
  // スクロール位置復元
  function restoreScrollPosition() {
    try {
      const container = document.querySelector('.gantt-container');
      if (container && savedScrollPosition) {
        container.scrollTop = savedScrollPosition.top;
        container.scrollLeft = savedScrollPosition.left;
      }
    } catch (error) {
      console.error('スクロール位置復元エラー:', error);
    }
  }
</script>