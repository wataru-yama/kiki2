<script>
/**
 * シンプルなカレンダー形式ガントチャート実装
 */

// 本日
const TODAY = new Date();
TODAY.setHours(0, 0, 0, 0);

/**
 * ガントチャートを描画
 */
function renderDirectGantt(containerId, tasksData) {
  // コンテナを取得
  const container = document.getElementById(containerId);
  if (!container) {
    console.error('ガントチャートコンテナが見つかりません: ' + containerId);
    return;
  }

  if (typeof showDebugInfo === 'function') {
    showDebugInfo("直接描画ガントチャートを初期化します");
  }

  // コンテナをクリア
  container.innerHTML = '';
  
  // データチェックとデバッグ情報
  if (typeof showDebugInfo === 'function') {
    if (tasksData && Array.isArray(tasksData)) {
      showDebugInfo(`貸出データ: ${tasksData.length}件, アクティブ: ${tasksData.filter(r => r.status === 'active').length}件`);
    } else {
      showDebugInfo("貸出データがありません");
    }
  }
  
  // データが提供されていない場合はサンプルデータを使用
  let chartData;
  let usingSampleData = false;
  
  if (tasksData && Array.isArray(tasksData)) {
    // アクティブな貸出データがあるかチェック
    const activeRentals = tasksData.filter(rental => rental.status === 'active');
    
    if (activeRentals && activeRentals.length > 0) {
      // アクティブなデータがある場合は実データを使用
      chartData = prepareGanttData(tasksData);
      
      // 実データの変換結果がない場合はサンプルデータ表示
      if (!chartData || chartData.length === 0) {
        chartData = generateSampleData();
        usingSampleData = true;
        console.log("データ変換結果が空のため、サンプルデータを使用します");
      }
    } else {
      // アクティブなデータがない場合はサンプルデータ
      chartData = generateSampleData();
      usingSampleData = true;
      console.log("アクティブな貸出データがないため、サンプルデータを使用します");
    }
  } else {
    // データがない場合はサンプルデータ
    chartData = generateSampleData();
    usingSampleData = true;
    console.log("貸出データがないため、サンプルデータを使用します");
  }
  
  // サンプルデータの場合の説明を追加
  let html = '';
  if (usingSampleData) {
    html += `
      <div style="padding: 10px; margin-bottom: 10px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; color: #856404;">
        <strong>サンプルデータ表示中</strong>: 現在、アクティブな貸出データがないためサンプルデータを表示しています。
        機材と貸出データを登録すると実際のスケジュールがここに表示されます。
      </div>
    `;
  }

  // 表示期間の計算（本日を含む前後2週間）
  let viewStartDate = new Date(TODAY);
  viewStartDate.setDate(TODAY.getDate() - 14); // 2週間前から
  
  let viewEndDate = new Date(TODAY);
  viewEndDate.setDate(TODAY.getDate() + 14); // 2週間後まで
  
  // 日付範囲表示の更新
  updateDateRangeText(viewStartDate, viewEndDate);
  
  // 日付の配列を生成
  const dates = [];
  let currentDate = new Date(viewStartDate);
  
  while (currentDate <= viewEndDate) {
    dates.push(new Date(currentDate));
    currentDate.setDate(currentDate.getDate() + 1);
  }

  // 現在の表示期間をグローバルに保存
  window.currentDisplayDates = {
    startDate: new Date(viewStartDate),
    endDate: new Date(viewEndDate)
  };

  // カレンダー表示エリアの作成
  html += `<div class="gantt-wrapper">`;
  
  // ヘッダー部分（日付）
  html += `<div class="gantt-header-container">`;
  html += `<div class="gantt-equipment-column">機材名</div>`;
  html += `<div class="gantt-dates-container" id="gantt-dates-container">`;
  
  // 年月のグループ化
  let currentYearMonth = '';
  let yearMonthColspan = 0;
  let yearMonthHtml = '';
  
  // 曜日の名称
  const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
  
  // 日付ヘッダーを生成
  dates.forEach((date, index) => {
    const yearMonth = `${date.getFullYear()}年${date.getMonth() + 1}月`;
    
    // 年月グループの処理
    if (yearMonth === currentYearMonth) {
      yearMonthColspan++;
    } else {
      if (currentYearMonth !== '') {
        yearMonthHtml += `<div class="gantt-year-month" style="grid-column: span ${yearMonthColspan}">${currentYearMonth}</div>`;
      }
      currentYearMonth = yearMonth;
      yearMonthColspan = 1;
    }
    
    // 最後の日付の処理
    if (index === dates.length - 1) {
      yearMonthHtml += `<div class="gantt-year-month" style="grid-column: span ${yearMonthColspan}">${currentYearMonth}</div>`;
    }
    
    // 曜日と日付
    const day = date.getDay();
    const isToday = date.toDateString() === TODAY.toDateString();
    const isSunday = day === 0;
    const isSaturday = day === 6;
    
    let dateClass = 'gantt-date';
    if (isToday) {
      dateClass += ' today';
    } else if (isSunday) {
      dateClass += ' sunday';
    } else if (isSaturday) {
      dateClass += ' saturday';
    }
    
    html += `<div class="${dateClass}" data-date="${formatDate(date)}">${date.getMonth() + 1}/${date.getDate()}<br>(${weekdays[day]})</div>`;
  });
  
  html += `</div>`; // gantt-dates-container の終了
  html += `</div>`; // gantt-header-container の終了
  
  // ボディ部分（機材と予定）
  html += `<div class="gantt-body-container">`;
  html += `<div class="gantt-equipment-list" id="gantt-equipment-list">`;
  
  // 機材リストを生成
  chartData.forEach(equipment => {
    html += `<div class="gantt-item" data-id="${equipment.id}">${equipment.name}</div>`;
  });
  
  html += `</div>`; // gantt-equipment-list の終了
  
  // カレンダー部分
  html += `<div class="gantt-calendar-container" id="gantt-calendar-container">`;
  
  // 各機材の行を生成
  chartData.forEach(equipment => {
    html += `<div class="gantt-row" data-id="${equipment.id}">`;
    
    // 日付ごとのセルを生成
    dates.forEach(date => {
      const dateStr = formatDate(date);
      const isToday = date.toDateString() === TODAY.toDateString();
      const day = date.getDay();
      const isSunday = day === 0;
      const isSaturday = day === 6;
      
      let cellClass = 'gantt-day';
      if (isToday) {
        cellClass += ' today';
      } else if (isSunday) {
        cellClass += ' sunday';
      } else if (isSaturday) {
        cellClass += ' saturday';
      }
      
      html += `<div class="${cellClass}" data-date="${dateStr}" data-equipment="${equipment.id}"></div>`;
    });
    
    html += `</div>`; // gantt-row の終了
  });
  
  html += `</div>`; // gantt-calendar-container の終了
  html += `</div>`; // gantt-body-container の終了
  html += `</div>`; // gantt-wrapper の終了
  
  // スタイルを追加
  html += `
  <style>
    .gantt-wrapper {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: calc(100vh - 250px);
      min-height: 500px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .gantt-header-container {
      display: flex;
      position: sticky;
      top: 0;
      z-index: 10;
      min-height: 60px;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
    }
    
    .gantt-equipment-column {
      min-width: 200px;
      width: 200px;
      flex-shrink: 0;
      border-right: 1px solid #ddd;
      background-color: #f5f5f5;
      padding: 10px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .gantt-dates-container {
      display: flex;
      overflow-x: auto;
      flex-grow: 1;
      border-bottom: 1px solid #ddd;
      scrollbar-width: thin;
    }
    
    .gantt-body-container {
      display: flex;
      flex-grow: 1;
      overflow: hidden;
    }
    
    .gantt-equipment-list {
      min-width: 200px;
      width: 200px;
      flex-shrink: 0;
      border-right: 1px solid #ddd;
      background-color: #f5f5f5;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    
    .gantt-calendar-container {
      overflow: auto;
      flex-grow: 1;
      scrollbar-width: thin;
    }
    
    .gantt-row {
      display: flex;
      min-height: 60px;
      border-bottom: 1px solid #ddd;
    }
    
    .gantt-item {
      padding: 10px;
      min-height: 60px;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
    }
    
    .gantt-date, .gantt-day {
      min-width: 80px;
      width: 80px;
      flex-shrink: 0;
      border-right: 1px solid #ddd;
      text-align: center;
      padding: 10px 5px;
    }
    
    .gantt-date {
      font-weight: bold;
    }
    
    .gantt-day {
      position: relative;
      height: 100%;
    }
    
    .rental-bar {
      position: absolute;
      height: 30px;
      top: 15px;
      background-color: #26a69a;
      color: white;
      border-radius: 3px;
      padding: 5px;
      cursor: move;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 5;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .resize-handle {
      position: absolute;
      top: 0;
      width: 8px;
      height: 100%;
      cursor: col-resize;
      z-index: 6;
    }
    
    .left-handle {
      left: 0;
    }
    
    .right-handle {
      right: 0;
    }
    
    .today {
      background-color: #ffe6e6;
    }
    
    .sunday {
      background-color: #fff8f8;
      color: #D32F2F;
    }
    
    .saturday {
      background-color: #f8fbff;
      color: #1976D2;
    }
    
    /* スクロールバーのスタイル */
    .gantt-dates-container::-webkit-scrollbar,
    .gantt-calendar-container::-webkit-scrollbar,
    .gantt-equipment-list::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    
    .gantt-dates-container::-webkit-scrollbar-thumb,
    .gantt-calendar-container::-webkit-scrollbar-thumb,
    .gantt-equipment-list::-webkit-scrollbar-thumb {
      background-color: #26a69a;
      border-radius: 4px;
    }
    
    .gantt-dates-container::-webkit-scrollbar-track,
    .gantt-calendar-container::-webkit-scrollbar-track,
    .gantt-equipment-list::-webkit-scrollbar-track {
      background-color: #f1f1f1;
    }
  </style>
  `;
  
  // HTMLを挿入
  container.innerHTML = html;
  
  // 貸出バーを描画
  chartData.forEach(equipment => {
    equipment.rentals.forEach(rental => {
      addRentalBar(rental, equipment.id, viewStartDate, viewEndDate);
    });
  });
  
  // スクロール同期機能を追加
  setupScrollSync();
  
  // カレンダーセルへのクリックイベント（新規貸出）
  setupCalendarCellEvents();
  
  // ナビゲーションボタンの設定
  setupNavigationEvents();
}

/**
 * スクロール同期を設定
 */
function setupScrollSync() {
  const datesContainer = document.getElementById('gantt-dates-container');
  const calendarContainer = document.getElementById('gantt-calendar-container');
  const equipmentList = document.getElementById('gantt-equipment-list');
  
  if (!datesContainer || !calendarContainer || !equipmentList) return;
  
  // 水平スクロールの同期
  calendarContainer.addEventListener('scroll', function() {
    datesContainer.scrollLeft = this.scrollLeft;
  });
  
  datesContainer.addEventListener('scroll', function() {
    calendarContainer.scrollLeft = this.scrollLeft;
  });
  
  // 垂直スクロールの同期
  calendarContainer.addEventListener('scroll', function() {
    equipmentList.scrollTop = this.scrollTop;
  });
  
  equipmentList.addEventListener('scroll', function() {
    calendarContainer.scrollTop = this.scrollTop;
  });
}

// 機材在庫数を取得
function getEquipmentStock(equipmentId) {
  if (window.equipmentList) {
    const equipment = window.equipmentList.find(eq => eq.id === equipmentId);
    if (equipment) {
      return `${equipment.availableCount || 0}/${equipment.totalQuantity || 0}台`;
    }
  }
  return '0/0台';
}

// 機材仕様を取得
function getEquipmentSpec(equipmentId) {
  if (window.equipmentList) {
    const equipment = window.equipmentList.find(eq => eq.id === equipmentId);
    if (equipment) {
      return equipment.specification || '-';
    }
  }
  return '-';
}

// 機材型番を取得
function getEquipmentModel(equipmentId) {
  if (window.equipmentList) {
    const equipment = window.equipmentList.find(eq => eq.id === equipmentId);
    if (equipment) {
      return equipment.model || '-';
    }
  }
  return '-';
}

// 機材メーカーを取得
function getEquipmentManufacturer(equipmentId) {
  if (window.equipmentList) {
    const equipment = window.equipmentList.find(eq => eq.id === equipmentId);
    if (equipment) {
      return equipment.manufacturer || '-';
    }
  }
  return '-';
}

/**
 * 貸出バーを追加
 */
function addRentalBar(rental, equipmentId, viewStartDate, viewEndDate) {
  const startDate = rental.start instanceof Date ? rental.start : new Date(rental.start || rental.startDate);
  const endDate = rental.end instanceof Date ? rental.end : new Date(rental.end || rental.endDate);
  
  // 表示期間外ならスキップ
  if (endDate < viewStartDate || startDate > viewEndDate) {
    return;
  }
  
  // 表示用に調整
  const displayStartDate = startDate < viewStartDate ? viewStartDate : startDate;
  const displayEndDate = endDate > viewEndDate ? viewEndDate : endDate;
  
  // 貸出バーの配置
  const row = document.querySelector(`.gantt-row[data-id="${equipmentId}"]`);
  if (!row) return;
  
  // 日数計算と位置調整
  const startCell = row.querySelector(`div[data-date="${formatDate(displayStartDate)}"]`);
  if (!startCell) return;
  
  const durationDays = Math.floor((displayEndDate - displayStartDate) / (24 * 60 * 60 * 1000)) + 1;
  const cellWidth = 80; // セル幅
  
  // バーの開始位置（startCell の左端からの位置）
  let startPosition = 0;
  
  // 色設定
  const colorPatterns = [
    { bg: '#FF9800', text: 'white', border: '#F57C00' },  // オレンジ
    { bg: '#2196F3', text: 'white', border: '#1976D2' },  // 青
    { bg: '#4CAF50', text: 'white', border: '#388E3C' },  // 緑
    { bg: '#E91E63', text: 'white', border: '#C2185B' },  // ピンク
    { bg: '#9C27B0', text: 'white', border: '#7B1FA2' }   // 紫
  ];
  
  const colorIdx = Math.floor(Math.random() * colorPatterns.length);
  const color = colorPatterns[colorIdx];
  
  // 貸出バーの作成
  const barDiv = document.createElement('div');
  barDiv.className = 'rental-bar';
  barDiv.setAttribute('data-id', rental.id);
  barDiv.setAttribute('data-equipment', equipmentId);
  barDiv.setAttribute('data-start', formatDate(startDate));
  barDiv.setAttribute('data-end', formatDate(endDate));
  
  // スタイル設定
  barDiv.style.left = `${startPosition}px`;
  barDiv.style.width = `${durationDays * cellWidth - 4}px`;
  barDiv.style.backgroundColor = color.bg;
  barDiv.style.color = color.text;
  barDiv.style.border = `1px solid ${color.border}`;
  
  // テキスト内容
  barDiv.innerHTML = `
    <div style="font-weight: bold;">${rental.name}</div>
    <div style="position: absolute; top: 3px; right: 3px;">
      <button class="return-btn" style="width: 24px; height: 24px; background-color: white; border: none; border-radius: 50%; color: #FF5722; font-weight: bold; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.2);" title="返却">↩</button>
    </div>
  `;
  
  // バーをセルに追加
  startCell.appendChild(barDiv);
  
  // 返却ボタンのイベント設定
  const returnBtn = barDiv.querySelector('.return-btn');
  returnBtn.addEventListener('click', function(e) {
    e.stopPropagation(); // 親要素へのイベント伝播を防止
    
    // 貸出IDを取得
    const rentalId = barDiv.getAttribute('data-id');
    
    // サンプルデータまたは実際のデータから貸出情報を取得
    let rentalInfo = null;
    
    if (window.rentalData) {
      rentalInfo = window.rentalData.find(r => r.id === parseInt(rentalId));
    }
    
    if (!rentalInfo) {
      // サンプルデータ用のフォールバック
      rentalInfo = {
        id: rentalId,
        equipmentId: equipmentId,
        equipmentName: document.querySelector(`.gantt-item[data-id="${equipmentId}"]`).textContent,
        startDate: barDiv.getAttribute('data-start'),
        endDate: barDiv.getAttribute('data-end'),
        quantity: rental.name.split(' - ')[1]?.split('台')[0] || '1'
      };
    }
    
    // 返却モーダルの表示
    handleRentalReturn(rentalId, rentalInfo);
  });
  
  // バーのクリックイベント
  barDiv.addEventListener('click', function(e) {
    if (e.target !== returnBtn && !returnBtn.contains(e.target)) {
      // 貸出IDを取得
      const rentalId = barDiv.getAttribute('data-id');
      
      // サンプルデータまたは実際のデータから貸出情報を取得
      let rentalInfo = null;
      
      if (window.rentalData) {
        rentalInfo = window.rentalData.find(r => r.id === parseInt(rentalId));
      }
      
      if (!rentalInfo) {
        // サンプルデータ用のフォールバック
        rentalInfo = {
          id: rentalId,
          equipmentId: equipmentId,
          equipmentName: document.querySelector(`.gantt-item[data-id="${equipmentId}"]`).textContent,
          startDate: barDiv.getAttribute('data-start'),
          endDate: barDiv.getAttribute('data-end'),
          quantity: rental.name.split(' - ')[1]?.split('台')[0] || '1',
          site: rental.name.split(' - ')[0],
          borrower: '鈴木 一郎' // サンプルユーザー
        };
      }
      
      // 編集モーダルの表示
      handleRentalEdit(rentalId, rentalInfo);
    }
  });
  
  // ドラッグ＆ドロップ機能の実装
  setupDragAndDrop(barDiv);
  
  // リサイズハンドラの追加
  addResizeHandlers(barDiv);
}

/**
 * リサイズハンドラを追加
 */
function addResizeHandlers(barDiv) {
  // 左リサイズハンドラ
  const leftHandle = document.createElement('div');
  leftHandle.className = 'resize-handle left-handle';
  
  // 右リサイズハンドラ
  const rightHandle = document.createElement('div');
  rightHandle.className = 'resize-handle right-handle';
  
  barDiv.appendChild(leftHandle);
  barDiv.appendChild(rightHandle);
  
  // リサイズイベントの設定
  setupResizeEvents(barDiv, leftHandle, rightHandle);
}

/**
 * リサイズイベントの設定
 */
function setupResizeEvents(barDiv, leftHandle, rightHandle) {
  let startX, startWidth, startPosition, resizing, handle;
  
  const startResize = function(e, isLeft) {
    e.stopPropagation();
    resizing = true;
    handle = isLeft ? 'left' : 'right';
    startX = e.clientX;
    startWidth = barDiv.offsetWidth;
    startPosition = parseInt(barDiv.style.left.replace('px', '')) || 0;
    
    document.addEventListener('mousemove', doResize);
    document.addEventListener('mouseup', stopResize);
    
    // リサイズ中のスタイル
    barDiv.classList.add('resizing');
  };
  
  const doResize = function(e) {
    if (!resizing) return;
    
    const cellWidth = 80; // 1日あたりのセル幅
    let newWidth, newLeft;
    
    if (handle === 'right') {
      // 右側のリサイズ - 幅のみ変更
      newWidth = Math.max(cellWidth, startWidth + e.clientX - startX);
      // 日数単位にスナップ
      newWidth = Math.round(newWidth / cellWidth) * cellWidth - 4;
      barDiv.style.width = `${newWidth}px`;
    } else {
      // 左側のリサイズ - 幅と位置を変更
      const diff = e.clientX - startX;
      newWidth = Math.max(cellWidth, startWidth - diff);
      newLeft = startPosition + diff;
      
      // 日数単位にスナップ
      newLeft = Math.round(newLeft / cellWidth) * cellWidth;
      newWidth = Math.round(newWidth / cellWidth) * cellWidth - 4;
      
      barDiv.style.width = `${newWidth}px`;
      barDiv.style.left = `${newLeft}px`;
    }
  };
  
  const stopResize = function() {
    if (!resizing) return;
    
    resizing = false;
    document.removeEventListener('mousemove', doResize);
    document.removeEventListener('mouseup', stopResize);
    
    // リサイズ中のスタイルを解除
    barDiv.classList.remove('resizing');
    
    try {
      // リサイズ後の日数計算
      const cellWidth = 80;
      const days = Math.round((barDiv.offsetWidth + 4) / cellWidth);
      const rentalId = barDiv.getAttribute('data-id');
      const equipmentId = barDiv.getAttribute('data-equipment');
      
      // 現在位置からのセル計算
      const rowCells = Array.from(barDiv.closest('.gantt-row').querySelectorAll('.gantt-day'));
      const leftPos = parseInt(barDiv.style.left.replace('px', '')) || 0;
      const startCellIndex = Math.floor(leftPos / cellWidth);
      
      // 開始日と終了日の計算
      let newStartDate, newEndDate;
      
      if (startCellIndex < 0 || startCellIndex >= rowCells.length) {
        showErrorMessage('貸出バーの位置が無効です');
        return;
      }
      
      // 開始日の取得
      const startCell = rowCells[startCellIndex];
      if (!startCell) {
        showErrorMessage('開始セルが見つかりません');
        return;
      }
      
      newStartDate = startCell.getAttribute('data-date');
      
      // 終了日の計算
      const endCellIndex = startCellIndex + days - 1;
      if (endCellIndex >= rowCells.length) {
        showErrorMessage('終了日が表示範囲を超えています');
        return;
      }
      
      const endCell = rowCells[endCellIndex];
      if (!endCell) {
        showErrorMessage('終了セルが見つかりません');
        return;
      }
      
      newEndDate = endCell.getAttribute('data-date');
      
      // 日付の検証
      if (!newStartDate || !newEndDate) {
        showErrorMessage('日付の計算に失敗しました');
        return;
      }
      
      // 変更がない場合は終了
      if (newStartDate === barDiv.getAttribute('data-start') && 
          newEndDate === barDiv.getAttribute('data-end')) {
        return;
      }
      
      // 日付更新をサーバーに通知
      updateRentalPeriod(rentalId, newStartDate, newEndDate);
      
      // バーの属性を更新
      barDiv.setAttribute('data-start', newStartDate);
      barDiv.setAttribute('data-end', newEndDate);
      
    } catch (error) {
      console.error('リサイズ処理エラー:', error);
      showErrorMessage('リサイズ処理中にエラーが発生しました');
    }
  };
  
  // イベントリスナーの設定
  leftHandle.addEventListener('mousedown', function(e) {
    startResize(e, true);
  });
  
  rightHandle.addEventListener('mousedown', function(e) {
    startResize(e, false);
  });
}

/**
 * ドラッグ＆ドロップの設定
 */
function setupDragAndDrop(barDiv) {
  let initialX, isDragging = false;
  let originalLeft, originalStartDate, originalEndDate;
  
  barDiv.addEventListener('mousedown', function(e) {
    // 返却ボタンやリサイズハンドラ以外のクリックのみ処理
    if (e.target.closest('.return-btn') || e.target.closest('.resize-handle')) {
      return;
    }
    
    e.preventDefault();
    isDragging = true;
    initialX = e.clientX;
    originalLeft = parseInt(barDiv.style.left.replace('px', '')) || 0;
    originalStartDate = barDiv.getAttribute('data-start');
    originalEndDate = barDiv.getAttribute('data-end');
    
    // ドラッグ中のスタイル
    barDiv.classList.add('dragging');
    
    // マウス移動イベントを追加
    document.addEventListener('mousemove', dragMove);
    document.addEventListener('mouseup', dragEnd);
  });
  
  function dragMove(e) {
    if (!isDragging) return;
    
    const deltaX = e.clientX - initialX;
    const cellWidth = 80;
    
    // スナップ処理
    const snappedDeltaX = Math.round(deltaX / cellWidth) * cellWidth;
    const newLeft = originalLeft + snappedDeltaX;
    
    // 負の位置にならないようにする
    barDiv.style.left = `${Math.max(0, newLeft)}px`;
  }
  
  function dragEnd(e) {
    if (!isDragging) return;
    
    isDragging = false;
    document.removeEventListener('mousemove', dragMove);
    document.removeEventListener('mouseup', dragEnd);
    
    // ドラッグ中のスタイルを解除
    barDiv.classList.remove('dragging');
    
    try {
      // 移動後の位置から日付を計算
      const cellWidth = 80;
      const leftPos = parseInt(barDiv.style.left.replace('px', '')) || 0;
      const startCellIndex = Math.floor(leftPos / cellWidth);
      
      // セルの取得
      const rowCells = Array.from(barDiv.closest('.gantt-row').querySelectorAll('.gantt-day'));
      
      if (startCellIndex < 0 || startCellIndex >= rowCells.length) {
        // 位置が範囲外の場合は元の位置に戻す
        barDiv.style.left = `${originalLeft}px`;
        showErrorMessage('移動先が範囲外です');
        return;
      }
      
      // 開始日の取得
      const startCell = rowCells[startCellIndex];
      if (!startCell) {
        barDiv.style.left = `${originalLeft}px`;
        showErrorMessage('開始セルが見つかりません');
        return;
      }
      
      const newStartDate = startCell.getAttribute('data-date');
      
      // 期間の日数を計算
      const originalStartDateObj = new Date(originalStartDate);
      const originalEndDateObj = new Date(originalEndDate);
      const durationDays = Math.round((originalEndDateObj - originalStartDateObj) / (24 * 60 * 60 * 1000));
      
      // 終了日の計算
      const newStartDateObj = new Date(newStartDate);
      const newEndDateObj = new Date(newStartDateObj);
      newEndDateObj.setDate(newStartDateObj.getDate() + durationDays);
      const newEndDate = formatDate(newEndDateObj);
      
      // 終了セルが範囲内かチェック
      const endCellIndex = startCellIndex + durationDays;
      if (endCellIndex >= rowCells.length) {
        barDiv.style.left = `${originalLeft}px`;
        showErrorMessage('終了日が表示範囲を超えています');
        return;
      }
      
      // 変更がない場合は終了
      if (newStartDate === originalStartDate && newEndDate === originalEndDate) {
        return;
      }
      
      // 貸出IDを取得
      const rentalId = barDiv.getAttribute('data-id');
      
      // 日付更新をサーバーに通知
      updateRentalPeriod(rentalId, newStartDate, newEndDate);
      
      // バーの属性を更新
      barDiv.setAttribute('data-start', newStartDate);
      barDiv.setAttribute('data-end', newEndDate);
      
    } catch (error) {
      console.error('ドラッグ処理エラー:', error);
      showErrorMessage('ドラッグ処理中にエラーが発生しました');
      // 元の位置に戻す
      barDiv.style.left = `${originalLeft}px`;
    }
  }
}

/**
 * エラーメッセージを表示
 */
function showErrorMessage(message) {
  if (typeof showDebugInfo === 'function') {
    showDebugInfo(`エラー: ${message}`);
  }
  
  alert(`エラーが発生しました: ${message}`);
}

/**
 * カレンダーセルへのクリックイベント設定
 * ドラッグ選択と単一セルクリックの両方に対応
 */
function setupCalendarCellEvents() {
  // カレンダーコンテナを取得
  const calendarContainer = document.getElementById('calendar-container');
  if (!calendarContainer) return;
  
  let isDragging = false;
  let startCell = null;
  let endCell = null;
  let dragEquipmentId = null;
  
  // マウスダウンイベント
  calendarContainer.addEventListener('mousedown', function(e) {
    // 日付セルのみを対象とする
    const cell = e.target.closest('.calendar-day');
    if (!cell) return;
    
    e.preventDefault();
    isDragging = true;
    startCell = cell;
    dragEquipmentId = cell.getAttribute('data-equipment-id');
    
    // ハイライト初期化
    resetHighlight();
    highlightCell(cell);
    
    if (typeof showDebugInfo === 'function') {
      showDebugInfo(`ドラッグ開始: 機材ID=${dragEquipmentId}, 日付=${cell.getAttribute('data-date')}`);
    }
  });
  
  // マウス移動イベント
  calendarContainer.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    
    const cell = e.target.closest('.calendar-day');
    if (!cell) return;
    
    // 同じ機材行のセルのみ対象とする
    const cellEquipmentId = cell.getAttribute('data-equipment-id');
    if (cellEquipmentId !== dragEquipmentId) return;
    
    endCell = cell;
    updateHighlight();
  });

  // マウスアップイベント
  document.addEventListener('mouseup', function(e) {
    if (!isDragging) return;
    
    isDragging = false;
    
    // ドラッグ選択が有効な場合、モーダルを表示
    if (startCell && endCell) {
      const startDate = startCell.getAttribute('data-date');
      const endDate = endCell.getAttribute('data-date');
      
      // 開始日と終了日を調整（開始日が終了日より後の場合は入れ替え）
      const adjustedStartDate = new Date(startDate) < new Date(endDate) ? startDate : endDate;
      const adjustedEndDate = new Date(startDate) < new Date(endDate) ? endDate : startDate;
      
      // 機材情報を取得
      const equipment = equipmentList.find(eq => eq.id === dragEquipmentId);
      if (equipment) {
        // 貸出モーダルを表示
        showRentalModal(equipment, adjustedStartDate, adjustedEndDate);
        
        if (typeof showDebugInfo === 'function') {
          showDebugInfo(`ドラッグ選択完了: ${equipment.name}, 期間=${adjustedStartDate}~${adjustedEndDate}`);
        }
      }
    }
    
    resetHighlight();
    startCell = null;
    endCell = null;
    dragEquipmentId = null;
  });
  
  // タッチイベント対応
  calendarContainer.addEventListener('touchstart', function(e) {
    const touch = e.touches[0];
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    if (!element) return;
    
    const cell = element.closest('.calendar-day');
    if (!cell) return;
    
    e.preventDefault();
    isDragging = true;
    startCell = cell;
    dragEquipmentId = cell.getAttribute('data-equipment-id');
    
    resetHighlight();
    highlightCell(cell);
  });
  
  calendarContainer.addEventListener('touchmove', function(e) {
    if (!isDragging) return;
    
    const touch = e.touches[0];
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    if (!element) return;
    
    const cell = element.closest('.calendar-day');
    if (!cell) return;
    
    const cellEquipmentId = cell.getAttribute('data-equipment-id');
    if (cellEquipmentId !== dragEquipmentId) return;
    
    endCell = cell;
    updateHighlight();
  });
  
  calendarContainer.addEventListener('touchend', function(e) {
    if (!isDragging) return;
    
    isDragging = false;
    
    if (startCell && endCell) {
      const startDate = startCell.getAttribute('data-date');
      const endDate = endCell.getAttribute('data-date');
      
      // 開始日と終了日を調整（開始日が終了日より後の場合は入れ替え）
      const adjustedStartDate = new Date(startDate) < new Date(endDate) ? startDate : endDate;
      const adjustedEndDate = new Date(startDate) < new Date(endDate) ? endDate : startDate;
      
      // 機材情報を取得
      const equipment = equipmentList.find(eq => eq.id === dragEquipmentId);
      if (equipment) {
        // 貸出モーダルを表示
        showRentalModal(equipment, adjustedStartDate, adjustedEndDate);
      }
    }
    
    resetHighlight();
    startCell = null;
    endCell = null;
    dragEquipmentId = null;
  });
  
  // 単一セルクリックのイベント処理
  calendarContainer.addEventListener('click', function(e) {
    // ドラッグ中の場合は処理しない
    if (isDragging) return;
    
    // 日付セルのみを対象とする
    const cell = e.target.closest('.calendar-day');
    if (!cell) return;
    
    try {
      // セルの情報
      const date = cell.getAttribute('data-date');
      const equipmentId = cell.getAttribute('data-equipment-id');
      
      if (!date || !equipmentId) {
        if (typeof showErrorMessage === 'function') {
          showErrorMessage('セル情報が不足しています。');
        }
        return;
      }
      
      // 該当機材の情報を取得
      let equipment = null;
      
      if (window.equipmentList) {
        equipment = window.equipmentList.find(eq => eq.id === equipmentId);
      }
      
      if (!equipment) {
        // サンプルデータのフォールバック
        const nameElement = document.querySelector(`.gantt-item[data-id="${equipmentId}"]`);
        if (nameElement) {
          equipment = {
            id: equipmentId,
            name: nameElement.textContent,
            totalQuantity: 6 // サンプル値
          };
        }
      }
      
      if (equipment) {
        // 貸出モーダルを表示（開始日と終了日を同じに設定）
        showRentalModal(equipment, date, date);
        
        if (typeof showDebugInfo === 'function') {
          showDebugInfo(`セルクリック: 機材=${equipment.name}, 日付=${date}`);
        }
      }
    } catch (error) {
      console.error('セルクリック処理エラー:', error);
      if (typeof showErrorMessage === 'function') {
        showErrorMessage('処理中にエラーが発生しました。');
      }
    }
  });

// ハイライトをリセット
  function resetHighlight() {
    const highlightedCells = document.querySelectorAll('.calendar-day.drag-highlight');
    highlightedCells.forEach(cell => {
      cell.classList.remove('drag-highlight');
    });
  }
  
  // セルをハイライト
  function highlightCell(cell) {
    if (cell) {
      cell.classList.add('drag-highlight');
    }
  }
  
  // ハイライトの更新
  function updateHighlight() {
    resetHighlight();
    
    if (!startCell || !endCell) return;
    
    // 開始日と終了日の取得
    const startDate = new Date(startCell.getAttribute('data-date'));
    const endDate = new Date(endCell.getAttribute('data-date'));
    
    // 開始日と終了日の調整（開始日が終了日より後の場合は入れ替え）
    const minDate = startDate < endDate ? startDate : endDate;
    const maxDate = startDate < endDate ? endDate : endDate;
    
    // 該当する機材行のすべてのセル
    const row = startCell.parentElement;
    const cells = row.querySelectorAll('.calendar-day');
    
    // 日付範囲内のセルをハイライト
    cells.forEach(cell => {
      const cellDate = new Date(cell.getAttribute('data-date'));
      if (cellDate >= minDate && cellDate <= maxDate) {
        highlightCell(cell);
      }
    });
  }
}

/**
 * 貸出モーダルの表示
 * @param {Object} equipment - 機材データ
 * @param {string} startDate - 開始日（YYYY-MM-DD形式）
 * @param {string} endDate - 終了日（YYYY-MM-DD形式）
 */
function showRentalModal(equipment, startDate, endDate) {
  if (!equipment) {
    console.error('機材データがnullです');
    if (typeof showDebugInfo === 'function') {
      showDebugInfo('機材データがnullです');
    }
    return;
  }
  
  // グローバル関数が利用可能な場合は使用する
  if (typeof window.showRentalModal === 'function') {
    window.showRentalModal(equipment, startDate, endDate);
    return;
  }
  
  // モーダル要素を取得
  const modal = document.getElementById('rental-modal');
  if (!modal) {
    console.error('貸出モーダルが見つかりません');
    alert(`機材「${equipment.name}」の貸出登録 (${startDate}〜${endDate})`);
    return;
  }
  
  // モーダル内の値をリセット
  const equipmentInput = document.getElementById('rental-equipment');
  if (equipmentInput) {
    equipmentInput.value = `${equipment.name} (#${equipment.id})`;
  }
  
  // 日付の設定
  const startDateInput = document.getElementById('rental-start');
  const endDateInput = document.getElementById('rental-end');
  
  if (startDateInput && endDateInput) {
    if (startDate && endDate) {
      startDateInput.value = startDate;
      endDateInput.value = endDate;
    } else {
      // デフォルト値として今日の日付と1週間後を設定
      const today = new Date();
      const nextWeek = new Date(today);
      nextWeek.setDate(today.getDate() + 7);
      
      startDateInput.value = formatDate(today);
      endDateInput.value = formatDate(nextWeek);
    }
  }
  
  // その他の入力値をリセット
  const projectSelect = document.getElementById('rental-project');
  if (projectSelect) {
    projectSelect.value = '';
  }
  
  const quantityInput = document.getElementById('rental-quantity');
  if (quantityInput) {
    quantityInput.value = '1';
    // 数量の最大値を設定
    quantityInput.max = equipment.totalQuantity || 1;
  }
  
  const newProjectInput = document.getElementById('new-project');
  if (newProjectInput) {
    newProjectInput.value = '';
  }
  
  // モーダル表示
  modal.setAttribute('data-equipment-id', equipment.id);
  modal.removeAttribute('data-rental-id'); // 新規モードでは貸出IDを削除
  
  // モーダルを表示
  try {
    // Materialize CSSのモーダル機能を使用
    if (typeof M !== 'undefined' && M.Modal) {
      const modalInstance = M.Modal.getInstance(modal);
      if (modalInstance) {
        modalInstance.open();
      } else {
        const newInstance = M.Modal.init(modal, {
          dismissible: true,
          opacity: 0.5,
          inDuration: 300,
          outDuration: 200,
          startingTop: '4%',
          endingTop: '10%'
        });
        newInstance.open();
      }
    } else {
      // フォールバック：CSSで表示
      modal.style.display = 'block';
      modal.classList.add('open');
      
      // オーバーレイを追加
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.opacity = '0.5';
      overlay.style.display = 'block';
      document.body.appendChild(overlay);
    }
    
    if (typeof showDebugInfo === 'function') {
      showDebugInfo(`貸出モーダルを表示: 機材=${equipment.name}, 開始=${startDate}, 終了=${endDate}`);
    }
    
    // Materializeフォーム更新
    setTimeout(function() {
      if (typeof M !== 'undefined' && M.updateTextFields) {
        M.updateTextFields();
        const selectElements = document.querySelectorAll('select');
        if (M.FormSelect) {
          M.FormSelect.init(selectElements);
        }
      }
    }, 100);
  } catch (e) {
    console.error('モーダル表示エラー:', e);
    // フォールバック：アラート
    alert(`機材「${equipment.name}」の貸出登録 (${startDate}〜${endDate})`);
  }
}

/**
 * ナビゲーションイベントの設定
 */
function setupNavigationEvents() {
  // 前へボタン
  const prevBtn = document.getElementById('prev-btn');
  if (prevBtn) {
    prevBtn.onclick = function() {
      navigateGantt('prev');
    };
  }
  
  // 次へボタン
  const nextBtn = document.getElementById('next-btn');
  if (nextBtn) {
    nextBtn.onclick = function() {
      navigateGantt('next');
    };
  }
  
  // 今日ボタン
  const todayBtn = document.getElementById('view-today');
  if (todayBtn) {
    todayBtn.onclick = function() {
      goToToday();
    };
  }
}

/**
 * ガントチャートナビゲーション
 */
function navigateGantt(direction) {
  if (!window.currentDisplayDates) {
    goToToday();
    return;
  }
  
  const currentStart = window.currentDisplayDates.startDate;
  const currentEnd = window.currentDisplayDates.endDate;
  
  // 移動日数
  const dayShift = direction === 'prev' ? -14 : 14;
  
  // 新しい表示期間
  const newStart = new Date(currentStart);
  newStart.setDate(currentStart.getDate() + dayShift);
  
  const newEnd = new Date(currentEnd);
  newEnd.setDate(currentEnd.getDate() + dayShift);
  
  // 現在の表示期間を更新
  window.currentDisplayDates = {
    startDate: newStart,
    endDate: newEnd
  };
  
  // ガントチャートを再描画
  renderDirectGantt('ganttChart');
  
  if (typeof showDebugInfo === 'function') {
    showDebugInfo(`ガントチャート表示期間を${dayShift}日移動しました`);
  }
}

/**
 * 今日の日付に移動
 */
function goToToday() {
  // 本日を中心に前後2週間の期間を設定
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const start = new Date(today);
  start.setDate(today.getDate() - 14); // 2週間前から
  
  const end = new Date(today);
  end.setDate(today.getDate() + 14); // 2週間後まで
  
  // 現在の表示期間を更新
  window.currentDisplayDates = {
    startDate: start,
    endDate: end
  };
  
  // ガントチャートを再描画
  renderDirectGantt('ganttChart');
  
  if (typeof showDebugInfo === 'function') {
    showDebugInfo('今日の日付を中心に表示します');
  }
}

/**
 * 指定した日付に移動
 */
function goToDate(dateStr) {
  try {
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) {
      showErrorMessage('無効な日付形式です');
      return;
    }
    
    // 指定日付を中心に前後2週間
    const start = new Date(date);
    start.setDate(date.getDate() - 14);
    
    const end = new Date(date);
    end.setDate(date.getDate() + 14);
    
    // 現在の表示期間を更新
    window.currentDisplayDates = {
      startDate: start,
      endDate: end
    };
    
    // ガントチャートを再描画
    renderDirectGantt('ganttChart');
    
    if (typeof showDebugInfo === 'function') {
      showDebugInfo(`${dateStr}を中心に表示します`);
    }
  } catch (error) {
    console.error('日付移動エラー:', error);
    showErrorMessage('日付移動処理でエラーが発生しました');
  }
}

/**
 * 貸出編集処理
 */
function handleRentalEdit(rentalId, rentalInfo) {
  // グローバル関数が存在する場合は呼び出し、なければモック処理
  if (typeof showEditRentalModal === 'function' && rentalInfo) {
    showEditRentalModal(rentalInfo);
  } else {
    // モック処理
    alert(`貸出ID: ${rentalId} の編集`);
    if (typeof showDebugInfo === 'function') {
      showDebugInfo(`貸出ID: ${rentalId} の編集モーダルを表示しました (モック)`);
    }
  }
}

/**
 * 貸出返却処理
 */
function handleRentalReturn(rentalId, rentalInfo) {
  // グローバル関数が存在する場合は呼び出し、なければモック処理
  if (typeof showReturnModal === 'function' && rentalInfo) {
    showReturnModal(rentalInfo);
  } else {
    // モック処理
    alert(`貸出ID: ${rentalId} の返却`);
    if (typeof showDebugInfo === 'function') {
      showDebugInfo(`貸出ID: ${rentalId} の返却モーダルを表示しました (モック)`);
    }
  }
}

/**
 * 日付範囲テキストの更新
 */
function updateDateRangeText(startDate, endDate) {
  const dateRangeElement = document.getElementById('currentDateRange');
  if (dateRangeElement) {
    dateRangeElement.textContent = `${formatDate(startDate)} 〜 ${formatDate(endDate)}`;
  }
}

/**
 * 貸出期間の更新
 */
function updateRentalPeriod(rentalId, startDate, endDate) {
  if (typeof showDebugInfo === 'function') {
    showDebugInfo(`貸出ID: ${rentalId} の期間を ${startDate} 〜 ${endDate} に更新します`);
  }
  
  // サーバーAPIの存在確認と呼び出し
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    // 処理中メッセージ
    showUpdateMessage(`貸出期間を更新中...`);
    
    google.script.run
      .withSuccessHandler(function() {
        hideUpdateMessage();
        if (typeof showDebugInfo === 'function') {
          showDebugInfo('貸出期間の更新が完了しました');
        }
        
        // 更新完了後にガントチャートを再描画
        setTimeout(() => {
          renderDirectGantt('ganttChart');
        }, 500);
      })
      .withFailureHandler(function(error) {
        hideUpdateMessage();
        console.error('貸出期間の更新に失敗しました:', error);
        if (typeof showDebugInfo === 'function') {
          showDebugInfo('貸出期間の更新に失敗しました: ' + error);
        }
        alert('貸出期間の更新に失敗しました: ' + error);
      })
      .updateRentalPeriod(rentalId, startDate, endDate);
  } else {
    // モック処理
    showUpdateMessage(`貸出期間を更新中...`);
    
    // 処理をシミュレート
    setTimeout(() => {
      hideUpdateMessage();
      
      // モックデータの更新
      if (window.rentalData) {
        const rental = window.rentalData.find(r => r.id === parseInt(rentalId));
        if (rental) {
          rental.startDate = startDate;
          rental.endDate = endDate;
        }
      }
      
      // 更新完了後にガントチャートを再描画
      renderDirectGantt('ganttChart');
      
      if (typeof showDebugInfo === 'function') {
        showDebugInfo('貸出期間の更新が完了しました（テストモード）');
      }
    }, 500);
  }
}

/**
 * 更新中メッセージの表示
 */
function showUpdateMessage(message) {
  // すでに存在する場合は削除
  hideUpdateMessage();
  
  // メッセージ要素の作成
  const msgDiv = document.createElement('div');
  msgDiv.id = 'update-message';
  msgDiv.style.position = 'fixed';
  msgDiv.style.top = '50%';
  msgDiv.style.left = '50%';
  msgDiv.style.transform = 'translate(-50%, -50%)';
  msgDiv.style.padding = '15px 25px';
  msgDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
  msgDiv.style.color = 'white';
  msgDiv.style.borderRadius = '5px';
  msgDiv.style.zIndex = '1000';
  msgDiv.style.fontWeight = 'bold';
  msgDiv.textContent = message;
  
  document.body.appendChild(msgDiv);
}

/**
 * 更新中メッセージの非表示
 */
function hideUpdateMessage() {
  const msgDiv = document.getElementById('update-message');
  if (msgDiv) {
    msgDiv.remove();
  }
}

/**
 * サーバーから取得したタスクデータをガントチャート用に変換
 */
function prepareGanttData(tasksData) {
  const result = [];
  
  try {
    if (!tasksData || !Array.isArray(tasksData) || tasksData.length === 0) {
      console.log("変換するデータがありません");
      return result;
    }
    
    console.log("貸出データを変換します:", tasksData.length + "件");
    
    // アクティブな貸出データのみフィルタリング
    const activeRentals = tasksData.filter(rental => rental.status === 'active');
    console.log("アクティブな貸出データ:", activeRentals.length + "件");
    
    if (activeRentals.length === 0) {
      return result; // アクティブなデータがない場合は空の配列を返す
    }
    
    // 貸出データを機材IDごとにグループ化
    const equipmentGroups = {};
    
    activeRentals.forEach(rental => {
      const equipmentId = rental.equipmentId;
      
      if (!equipmentGroups[equipmentId]) {
        equipmentGroups[equipmentId] = {
          id: equipmentId,
          name: rental.equipmentName || `機材 #${equipmentId}`,
          rentals: []
        };
      }
      
      // 貸出情報を追加（日付を検証）
      const startDate = new Date(rental.startDate);
      const endDate = new Date(rental.endDate);
      
      if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
        equipmentGroups[equipmentId].rentals.push({
          id: rental.id,
          name: `${rental.site || '不明'} - ${rental.quantity || 1}台`,
          start: startDate,
          end: endDate,
          quantity: rental.quantity || 1,
          site: rental.site || '不明',
          borrower: rental.borrower || ''
        });
      } else {
        console.warn(`無効な日付のデータをスキップ: ID=${rental.id}, 開始=${rental.startDate}, 終了=${rental.endDate}`);
      }
    });
    
    // グループごとにresultに追加
    Object.values(equipmentGroups).forEach(group => {
      if (group.rentals.length > 0) {
        result.push(group);
      }
    });
    
    console.log("変換結果:", result.length + "件の機材グループ");
  } catch (error) {
    console.error("ガントデータ変換エラー:", error);
  }
  
  return result;
}

/**
 * サンプルデータの生成
 */
function generateSampleData() {
  // テスト用の日付
  const LAST_WEEK = new Date(TODAY);
  LAST_WEEK.setDate(TODAY.getDate() - 7);
  
  const NEXT_WEEK = new Date(TODAY);
  NEXT_WEEK.setDate(TODAY.getDate() + 7);
  
  const NEXT_2WEEKS = new Date(TODAY);
  NEXT_2WEEKS.setDate(TODAY.getDate() + 14);

  // シンプルなデータセット
  return [
    {
      id: 'equipment1',
      name: '4隅コロ (53)',
      rentals: [
        { id: 1, name: '2台 - 鈴研(管理者)', start: LAST_WEEK, end: new Date(LAST_WEEK.getTime() + 5 * 24 * 60 * 60 * 1000) }
      ]
    },
    {
      id: 'equipment2',
      name: '4隅コロアタッチメント (51)',
      rentals: [
        { id: 2, name: '1台 - GLP(管理者)', start: NEXT_WEEK, end: NEXT_2WEEKS }
      ]
    },
    {
      id: 'equipment3',
      name: '4隅コロアタッチメント (52)',
      rentals: [
        { id: 3, name: '2台 - GLP(管理者)', start: TODAY, end: new Date(TODAY.getTime() + 3 * 24 * 60 * 60 * 1000) }
      ]
    },
    {
      id: 'equipment4',
      name: '4隅金車 (50)',
      rentals: [
        { id: 4, name: '1台 - 鈴研(管理者)', start: new Date(LAST_WEEK.getTime() - 3 * 24 * 60 * 60 * 1000), end: new Date(LAST_WEEK.getTime() - 1 * 24 * 60 * 60 * 1000) }
      ]
    },
    {
      id: 'equipment5',
      name: '4隅金車 (82)',
      rentals: []
    }
  ];
}

// 日付をYYYY-MM-DD形式にフォーマット
function formatDate(date) {
  if (!date) return '';
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
/**
 * 貸出バーの描画機能を追加
 */
function renderRentalBars() {
  try {
    // アクティブな貸出データを抽出
    const activeRentals = window.rentalData ? window.rentalData.filter(rental => rental.status === 'active') : [];
    
    if (activeRentals.length === 0) {
      console.log('表示する貸出データがありません');
      return;
    }
    
    console.log(`アクティブな貸出: ${activeRentals.length}件を描画します`);
    
    // デバッグ情報表示
    if (typeof showDebugInfo === 'function') {
      showDebugInfo(`アクティブな貸出: ${activeRentals.length}件を描画開始`);
    }
    
    // 貸出バーを描画
    activeRentals.forEach((rental, index) => {
      try {
        // 選択機材フィルターが適用されていて、選択されていない機材の場合はスキップ
        if (window.selectedEquipmentId && rental.equipmentId !== window.selectedEquipmentId) {
          return;
        }
        
        // 日付の変換
        const startDate = new Date(rental.startDate);
        const endDate = new Date(rental.endDate);
        
        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
          console.warn(`無効な日付形式: ID=${rental.id}, 開始=${rental.startDate}, 終了=${rental.endDate}`);
          return;
        }
        
        // 該当する機材の行を検索
        const calendarRow = document.querySelector(`.calendar-row[data-equipment-id="${rental.equipmentId}"]`);
        if (!calendarRow) {
          console.warn(`機材ID: ${rental.equipmentId}の行が見つかりません`);
          return;
        }
        
        // 開始日のセルを検索
        const startCell = calendarRow.querySelector(`[data-date="${formatDate(startDate)}"]`);
        if (!startCell) {
          console.warn(`開始日のセルが見つかりません: ${formatDate(startDate)}`);
          return;
        }
        
        // 期間の計算（日数）
        const duration = Math.ceil((endDate - startDate) / (86400 * 1000)) + 1;
        
        // 貸出バーの作成
        const rentalBar = document.createElement('div');
        rentalBar.className = 'rental-bar';
        rentalBar.setAttribute('data-rental-id', rental.id);
        rentalBar.setAttribute('data-equipment-id', rental.equipmentId);
        rentalBar.setAttribute('data-start-date', formatDate(startDate));
        rentalBar.setAttribute('data-end-date', formatDate(endDate));
        
        // 色をランダムに選択
        const colors = [
          '#26a69a', // ティール
          '#2196F3', // ブルー
          '#FF9800', // オレンジ
          '#9C27B0', // パープル
          '#4CAF50'  // グリーン
        ];
        const colorIndex = index % colors.length;
        
        // バーのスタイル設定
        rentalBar.style.width = `${duration * 80 - 10}px`; // セル幅は80px
        rentalBar.style.backgroundColor = colors[colorIndex];
        
        // 貸出情報を表示
        rentalBar.innerHTML = `
          <div class="rental-title">${rental.site || '不明'} - ${rental.quantity || 1}台</div>
          <div class="rental-detail">${rental.borrower || ''}</div>
          <div class="rental-actions">
            <i class="material-icons rental-action-icon edit-rental">edit</i>
            <i class="material-icons rental-action-icon return-rental">undo</i>
          </div>
        `;
        
        // 貸出バーのクリックイベント
        rentalBar.addEventListener('click', function(e) {
          // 編集アイコンがクリックされた場合
          if (e.target.classList.contains('edit-rental')) {
            e.stopPropagation();
            if (typeof showEditRentalModal === 'function') {
              showEditRentalModal(rental);
            } else {
              console.log('貸出編集モーダル関数が見つかりません');
              alert(`貸出ID: ${rental.id} の編集`);
            }
            return;
          }
          
          // 返却アイコンがクリックされた場合
          if (e.target.classList.contains('return-rental')) {
            e.stopPropagation();
            if (typeof showReturnModal === 'function') {
              showReturnModal(rental);
            } else {
              console.log('返却モーダル関数が見つかりません');
              alert(`貸出ID: ${rental.id} の返却`);
            }
            return;
          }
          
          // 通常のクリックは貸出編集モーダルを表示
          if (typeof showEditRentalModal === 'function') {
            showEditRentalModal(rental);
          }
        });
        
        // 貸出バーをセルに追加
        startCell.appendChild(rentalBar);
        
        if (typeof showDebugInfo === 'function') {
          showDebugInfo(`貸出バー追加: ID=${rental.id}, 開始=${formatDate(startDate)}, 期間=${duration}日`);
        }
        
      } catch (error) {
        console.error(`貸出バー描画エラー: ID=${rental.id}`, error);
        if (typeof showDebugInfo === 'function') {
          showDebugInfo(`貸出バー描画エラー: ID=${rental.id}, ${error.message}`);
        }
      }
    });
    
    if (typeof showDebugInfo === 'function') {
      showDebugInfo('貸出バーの描画が完了しました');
    }
    
  } catch (error) {
    console.error('貸出バー描画処理エラー:', error);
    if (typeof showDebugInfo === 'function') {
      showDebugInfo(`貸出バー描画処理エラー: ${error.message}`);
    }
  }
}

/**
 * ガントチャート表示の初期化
 */
function initializeDirectGantt() {
  // 必要なHTMLコンテナが存在するか確認
  const container = document.getElementById('ganttChart');
  if (!container) {
    console.error('ガントチャートコンテナが見つかりません: ganttChart');
    return;
  }
  
  console.log('ガントチャート初期化');
  if (typeof showDebugInfo === 'function') {
    showDebugInfo('ガントチャート初期化開始');
  }
  
  try {
    // レンダリング開始メッセージ表示
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loadingGantt';
    loadingDiv.innerHTML = `
      <div class="loading-spinner"></div>
      <div>カレンダーを読み込み中...</div>
    `;
    container.innerHTML = '';
    container.appendChild(loadingDiv);
    
    // 機材リストと貸出データが利用可能かチェック
    if (!window.equipmentList || !window.rentalData) {
      console.error('機材リストまたは貸出データがロードされていません');
      container.innerHTML = '<div class="no-data-message">データの読み込みに失敗しました。ページを再読み込みしてください。</div>';
      return;
    }
    
    // カレンダー表示
    renderCalendar();
    
    // 貸出バーの描画
    renderRentalBars();
    
    if (typeof showDebugInfo === 'function') {
      showDebugInfo('ガントチャート初期化完了');
    }
    
  } catch (error) {
    console.error('ガントチャート初期化エラー:', error);
    container.innerHTML = `<div class="no-data-message">エラーが発生しました: ${error.message}</div>`;
    
    if (typeof showDebugInfo === 'function') {
      showDebugInfo(`ガントチャート初期化エラー: ${error.message}`);
    }
  }
}

/**
 * デバッグ情報表示のためのヘルパー関数
 */
function showDebugInfo(message) {
  const debugContainer = document.getElementById('debug-container');
  if (debugContainer && debugContainer.style.display !== 'none') {
    const debugContent = document.getElementById('debug-content');
    if (debugContent) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.textContent = `[${timestamp}] ${message}`;
      debugContent.appendChild(logEntry);
      
      // スクロールを最下部に
      debugContent.scrollTop = debugContent.scrollHeight;
    }
  }
  
  // コンソールにも出力
  console.log(message);
}
</script>